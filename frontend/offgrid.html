<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2d5a27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>DaysLeft</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a3a1a 0%, #2d5a27 100%);
            min-height: 100vh;
            color: #fff;
        }
        .app-container { max-width: 500px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { font-size: 32px; }
        .logo-text { font-size: 20px; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.1);
            border: none; color: white; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .vehicle-selector {
            background: rgba(255,255,255,0.1); border-radius: 16px; padding: 16px;
            margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;
        }
        .vehicle-info { display: flex; align-items: center; gap: 12px; }
        .vehicle-icon { font-size: 28px; }
        .vehicle-name { font-size: 18px; font-weight: 600; }
        .vehicle-details { font-size: 14px; opacity: 0.8; }
        .resources-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .resource-card {
            background: rgba(255,255,255,0.1); border-radius: 16px; padding: 16px;
            cursor: pointer; transition: transform 0.2s, background 0.2s;
        }
        .resource-card:hover { transform: scale(1.02); background: rgba(255,255,255,0.15); }
        .resource-card.warning { background: rgba(255, 193, 7, 0.2); border: 2px solid rgba(255, 193, 7, 0.5); }
        .resource-card.critical { background: rgba(220, 53, 69, 0.2); border: 2px solid rgba(220, 53, 69, 0.5); }
        .resource-card.inverted.warning { background: rgba(220, 53, 69, 0.2); border: 2px solid rgba(220, 53, 69, 0.5); }
        .resource-card.inverted.critical { background: rgba(220, 53, 69, 0.3); border: 2px solid rgba(220, 53, 69, 0.7); }
        .resource-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .resource-icon { font-size: 24px; }
        .resource-percentage { font-size: 20px; font-weight: 700; }
        .resource-name { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
        .resource-bar-bg { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .resource-bar { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .resource-bar.water { background: #3498db; }
        .resource-bar.power { background: #f39c12; }
        .resource-bar.fuel { background: #e74c3c; }
        .resource-bar.gas { background: #9b59b6; }
        .resource-bar.greywater { background: #95a5a6; }
        .resource-bar.toilet { background: #1abc9c; }
        .resource-bar.food { background: #e67e22; }
        .resource-bar.drinks { background: #3498db; }
        .resource-bar.beer { background: #f1c40f; }
        .resource-remaining { font-size: 12px; opacity: 0.9; }
        .resource-value { font-size: 11px; opacity: 0.7; }
        .autarky-dashboard {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(45, 90, 39, 0.4) 100%);
            border-radius: 16px; padding: 16px; margin-bottom: 20px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .autarky-main {
            display: flex; align-items: center; gap: 16px; margin-bottom: 12px;
        }
        .autarky-days {
            font-size: 48px; font-weight: 700; color: #4CAF50; line-height: 1;
        }
        .autarky-days.warning { color: #f39c12; }
        .autarky-days.critical { color: #e74c3c; }
        .autarky-label {
            font-size: 14px; opacity: 0.9;
        }
        .autarky-bottleneck {
            font-size: 12px; background: rgba(0,0,0,0.2); padding: 8px 12px;
            border-radius: 8px; margin-bottom: 12px;
        }
        .autarky-bottleneck-icon { margin-right: 6px; }
        .autarky-critical-list {
            display: flex; flex-direction: column; gap: 6px;
        }
        .autarky-critical-item {
            display: flex; align-items: center; gap: 8px; font-size: 12px;
            background: rgba(0,0,0,0.15); padding: 8px 12px; border-radius: 8px;
        }
        .autarky-critical-item.warning { border-left: 3px solid #f39c12; }
        .autarky-critical-item.critical { border-left: 3px solid #e74c3c; }
        .autarky-critical-days { font-weight: 600; margin-left: auto; }
        .quick-actions { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 16px; margin-bottom: 20px; }
        .quick-actions-title { font-size: 14px; opacity: 0.8; margin-bottom: 12px; }
        .quick-actions-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .quick-action-btn {
            background: rgba(255,255,255,0.1); border: none; border-radius: 10px; padding: 10px;
            color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px;
            flex: 0 0 calc(25% - 6px); transition: background 0.2s;
        }
        .quick-action-btn:hover { background: rgba(255,255,255,0.2); }
        .quick-action-btn .icon { font-size: 20px; }
        .quick-action-btn .label { font-size: 10px; text-align: center; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7);
            display: none; align-items: flex-end; justify-content: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1a3a1a; border-radius: 24px 24px 0 0; padding: 24px;
            width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 20px; cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; opacity: 0.9; }
        .form-input {
            width: 100%; padding: 12px 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px;
            background: rgba(255,255,255,0.1); color: white; font-size: 16px;
        }
        .form-input:focus { outline: none; border-color: #4CAF50; }
        .form-input::placeholder { color: rgba(255,255,255,0.5); }
        .slider-container { padding: 10px 0; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .slider-value { font-weight: 700; color: #4CAF50; }
        input[type="range"] { width: 100%; height: 8px; border-radius: 4px; background: rgba(255,255,255,0.2); -webkit-appearance: none; appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #4CAF50; cursor: pointer; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 16px 0; }
        .setup-screen { display: none; }
        .setup-screen.active { display: block; }
        .setup-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .setup-subtitle { font-size: 15px; opacity: 0.8; margin-bottom: 20px; }
        .setup-section { background: rgba(255,255,255,0.1); border-radius: 14px; padding: 16px; margin-bottom: 14px; }
        .setup-section-title { font-size: 15px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .category-toggle { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
        .category-toggle input { width: 22px; height: 22px; cursor: pointer; }
        .category-toggle-label { flex: 1; font-size: 15px; }
        .category-toggle-icon { font-size: 20px; }
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .no-vehicle { text-align: center; padding: 40px 20px; }
        .no-vehicle-icon { font-size: 64px; margin-bottom: 16px; }
        .no-vehicle-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .no-vehicle-text { opacity: 0.8; margin-bottom: 24px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { flex: 1; padding: 10px; text-align: center; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: white; cursor: pointer; font-size: 14px; }
        .tab.active { background: #4CAF50; }

        /* Animated Logo */
        .animated-logo {
            width: 120px;
            height: 50px;
            position: relative;
            overflow: hidden;
            background: #D2B48C;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .animated-logo .logo-sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 28px;
            background: #87CEEB;
        }
        .animated-logo .logo-sun {
            position: absolute;
            top: 4px;
            right: 8px;
            width: 12px;
            height: 12px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }
        .animated-logo .logo-mountains {
            position: absolute;
            bottom: 22px;
            left: 0;
            width: 100%;
            height: 15px;
        }
        .animated-logo .logo-mountain {
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 15px solid #8B7355;
        }
        .animated-logo .logo-text-inner {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 700;
            color: #000;
            white-space: nowrap;
            z-index: 0;
            letter-spacing: 0.5px;
        }
        .animated-logo .logo-truck {
            position: absolute;
            bottom: 22px;
            left: -25px;
            width: 20px;
            height: 12px;
            z-index: 10;
            animation: driveTruck 4s linear infinite;
        }
        @keyframes driveTruck {
            0% { left: -25px; }
            100% { left: 125px; }
        }
        .animated-logo .truck-cabin {
            background: #2c3e50;
            width: 14px;
            height: 8px;
            border-radius: 1px;
            position: absolute;
            bottom: 3px;
        }
        .animated-logo .truck-cargo {
            background: #34495e;
            width: 6px;
            height: 6px;
            border-radius: 1px;
            position: absolute;
            bottom: 3px;
            left: 14px;
        }
        .animated-logo .truck-window {
            background: #3498db;
            width: 5px;
            height: 4px;
            position: absolute;
            bottom: 7px;
            left: 2px;
            border-radius: 1px;
        }
        .animated-logo .truck-wheel {
            position: absolute;
            bottom: 0;
            width: 5px;
            height: 5px;
            background: #222;
            border-radius: 50%;
            border: 1px solid #555;
        }
        .animated-logo .dust {
            position: absolute;
            bottom: 0;
            width: 3px;
            height: 3px;
            background: rgba(210, 180, 140, 0.6);
            border-radius: 50%;
            animation: dustCloud 0.8s ease-out infinite;
        }
        @keyframes dustCloud {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-5px) scale(1.5); }
        }

        /* Google AdSense Demo Styles */
        .ad-container {
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .ad-container.ad-banner {
            min-height: 60px;
            padding: 12px;
        }
        .ad-container.ad-rectangle {
            min-height: 250px;
        }
        .ad-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.5;
            margin-bottom: 8px;
        }
        .ad-demo-text {
            font-size: 14px;
            opacity: 0.7;
        }
        .ad-demo-size {
            font-size: 11px;
            opacity: 0.4;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo">
                <div class="animated-logo">
                    <div class="logo-sky"></div>
                    <div class="logo-sun"></div>
                    <div class="logo-mountains">
                        <div class="logo-mountain" style="left: 10px;"></div>
                        <div class="logo-mountain" style="left: 35px; border-bottom-width: 12px; border-left-width: 12px; border-right-width: 12px;"></div>
                        <div class="logo-mountain" style="left: 60px; border-bottom-width: 10px; border-left-width: 10px; border-right-width: 10px;"></div>
                    </div>
                    <div class="logo-text-inner">DaysLeft</div>
                    <div class="logo-truck">
                        <div class="truck-cabin"></div>
                        <div class="truck-cargo"></div>
                        <div class="truck-window"></div>
                        <div class="truck-wheel" style="left: 1px;"></div>
                        <div class="truck-wheel" style="left: 8px;"></div>
                        <div class="truck-wheel" style="left: 15px;"></div>
                        <div class="dust" style="left: -3px;"></div>
                        <div class="dust" style="left: -6px; animation-delay: 0.2s;"></div>
                        <div class="dust" style="left: -9px; animation-delay: 0.4s;"></div>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="openSettingsModal()" title="Sprache">üåê</button>
                <button class="icon-btn" onclick="showSetup()" title="Fahrzeug-Setup">‚öôÔ∏è</button>
                <button class="icon-btn" onclick="logout()" title="Logout">üö™</button>
            </div>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p data-i18n="messages.loading">Lade Daten...</p>
        </div>

        <div id="loginState" style="display: none; text-align: center; padding: 40px 20px;">
            <div class="animated-logo" style="margin: 0 auto 20px; transform: scale(1.5);">
                <div class="logo-sky"></div>
                <div class="logo-sun"></div>
                <div class="logo-mountains">
                    <div class="logo-mountain" style="left: 10px;"></div>
                    <div class="logo-mountain" style="left: 35px; border-bottom-width: 12px; border-left-width: 12px; border-right-width: 12px;"></div>
                    <div class="logo-mountain" style="left: 60px; border-bottom-width: 10px; border-left-width: 10px; border-right-width: 10px;"></div>
                </div>
                <div class="logo-text-inner">DaysLeft</div>
                <div class="logo-truck">
                    <div class="truck-cabin"></div>
                    <div class="truck-cargo"></div>
                    <div class="truck-window"></div>
                    <div class="truck-wheel" style="left: 1px;"></div>
                    <div class="truck-wheel" style="left: 8px;"></div>
                    <div class="truck-wheel" style="left: 15px;"></div>
                    <div class="dust" style="left: -3px;"></div>
                    <div class="dust" style="left: -6px; animation-delay: 0.2s;"></div>
                    <div class="dust" style="left: -9px; animation-delay: 0.4s;"></div>
                </div>
            </div>
            <h1 style="font-size: 28px; margin-bottom: 8px;">DaysLeft</h1>
            <p style="opacity: 0.8; margin-bottom: 30px;" data-i18n="app.subtitle">Deine Autarkie im Blick</p>
            
            <div class="form-group">
                <input type="email" class="form-input" id="loginEmail" placeholder="E-Mail" data-i18n-placeholder="auth.email" style="text-align: center;">
            </div>
            <div class="form-group">
                <input type="password" class="form-input" id="loginPassword" placeholder="Passwort" data-i18n-placeholder="auth.password" style="text-align: center;">
            </div>
            
            <button class="btn btn-primary" onclick="doLogin()" style="margin-bottom: 10px;" data-i18n="auth.login">Einloggen</button>
            <button class="btn btn-secondary" onclick="doRegister()" data-i18n="auth.register">Neuen Account erstellen</button>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                <div style="display:flex;gap:8px;justify-content:center;">
                    <button class="btn btn-secondary" onclick="setLanguage('de')" style="padding:8px 16px;">üá©üá™ DE</button>
                    <button class="btn btn-secondary" onclick="setLanguage('en')" style="padding:8px 16px;">üá¨üáß EN</button>
                </div>
            </div>

            <!-- DEMO: Google AdSense - Banner im Login-Bereich -->
            <div class="ad-container ad-banner" id="adLoginBanner" style="margin-top: 20px;">
                <div class="ad-label">Anzeige</div>
                <div class="ad-demo-text">üì¢ Google AdSense</div>
                <div class="ad-demo-size">320x50 (Mobile Banner)</div>
            </div>
        </div>

        <div id="noVehicleState" class="no-vehicle" style="display: none;">
            <div class="no-vehicle-icon">üöê</div>
            <div class="no-vehicle-title" data-i18n="messages.noVehicleTitle">Kein Fahrzeug eingerichtet</div>
            <div class="no-vehicle-text" data-i18n="messages.noVehicleText">Richte zuerst dein Fahrzeug ein.</div>
            <button class="btn btn-primary" onclick="showSetup()" data-i18n="setup.createVehicle">Fahrzeug einrichten</button>
        </div>

        <div id="dashboardState" style="display: none;">
            <div class="vehicle-selector" onclick="showSetup()">
                <div class="vehicle-info">
                    <span class="vehicle-icon">üöê</span>
                    <div>
                        <div class="vehicle-name" id="vehicleName">Mein Fahrzeug</div>
                        <div class="vehicle-details" id="vehicleDetails">-</div>
                    </div>
                </div>
                <span>‚ñ∂</span>
            </div>

            <div class="autarky-dashboard" id="autarkyDashboard">
                <div class="autarky-main">
                    <div class="autarky-days" id="autarkyDays">--</div>
                    <div class="autarky-label">Tage<br>Autarkie</div>
                </div>
                <div class="autarky-bottleneck" id="autarkyBottleneck">
                    <span class="autarky-bottleneck-icon">‚ö†Ô∏è</span>
                    <span id="autarkyBottleneckText">Berechne...</span>
                </div>
                <div class="autarky-critical-list" id="autarkyCriticalList"></div>
            </div>

            <!-- AdSense Banner unter Dashboard -->
            <div class="ad-container ad-banner" id="adBannerDashboard">
                <div class="ad-label">Anzeige</div>
                <div class="ad-demo-text">üì¢ Google AdSense Banner</div>
                <div class="ad-demo-size">320x100 (Large Mobile Banner)</div>
            </div>

            <div class="resources-grid" id="resourcesGrid"></div>

            <!-- DEMO: Google AdSense - Banner zwischen Ressourcen und Quick Actions -->
            <div class="ad-container ad-banner" id="adBannerTop">
                <div class="ad-label">Anzeige</div>
                <div class="ad-demo-text">üì¢ Google AdSense Banner</div>
                <div class="ad-demo-size">320x50 / 320x100 (Mobile Banner)</div>
            </div>

            <div class="quick-actions">
                <div class="quick-actions-title" data-i18n="quickActions.title">Schnellaktionen</div>
                <div class="quick-actions-grid" id="quickActionsGrid"></div>
            </div>

            <!-- DEMO: Google AdSense - Rectangle Ad am Ende -->
            <div class="ad-container ad-rectangle" id="adRectangleBottom">
                <div class="ad-label">Anzeige</div>
                <div class="ad-demo-text">üì¢ Google AdSense Rectangle</div>
                <div class="ad-demo-size">300x250 (Medium Rectangle)</div>
            </div>
        </div>

        <div id="setupScreen" class="setup-screen">
            <div class="setup-title" data-i18n="setup.title">Fahrzeug einrichten</div>
            <div class="setup-subtitle" data-i18n="setup.subtitle">W√§hle deine Ressourcen und gib die Kapazit√§ten ein</div>

            <div class="tabs">
                <button class="tab active" onclick="switchSetupTab('categories')" data-i18n="setup.categories">Kategorien</button>
                <button class="tab" onclick="switchSetupTab('details')" data-i18n="setup.details">Details</button>
            </div>

            <form id="vehicleForm" onsubmit="saveVehicle(event)">
                <div id="categoriesTab">
                    <div class="input-row">
                        <div class="form-group" style="flex:2;">
                            <label class="form-label" data-i18n="setup.vehicleName">Fahrzeugname</label>
                            <input type="text" class="form-input" id="setupName" placeholder="z.B. Mein Fuso" required>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label class="form-label" data-i18n="setup.personCount">Personen</label>
                            <input type="number" class="form-input" id="setupPersonCount" placeholder="2" min="1" max="10" value="2">
                        </div>
                    </div>

                    <div class="setup-section">
                        <div class="setup-section-title" data-i18n="setup.activeResources">Aktive Ressourcen</div>
                        <div id="categoryToggles"></div>
                    </div>
                </div>

                <div id="detailsTab" style="display: none;">
                    <div id="resourceDetails"></div>
                </div>

                <!-- DEMO: Google AdSense - Banner im Setup-Screen -->
                <div class="ad-container ad-banner" id="adSetupBanner" style="margin: 20px 0;">
                    <div class="ad-label">Anzeige</div>
                    <div class="ad-demo-text">üì¢ Google AdSense Banner</div>
                    <div class="ad-demo-size">320x50 (Mobile Banner)</div>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 16px;" data-i18n="actions.save">Speichern</button>
                <button type="button" class="btn btn-secondary" style="margin-top: 10px;" onclick="cancelSetup()" data-i18n="actions.cancel">Abbrechen</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="resourceModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Ressource anpassen</span>
                <button class="modal-close" onclick="closeResourceModal()">‚úï</button>
            </div>
            <div class="slider-container">
                <div class="slider-header">
                    <span data-i18n="modal.level">F√ºllstand</span>
                    <span class="slider-value" id="modalSliderValue">50%</span>
                </div>
                <input type="range" id="modalSlider" min="0" max="100" value="50" oninput="updateSliderValue()">
            </div>
            <div class="btn-grid">
                <button class="btn btn-secondary" onclick="setLevel(0)" data-i18n="modal.empty">Leer</button>
                <button class="btn btn-secondary" onclick="setLevel(25)">25%</button>
                <button class="btn btn-secondary" onclick="setLevel(50)">50%</button>
                <button class="btn btn-secondary" onclick="setLevel(75)">75%</button>
                <button class="btn btn-secondary" onclick="setLevel(100)" data-i18n="modal.full">Voll</button>
            </div>
            <button class="btn btn-primary" onclick="saveResourceLevel()" data-i18n="actions.save">Speichern</button>
        </div>
    </div>

    <div class="modal-overlay" id="consumersModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <span class="modal-title">üîã <span data-i18n="consumers.manage">Verbraucher verwalten</span></span>
                <button class="modal-close" onclick="closeConsumersModal()">‚úï</button>
            </div>
            <div id="consumersList"></div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="setup-section-title" data-i18n="consumers.new">Neuer Verbraucher</div>
                <div class="input-row">
                    <div class="form-group" style="flex: 2;">
                        <input type="text" class="form-input" id="newConsumerName" placeholder="z.B. K√ºhlschrank">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <input type="number" class="form-input" id="newConsumerAh" placeholder="Ah/Tag" step="0.1">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addConsumer()" data-i18n="actions.add">Hinzuf√ºgen</button>
            </div>
            <div id="consumersSummary" style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="customResourcesModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <span class="modal-title">üì¶ <span data-i18n="customResources.title">Eigene Ressourcen</span></span>
                <button class="modal-close" onclick="closeCustomResourcesModal()">‚úï</button>
            </div>
            <div id="customResourcesList"></div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="setup-section-title" data-i18n="customResources.new">Neue Ressource erstellen</div>
                <div class="input-row">
                    <div class="form-group" style="flex: 0.5;">
                        <label>Icon</label>
                        <input type="text" class="form-input" id="newCustomIcon" value="üì¶" maxlength="2">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Name</label>
                        <input type="text" class="form-input" id="newCustomName" placeholder="z.B. Hundefutter">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Einheit</label>
                        <input type="text" class="form-input" id="newCustomUnit" placeholder="kg, L, St√ºck" value="St√ºck">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Kapazit√§t</label>
                        <input type="number" class="form-input" id="newCustomCapacity" placeholder="Max" step="0.1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>pro Person/Tag</label>
                        <input type="number" class="form-input" id="newCustomConsumption" placeholder="Optional" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="newCustomInverted"> Invertiert (je voller desto schlechter, z.B. M√ºll)
                    </label>
                </div>
                <button class="btn btn-primary" onclick="addCustomResource()">Ressource erstellen</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚öôÔ∏è <span data-i18n="settings.title">Einstellungen</span> <span id="premiumBadge" style="display:none;background:#f1c40f;color:#000;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:8px;">‚≠ê PREMIUM</span></span>
                <button class="modal-close" onclick="closeSettingsModal()">‚úï</button>
            </div>
            
            <div class="setup-section" id="premiumSection">
                <div class="setup-section-title">‚≠ê Premium</div>
                <div style="text-align:center;padding:12px;">Lade...</div>
            </div>
            
            <div class="setup-section">
                <div class="setup-section-title" data-i18n="settings.language">Sprache</div>
                <div style="display:flex;gap:8px;">
                    <button class="btn" id="langDe" onclick="setLanguage('de')" style="flex:1;">üá©üá™ Deutsch</button>
                    <button class="btn" id="langEn" onclick="setLanguage('en')" style="flex:1;">üá¨üáß English</button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="closeSettingsModal()" style="margin-top:16px;" data-i18n="actions.close">Schlie√üen</button>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3001/api' : '/api';

        // i18n - Mehrsprachigkeit
        let currentLang = localStorage.getItem('language') || 'de';
        let translations = {};

        async function loadTranslations() {
            try {
                const response = await fetch(`/i18n/${currentLang}.json`);
                translations = await response.json();
            } catch (e) {
                console.error('Translations load error:', e);
                translations = {};
            }
        }

        function t(key, params = {}) {
            const keys = key.split('.');
            let value = translations;
            for (const k of keys) {
                value = value?.[k];
            }
            if (typeof value !== 'string') return key;
            return value.replace(/\{(\w+)\}/g, (_, p) => params[p] ?? '');
        }

        async function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;
            await loadTranslations();
            applyTranslations();
            updateLangButtons();
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
            if (currentVehicle) updateUI();
        }

        const RESOURCE_CONFIG = {
            water: { icon: 'üíß', key: 'water', unit: 'L', color: '#3498db', capacityField: 'freshWaterCapacity', consumptionField: 'waterConsumptionPerDay', inverted: false },
            power: { icon: 'üîã', key: 'power', unit: 'Ah', color: '#f39c12', capacityField: 'batteryCapacity', consumptionField: 'powerConsumptionPerDay', inverted: false },
            fuel: { icon: '‚õΩ', key: 'fuel', unit: 'L', color: '#e74c3c', capacityField: 'fuelTankCapacity', consumptionField: 'fuelConsumption', inverted: false },
            gas: { icon: 'üî•', key: 'gas', unit: 'kg', color: '#9b59b6', capacityField: 'gasCapacity', consumptionField: 'gasConsumptionPerDay', inverted: false },
            greywater: { icon: 'üöø', key: 'greywater', unit: 'L', color: '#95a5a6', capacityField: 'greyWaterCapacity', consumptionField: null, inverted: true },
            toilet: { icon: 'üöΩ', key: 'toilet', unit: '', color: '#1abc9c', capacityField: 'toiletCapacity', consumptionField: null, inverted: true, hasType: true, types: ['ttt', 'clesana', 'chemical'] },
            food: { icon: 'üçΩÔ∏è', key: 'food', unit: 'Tage', color: '#e67e22', capacityField: 'foodCapacity', consumptionField: null, inverted: false },
            drinks: { icon: 'ü•§', key: 'drinks', unit: 'L', color: '#3498db', capacityField: 'drinksCapacity', consumptionField: null, inverted: false },
            beer: { icon: 'üç∫', key: 'beer', unit: 'Flaschen', color: '#f1c40f', capacityField: 'beerCapacity', consumptionField: 'beerConsumptionPerDay', inverted: false }
        };

        function getResourceName(key) {
            return t(`resources.${key}`) || key;
        }

        let currentVehicle = null;
        let currentLevels = null;
        let currentResourceType = null;
        let enabledResources = ['water', 'power', 'fuel', 'gas'];
        let isPremium = false;

        function getToken() { return localStorage.getItem('token'); }

        async function fetchAPI(endpoint, options = {}) {
            const token = getToken();
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers }
            });
            if (response.status === 401 || response.status === 403) { 
                localStorage.removeItem('token');
                const loginEl = document.getElementById('loginState');
                if (loginEl) {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('noVehicleState').style.display = 'none';
                    document.getElementById('dashboardState').style.display = 'none';
                    document.getElementById('setupScreen').classList.remove('active');
                    loginEl.style.display = 'block';
                }
                return null; 
            }
            return response.json();
        }

        async function init() {
            await loadTranslations();
            const token = getToken();
            if (!token) { 
                showLogin(); 
                return; 
            }
            try {
                // Premium-Status laden
                await checkPremiumStatus();
                
                const data = await fetchAPI('/resources/current');
                if (!data || !data.vehicle) { showNoVehicle(); return; }
                currentVehicle = data.vehicle;
                currentLevels = data.levels;
                enabledResources = currentVehicle.enabled_resources || ['water', 'power', 'fuel', 'gas'];
                
                // Wetterdaten f√ºr Solar laden wenn Standort vorhanden
                if (userLocation && currentVehicle.solar_power) {
                    fetchWeatherAndSolar().catch(() => {});
                }
                
                showDashboard();
                updateUI();
            } catch (error) {
                console.error('Init error:', error);
                showNoVehicle();
            }
        }

        async function checkPremiumStatus() {
            try {
                const data = await fetchAPI('/premium/status');
                isPremium = data?.isPremium || false;
                updateAdsVisibility();
                updatePremiumUI();
            } catch (e) {
                isPremium = false;
            }
        }

        function updateAdsVisibility() {
            const ads = document.querySelectorAll('.ad-container');
            ads.forEach(ad => {
                ad.style.display = isPremium ? 'none' : 'flex';
            });
        }

        function updatePremiumUI() {
            const premiumBadge = document.getElementById('premiumBadge');
            const premiumSection = document.getElementById('premiumSection');
            if (premiumBadge) premiumBadge.style.display = isPremium ? 'inline' : 'none';
            if (premiumSection) {
                premiumSection.innerHTML = isPremium 
                    ? `<div style="text-align:center;padding:16px;background:rgba(76,175,80,0.2);border-radius:12px;"><div style="font-size:24px;margin-bottom:8px;">‚≠ê</div><div style="font-weight:600;">Premium aktiv</div><div style="font-size:12px;opacity:0.7;">Keine Werbung</div><button class="btn btn-secondary" onclick="toggleDebugPremium()" style="margin-top:12px;padding:6px 12px;font-size:11px;opacity:0.6;">üêõ Debug: Premium deaktivieren</button></div>`
                    : renderPremiumOptions() + `<button class="btn btn-secondary" onclick="toggleDebugPremium()" style="margin-top:12px;padding:6px 12px;font-size:11px;opacity:0.6;">üêõ Debug: Premium aktivieren</button>`;
            }
        }

        function toggleDebugPremium() {
            isPremium = !isPremium;
            updateAdsVisibility();
            updatePremiumUI();
        }

        function renderPremiumOptions() {
            return `
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:24px;margin-bottom:8px;">üö´‚û°Ô∏è‚≠ê</div>
                    <div style="font-weight:600;">Werbefrei werden</div>
                    <div style="font-size:12px;opacity:0.7;">Unterst√ºtze die App & entferne Werbung</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <button class="btn btn-primary" onclick="purchasePremium('lifetime')" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>‚≠ê Einmalig - F√ºr immer</span>
                        <span style="font-weight:700;">9,99 ‚Ç¨</span>
                    </button>
                    <button class="btn btn-secondary" onclick="purchasePremium('yearly')" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>üìÖ J√§hrlich</span>
                        <span>4,99 ‚Ç¨/Jahr</span>
                    </button>
                    <button class="btn btn-secondary" onclick="purchasePremium('monthly')" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>üìÜ Monatlich</span>
                        <span>0,99 ‚Ç¨/Monat</span>
                    </button>
                </div>
                <div style="font-size:11px;opacity:0.5;text-align:center;margin-top:12px;">Zahlung √ºber Apple Pay / Google Pay (Demo)</div>
            `;
        }

        async function purchasePremium(type) {
            // Demo: Direkt aktivieren (sp√§ter durch echte Payment-Integration ersetzen)
            if (!confirm(`Premium ${type} f√ºr Demo aktivieren?`)) return;
            
            try {
                const result = await fetchAPI('/premium/activate', {
                    method: 'POST',
                    body: JSON.stringify({ premiumType: type, paymentId: 'demo-' + Date.now() })
                });
                
                if (result?.success) {
                    isPremium = true;
                    updateAdsVisibility();
                    updatePremiumUI();
                    alert('Premium erfolgreich aktiviert! Werbung wurde entfernt.');
                    closeSettingsModal();
                } else {
                    alert('Fehler: ' + (result?.error || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler beim Aktivieren: ' + e.message);
            }
        }

        function showLogin() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'none';
            document.getElementById('dashboardState').style.display = 'none';
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('loginState').style.display = 'block';
        }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { alert('Bitte E-Mail und Passwort eingeben'); return; }
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    init();
                } else {
                    alert(data.message || 'Login fehlgeschlagen');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login fehlgeschlagen');
            }
        }

        async function doRegister() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { alert('Bitte E-Mail und Passwort eingeben'); return; }
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email.split('@')[0], email, password })
                });
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    init();
                } else if (response.ok) {
                    alert('Registrierung erfolgreich! Bitte einloggen.');
                } else {
                    alert(data.message || 'Registrierung fehlgeschlagen');
                }
            } catch (error) {
                console.error('Register error:', error);
                alert('Registrierung fehlgeschlagen');
            }
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('loginState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'none';
            document.getElementById('dashboardState').style.display = 'none';
            document.getElementById('setupScreen').classList.remove('active');
        }

        function showNoVehicle() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'block';
            document.getElementById('dashboardState').style.display = 'none';
            document.getElementById('setupScreen').classList.remove('active');
        }

        function showDashboard() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'none';
            document.getElementById('dashboardState').style.display = 'block';
            document.getElementById('setupScreen').classList.remove('active');
        }

        function showSetup() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'none';
            document.getElementById('dashboardState').style.display = 'none';
            document.getElementById('setupScreen').classList.add('active');
            renderCategoryToggles();
            renderResourceDetails();
            if (currentVehicle) setTimeout(prefillSetup, 50);
        }

        function cancelSetup() {
            if (currentVehicle) showDashboard();
            else showNoVehicle();
        }

        function switchSetupTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('categoriesTab').style.display = tab === 'categories' ? 'block' : 'none';
            document.getElementById('detailsTab').style.display = tab === 'details' ? 'block' : 'none';
            if (tab === 'details') renderResourceDetails();
        }

        function renderCategoryToggles() {
            const container = document.getElementById('categoryToggles');
            container.innerHTML = '';
            for (const [key, config] of Object.entries(RESOURCE_CONFIG)) {
                const checked = enabledResources.includes(key) ? 'checked' : '';
                container.innerHTML += `
                    <label class="category-toggle">
                        <input type="checkbox" id="toggle_${key}" ${checked} onchange="toggleCategory('${key}')">
                        <span class="category-toggle-icon">${config.icon}</span>
                        <span class="category-toggle-label">${getResourceName(key)}</span>
                    </label>
                `;
            }
        }

        function toggleCategory(key) {
            const checked = document.getElementById(`toggle_${key}`).checked;
            if (checked && !enabledResources.includes(key)) enabledResources.push(key);
            else if (!checked) enabledResources = enabledResources.filter(r => r !== key);
            renderResourceDetails();
        }

        function renderResourceDetails() {
            const container = document.getElementById('resourceDetails');
            container.innerHTML = '';
            let resourceIndex = 0;
            for (const key of enabledResources) {
                // Ad-Banner nach der 2. Ressource (z.B. nach Batterie)
                if (resourceIndex === 2 && !isPremium) {
                    container.innerHTML += `
                        <div class="ad-container ad-banner" style="margin: 16px 0;">
                            <div class="ad-label">Anzeige</div>
                            <div class="ad-demo-text">üì¢ Google AdSense Banner</div>
                            <div class="ad-demo-size">320x100 (Large Mobile Banner)</div>
                        </div>
                    `;
                }
                resourceIndex++;
                const config = RESOURCE_CONFIG[key];
                
                if (key === 'toilet') {
                    container.innerHTML += `
                        <div class="setup-section">
                            <div class="setup-section-title">${config.icon} ${getResourceName(key)}</div>
                            <div class="form-group">
                                <label class="form-label">Toiletten-Typ</label>
                                <select class="form-input" id="setup_toiletType" onchange="updateToiletFields()">
                                    <option value="ttt">Trockentrenntoilette (TTT)</option>
                                    <option value="clesana">Clesana (Verbrennend)</option>
                                    <option value="chemical">Chemie-Toilette</option>
                                </select>
                            </div>
                            <div id="toiletTypeFields"></div>
                        </div>
                    `;
                    setTimeout(updateToiletFields, 0);
                } else if (key === 'power') {
                    container.innerHTML += `
                        <div class="setup-section">
                            <div class="setup-section-title">${config.icon} ${getResourceName(key)}</div>
                            <div class="input-row">
                                <div class="form-group">
                                    <label class="form-label">Kapazit√§t (${config.unit})</label>
                                    <input type="number" class="form-input" id="setup_${config.capacityField}" placeholder="z.B. 100" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Verbrauch/Tag (berechnet)</label>
                                    <input type="number" class="form-input" id="setup_${config.consumptionField}" placeholder="aus Verbrauchern" step="0.1" readonly style="opacity:0.7;">
                                </div>
                            </div>
                            
                            <div style="margin-top:16px;padding:12px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:8px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                    <span style="font-size:20px;">‚òÄÔ∏è</span>
                                    <label class="form-label" style="margin:0;font-weight:600;">Solar-Anlage</label>
                                </div>
                                <div class="input-row">
                                    <div class="form-group">
                                        <label class="form-label">Solar-Leistung (Wp)</label>
                                        <input type="number" class="form-input" id="setup_solarPower" placeholder="z.B. 200" step="1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ertrag/Tag (Ah)</label>
                                        <input type="number" class="form-input" id="setup_solarYield" placeholder="gesch√§tzt" readonly style="opacity:0.7;">
                                    </div>
                                </div>
                                <div style="margin-top:10px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <label class="form-label" style="margin:0;">Standort f√ºr Wetterprognose</label>
                                        <button class="btn btn-secondary" onclick="requestLocation()" style="padding:6px 12px;font-size:12px;" id="locationBtn">üìç Standort</button>
                                    </div>
                                    <div id="locationInfo" style="font-size:12px;opacity:0.7;margin-top:6px;"></div>
                                    <div id="solarForecast" style="margin-top:10px;display:none;"></div>
                                </div>
                            </div>
                            
                            <div style="margin-top:12px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                    <label class="form-label" style="margin:0;">Verbraucher</label>
                                    <span id="setupConsumersTotal" style="font-size:12px;opacity:0.7;">0 Ah/Tag</span>
                                </div>
                                <div id="setupConsumersList" style="max-height:150px;overflow-y:auto;margin-bottom:8px;"></div>
                                <div class="input-row" style="gap:8px;">
                                    <input type="text" class="form-input" id="setupNewConsumerName" placeholder="z.B. K√ºhlschrank" style="flex:2;">
                                    <input type="number" class="form-input" id="setupNewConsumerAh" placeholder="Ah/Tag" step="0.1" style="flex:1;">
                                    <button class="btn btn-secondary" onclick="addSetupConsumer()" style="padding:8px 12px;">+</button>
                                </div>
                                <div id="setupConsumersSummary" style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.3);border-radius:8px;font-size:13px;"></div>
                            </div>
                        </div>
                    `;
                    setTimeout(loadSetupConsumers, 0);
                    setTimeout(loadSolarData, 0);
                } else {
                    container.innerHTML += `
                        <div class="setup-section">
                            <div class="setup-section-title">${config.icon} ${getResourceName(key)}</div>
                            <div class="input-row">
                                <div class="form-group">
                                    <label class="form-label">Kapazit√§t (${config.unit})</label>
                                    <input type="number" class="form-input" id="setup_${config.capacityField}" placeholder="z.B. 100" step="0.1">
                                </div>
                                ${config.consumptionField ? `
                                <div class="form-group">
                                    <label class="form-label">pro Person/Tag</label>
                                    <input type="number" class="form-input" id="setup_${config.consumptionField}" placeholder="z.B. 15" step="0.1">
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }
        }

        function updateToiletFields() {
            const type = document.getElementById('setup_toiletType')?.value || 'ttt';
            const container = document.getElementById('toiletTypeFields');
            if (!container) return;
            
            if (type === 'ttt') {
                container.innerHTML = `
                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Feststoff-Tank (L)</label>
                            <input type="number" class="form-input" id="setup_tttSolidCapacity" placeholder="z.B. 10" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pipi-Tank (L)</label>
                            <input type="number" class="form-input" id="setup_tttLiquidCapacity" placeholder="z.B. 10" step="1">
                        </div>
                    </div>
                `;
            } else if (type === 'clesana') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Anzahl T√ºten</label>
                        <input type="number" class="form-input" id="setup_clesanaBagsCapacity" placeholder="z.B. 50" step="1">
                    </div>
                `;
            } else if (type === 'chemical') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Tank-Kapazit√§t (L)</label>
                        <input type="number" class="form-input" id="setup_chemicalTankCapacity" placeholder="z.B. 20" step="1">
                    </div>
                `;
            }
            
            if (currentVehicle) prefillToiletFields();
        }

        function prefillToiletFields() {
            const type = document.getElementById('setup_toiletType')?.value;
            if (type === 'ttt') {
                const solid = document.getElementById('setup_tttSolidCapacity');
                const liquid = document.getElementById('setup_tttLiquidCapacity');
                if (solid && currentVehicle.ttt_solid_capacity) solid.value = currentVehicle.ttt_solid_capacity;
                if (liquid && currentVehicle.ttt_liquid_capacity) liquid.value = currentVehicle.ttt_liquid_capacity;
            } else if (type === 'clesana') {
                const bags = document.getElementById('setup_clesanaBagsCapacity');
                if (bags && currentVehicle.clesana_bags_capacity) bags.value = currentVehicle.clesana_bags_capacity;
            } else if (type === 'chemical') {
                const tank = document.getElementById('setup_chemicalTankCapacity');
                if (tank && currentVehicle.chemical_tank_capacity) tank.value = currentVehicle.chemical_tank_capacity;
            }
        }

        function prefillSetup() {
            document.getElementById('setupName').value = currentVehicle.name || '';
            document.getElementById('setupPersonCount').value = currentVehicle.person_count || 2;
            for (const key of enabledResources) {
                const config = RESOURCE_CONFIG[key];
                const capEl = document.getElementById(`setup_${config.capacityField}`);
                const conEl = config.consumptionField ? document.getElementById(`setup_${config.consumptionField}`) : null;
                if (capEl && currentVehicle[toSnakeCase(config.capacityField)]) capEl.value = currentVehicle[toSnakeCase(config.capacityField)];
                if (conEl && currentVehicle[toSnakeCase(config.consumptionField)]) conEl.value = currentVehicle[toSnakeCase(config.consumptionField)];
            }
            if (currentVehicle.toilet_type) {
                const el = document.getElementById('setup_toiletType');
                if (el) el.value = currentVehicle.toilet_type;
            }
        }

        function toSnakeCase(str) { return str.replace(/([A-Z])/g, '_$1').toLowerCase(); }

        async function updateAutarkyDashboard() {
            if (!currentVehicle || !currentLevels) return;
            
            const resourceDays = [];
            
            // Standard-Ressourcen sammeln (nur die mit Tages-Verbrauch)
            for (const key of enabledResources) {
                const config = RESOURCE_CONFIG[key];
                if (config.inverted) continue; // Inverted resources (greywater, toilet) ausschlie√üen
                if (key === 'fuel') continue; // Fuel hat km statt Tage
                
                let days = null;
                if (key === 'toilet') {
                    const toiletType = currentVehicle.toilet_type || 'ttt';
                    if (toiletType === 'ttt') {
                        const solidDays = currentLevels.ttt_solid_days;
                        const liquidDays = currentLevels.ttt_liquid_days;
                        if (solidDays != null && liquidDays != null) {
                            days = Math.min(solidDays, liquidDays);
                        }
                    } else if (toiletType === 'clesana') {
                        days = currentLevels.clesana_days;
                    } else if (toiletType === 'chemical') {
                        days = currentLevels.chemical_days;
                    }
                    if (days != null) {
                        resourceDays.push({ key, icon: 'üöΩ', name: 'Toilette', days: parseFloat(days) });
                    }
                } else {
                    const remainField = `${key}_days_remaining`;
                    days = currentLevels[remainField];
                    if (days != null) {
                        resourceDays.push({ key, icon: config.icon, name: getResourceName(key), days: parseFloat(days) });
                    }
                }
            }
            
            // Custom Resources hinzuf√ºgen
            try {
                const customRes = await fetchAPI(`/custom-resources/${currentVehicle.id}`);
                if (customRes && customRes.length > 0) {
                    const personCount = currentVehicle.person_count || 2;
                    for (const r of customRes) {
                        if (r.is_inverted) continue;
                        const totalConsumption = r.consumption_per_day ? r.consumption_per_day * personCount : null;
                        if (totalConsumption && r.current_level) {
                            const days = r.current_level / totalConsumption;
                            resourceDays.push({ key: `custom_${r.id}`, icon: r.icon, name: r.name, days: parseFloat(days.toFixed(1)) });
                        }
                    }
                }
            } catch (e) {}
            
            // Nach Tagen sortieren (aufsteigend = kritischste zuerst)
            resourceDays.sort((a, b) => a.days - b.days);
            
            // Dashboard aktualisieren
            const daysEl = document.getElementById('autarkyDays');
            const bottleneckTextEl = document.getElementById('autarkyBottleneckText');
            const criticalListEl = document.getElementById('autarkyCriticalList');
            
            if (resourceDays.length === 0) {
                daysEl.textContent = '--';
                daysEl.className = 'autarky-days';
                bottleneckTextEl.textContent = 'Keine Verbrauchsdaten';
                criticalListEl.innerHTML = '';
                return;
            }
            
            // Minimale Tage = Bottleneck
            const minDays = resourceDays[0].days;
            const bottleneck = resourceDays[0];
            
            daysEl.textContent = Math.floor(minDays);
            daysEl.className = 'autarky-days' + (minDays < 2 ? ' critical' : minDays < 5 ? ' warning' : '');
            
            bottleneckTextEl.innerHTML = `<strong>${bottleneck.icon} ${bottleneck.name}</strong> begrenzt auf ~${bottleneck.days.toFixed(1)} Tage`;
            
            // Top 3 kritischste Ressourcen anzeigen
            const top3 = resourceDays.slice(0, 3);
            criticalListEl.innerHTML = top3.map(r => {
                const statusClass = r.days < 2 ? 'critical' : r.days < 5 ? 'warning' : '';
                return `
                    <div class="autarky-critical-item ${statusClass}">
                        <span>${r.icon}</span>
                        <span>${r.name}</span>
                        <span class="autarky-critical-days">~${r.days.toFixed(1)} Tage</span>
                    </div>
                `;
            }).join('');
        }

        async function updateUI() {
            if (!currentVehicle || !currentLevels) return;
            document.getElementById('vehicleName').textContent = currentVehicle.name || 'Mein Fahrzeug';
            
            // Z√§hle auch Custom Resources
            let customCount = 0;
            try {
                const customRes = await fetchAPI(`/custom-resources/${currentVehicle.id}`);
                customCount = customRes?.length || 0;
            } catch (e) {}
            const totalResources = enabledResources.length + customCount;
            const personCount = currentVehicle.person_count || 2;
            document.getElementById('vehicleDetails').textContent = `${personCount} Personen ‚Ä¢ ${totalResources} Ressourcen`;
            
            await updateAutarkyDashboard();
            renderResourceCards();
            renderQuickActions();
        }

        async function renderResourceCards() {
            const grid = document.getElementById('resourcesGrid');
            grid.innerHTML = '';
            for (const key of enabledResources) {
                if (key === 'toilet') {
                    renderToiletCard(grid);
                    continue;
                }
                if (key === 'power') {
                    await renderPowerCard(grid);
                    continue;
                }
                // Wasser + Grauwasser kombiniert anzeigen
                if (key === 'water' && enabledResources.includes('greywater')) {
                    renderWaterCard(grid);
                    continue;
                }
                if (key === 'greywater' && enabledResources.includes('water')) {
                    continue; // Wird schon in renderWaterCard angezeigt
                }
                const config = RESOURCE_CONFIG[key];
                const levelField = `${key}_level`;
                const pctField = `${key}_percentage`;
                const remainField = key === 'fuel' ? 'fuel_km_remaining' : `${key}_days_remaining`;
                const level = currentLevels[levelField] || 0;
                const pct = currentLevels[pctField] || 0;
                const remaining = currentLevels[remainField];
                const capacity = currentVehicle[toSnakeCase(config.capacityField)] || 0;
                let statusClass = '';
                if (config.inverted) {
                    if (pct > 80) statusClass = 'critical inverted';
                    else if (pct > 60) statusClass = 'warning inverted';
                } else {
                    if (pct < 20) statusClass = 'critical';
                    else if (pct < 40) statusClass = 'warning';
                }
                const remainingText = remaining != null ? (key === 'fuel' ? `~${remaining} km` : `~${remaining} Tage`) : '--';
                grid.innerHTML += `
                    <div class="resource-card ${statusClass}" onclick="openResourceModal('${key}')" style="position:relative;">
                        <div class="resource-header">
                            <span class="resource-icon">${config.icon}</span>
                            <span class="resource-percentage">${Math.round(pct)}%</span>
                        </div>
                        <div class="resource-name">${getResourceName(key)}</div>
                        <div class="resource-bar-bg">
                            <div class="resource-bar ${key}" style="width: ${pct}%"></div>
                        </div>
                        <div class="resource-remaining">${remainingText}</div>
                        <div class="resource-value">${Math.round(level)} / ${capacity} ${config.unit}</div>
                    </div>
                `;
            }
            
            // Custom Resources laden und anzeigen
            try {
                const customRes = await fetchAPI(`/custom-resources/${currentVehicle.id}`);
                if (customRes && customRes.length > 0) {
                    for (const r of customRes) {
                        const pct = r.current_percentage || 0;
                        let statusClass = '';
                        if (r.is_inverted) {
                            if (pct > 80) statusClass = 'critical inverted';
                            else if (pct > 60) statusClass = 'warning inverted';
                        } else {
                            if (pct < 20) statusClass = 'critical';
                            else if (pct < 40) statusClass = 'warning';
                        }
                        const customPersonCount = currentVehicle.person_count || 2;
                        const customTotalConsumption = r.consumption_per_day ? r.consumption_per_day * customPersonCount : null;
                        const daysRemaining = customTotalConsumption ? (r.current_level / customTotalConsumption).toFixed(1) : null;
                        grid.innerHTML += `
                            <div class="resource-card ${statusClass}" onclick="openCustomResourcesModal()" style="position:relative;">
                                <div class="resource-header">
                                    <span class="resource-icon">${r.icon}</span>
                                    <span class="resource-percentage">${Math.round(pct)}%</span>
                                </div>
                                <div class="resource-name">${r.name}</div>
                                <div class="resource-bar-bg">
                                    <div class="resource-bar" style="width: ${pct}%; background: #9b59b6;"></div>
                                </div>
                                <div class="resource-remaining">${daysRemaining ? `~${daysRemaining} Tage` : '--'}</div>
                                <div class="resource-value">${Math.round(r.current_level || 0)} / ${r.capacity} ${r.unit}</div>
                            </div>
                        `;
                    }
                }
            } catch (e) { /* Custom resources not loaded */ }
            
            // Button zum Hinzuf√ºgen neuer Custom Resources
            grid.innerHTML += `
                <div class="resource-card" onclick="openCustomResourcesModal()" style="display:flex;align-items:center;justify-content:center;border:2px dashed rgba(255,255,255,0.3);background:transparent;cursor:pointer;">
                    <div style="text-align:center;">
                        <div style="font-size:32px;opacity:0.5;">‚ûï</div>
                        <div style="font-size:12px;opacity:0.7;">Eigene Ressource</div>
                    </div>
                </div>
            `;
        }

        async function renderPowerCard(grid) {
            const config = RESOURCE_CONFIG.power;
            const level = currentLevels.power_level || 0;
            const pct = currentLevels.power_percentage || 0;
            const remaining = currentLevels.power_days_remaining;
            const capacity = currentVehicle.battery_capacity || 0;
            let statusClass = pct < 20 ? 'critical' : pct < 40 ? 'warning' : '';
            const remainingText = remaining != null ? `~${remaining} Tage` : '--';
            
            // Verbraucher laden
            let consumersHtml = '';
            let totalConsumption = 0;
            try {
                const data = await fetchAPI(`/consumers/${currentVehicle.id}`);
                const consumersList = data?.consumers || [];
                const activeConsumers = consumersList.filter(c => c.is_active);
                totalConsumption = activeConsumers.reduce((sum, c) => sum + parseFloat(c.consumption_ah || 0), 0);
                
                if (consumersList.length > 0) {
                    consumersHtml = `
                        <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.1);padding-top:8px;">
                            <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px;">
                                <span style="opacity:0.7;">‚ö° Verbrauch</span>
                                <span style="color:#e74c3c;">-${totalConsumption.toFixed(1)} Ah/Tag</span>
                            </div>
                            <div style="max-height:60px;overflow-y:auto;font-size:11px;">
                                ${consumersList.slice(0, 3).map(c => `
                                    <div style="display:flex;align-items:center;gap:4px;padding:2px 0;opacity:${c.is_active ? 1 : 0.5};">
                                        <span>${c.is_active ? '‚úÖ' : '‚¨ú'}</span>
                                        <span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</span>
                                        <span>${c.consumption_ah} Ah</span>
                                    </div>
                                `).join('')}
                                ${consumersList.length > 3 ? `<div style="opacity:0.5;text-align:center;">+${consumersList.length - 3} weitere</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            } catch (e) { /* Verbraucher nicht geladen */ }
            
            // Solar-Ertrag berechnen
            let solarHtml = '';
            const solarWp = currentVehicle.solar_power || 0;
            if (solarWp > 0) {
                let estimatedSolarAh = 0;
                let solarStatus = '‚òÄÔ∏è';
                
                if (userLocation && weatherData?.daily) {
                    const sunshineHours = (weatherData.daily.sunshine_duration?.[0] || 0) / 3600;
                    const efficiency = 0.7;
                    const voltage = 12;
                    estimatedSolarAh = (solarWp * sunshineHours * efficiency * 0.15) / voltage;
                    const code = weatherData.daily.weathercode?.[0] || 0;
                    if (code >= 61) solarStatus = 'üåßÔ∏è';
                    else if (code >= 45) solarStatus = 'üå´Ô∏è';
                    else if (code >= 3) solarStatus = '‚òÅÔ∏è';
                    else if (code >= 1) solarStatus = '‚õÖ';
                } else {
                    // Fallback ohne Wetterdaten: ~4h Sonne angenommen
                    estimatedSolarAh = (solarWp * 4 * 0.7 * 0.15) / 12;
                }
                
                const netBalance = estimatedSolarAh - totalConsumption;
                const balanceColor = netBalance >= 0 ? '#4CAF50' : '#e74c3c';
                const balanceSign = netBalance >= 0 ? '+' : '';
                
                solarHtml = `
                    <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.1);padding-top:8px;">
                        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px;">
                            <span style="opacity:0.7;">${solarStatus} Solar (${solarWp}Wp)</span>
                            <span style="color:#4CAF50;">+${estimatedSolarAh.toFixed(1)} Ah/Tag</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:12px;font-weight:600;padding:4px 8px;background:rgba(0,0,0,0.2);border-radius:4px;">
                            <span>Bilanz</span>
                            <span style="color:${balanceColor};">${balanceSign}${netBalance.toFixed(1)} Ah/Tag</span>
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML += `
                <div class="resource-card ${statusClass}" onclick="openResourceModal('power')" style="position:relative;">
                    <div class="resource-header">
                        <span class="resource-icon">${config.icon}</span>
                        <span class="resource-percentage">${Math.round(pct)}%</span>
                        <button class="icon-btn" onclick="event.stopPropagation(); openConsumersModal();" style="font-size:14px;margin-left:8px;">‚öôÔ∏è</button>
                    </div>
                    <div class="resource-name">${getResourceName('power')}</div>
                    <div class="resource-bar-bg">
                        <div class="resource-bar power" style="width: ${pct}%"></div>
                    </div>
                    <div class="resource-remaining">${remainingText}</div>
                    <div class="resource-value">${Math.round(level)} / ${capacity} ${config.unit}</div>
                    ${consumersHtml}
                    ${solarHtml}
                </div>
            `;
        }

        function renderWaterCard(grid) {
            // Frischwasser
            const waterLevel = currentLevels.water_level || 0;
            const waterPct = currentLevels.water_percentage || 0;
            const waterDays = currentLevels.water_days_remaining;
            const waterCap = currentVehicle.fresh_water_capacity || 0;
            
            // Grauwasser
            const greyLevel = currentLevels.greywater_level || 0;
            const greyPct = currentLevels.greywater_percentage || 0;
            const greyCap = currentVehicle.grey_water_capacity || 0;
            
            // Status f√ºr Frischwasser (normal)
            let waterStatus = waterPct < 20 ? 'critical' : waterPct < 40 ? 'warning' : '';
            // Status f√ºr Grauwasser (inverted - voll = schlecht)
            let greyStatus = greyPct > 80 ? 'critical' : greyPct > 60 ? 'warning' : '';
            
            grid.innerHTML += `
                <div class="resource-card" style="position:relative;">
                    <div class="resource-header">
                        <span class="resource-icon">üíß</span>
                        <span class="resource-name" style="flex:1;">Wasser</span>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <div style="flex:1;text-align:center;" onclick="openResourceModal('water')">
                            <div style="font-size:11px;opacity:0.7;">Frisch</div>
                            <div style="font-size:18px;font-weight:700;color:${waterStatus === 'critical' ? '#e74c3c' : waterStatus === 'warning' ? '#f39c12' : '#fff'};">${Math.round(waterPct)}%</div>
                            <div class="resource-bar-bg"><div class="resource-bar water" style="width:${waterPct}%"></div></div>
                            <div style="font-size:10px;opacity:0.7;margin-top:4px;">${waterDays != null ? `~${waterDays}d` : '--'}</div>
                            <div style="font-size:9px;opacity:0.5;">${Math.round(waterLevel)}/${waterCap}L</div>
                        </div>
                        <div style="flex:1;text-align:center;" onclick="openResourceModal('greywater')">
                            <div style="font-size:11px;opacity:0.7;">Grau</div>
                            <div style="font-size:18px;font-weight:700;color:${greyStatus === 'critical' ? '#e74c3c' : greyStatus === 'warning' ? '#f39c12' : '#fff'};">${Math.round(greyPct)}%</div>
                            <div class="resource-bar-bg"><div class="resource-bar greywater" style="width:${greyPct}%"></div></div>
                            <div style="font-size:10px;opacity:0.7;margin-top:4px;">${greyPct > 80 ? '‚ö†Ô∏è Voll' : greyPct > 60 ? 'üî∂ Bald' : '‚úì'}</div>
                            <div style="font-size:9px;opacity:0.5;">${Math.round(greyLevel)}/${greyCap}L</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderToiletCard(grid) {
            const toiletType = currentVehicle.toilet_type || 'ttt';
            
            if (toiletType === 'ttt') {
                const solidCap = currentVehicle.ttt_solid_capacity || 10;
                const liquidCap = currentVehicle.ttt_liquid_capacity || 10;
                const solidPct = currentLevels.ttt_solid_percentage || 0;
                const liquidPct = currentLevels.ttt_liquid_percentage || 0;
                const solidDays = currentLevels.ttt_solid_days ?? '--';
                const liquidDays = currentLevels.ttt_liquid_days ?? '--';
                grid.innerHTML += `
                    <div class="resource-card inverted" style="position:relative;">
                        <div class="resource-header">
                            <span class="resource-icon">üöΩ</span>
                            <span class="resource-percentage">TTT</span>
                        </div>
                        <div class="resource-name">Trockentrenn</div>
                        <div style="display:flex;gap:8px;margin:8px 0;">
                            <div style="flex:1;text-align:center;">
                                <div style="font-size:11px;opacity:0.7;">Feststoff ~${solidDays}d</div>
                                <div class="resource-bar-bg"><div class="resource-bar toilet" style="width:${solidPct}%"></div></div>
                                <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;margin-top:4px;" onclick="toiletUse('solid')">üí© Benutzt</button>
                            </div>
                            <div style="flex:1;text-align:center;">
                                <div style="font-size:11px;opacity:0.7;">Urin ~${liquidDays}d</div>
                                <div class="resource-bar-bg"><div class="resource-bar toilet" style="width:${liquidPct}%"></div></div>
                                <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;margin-top:4px;" onclick="toiletUse('liquid')">üíß Benutzt</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (toiletType === 'clesana') {
                const bagsCap = currentVehicle.clesana_bags_capacity || 50;
                const bagsRemaining = currentLevels.clesana_bags_remaining ?? bagsCap;
                const pct = Math.round((bagsRemaining / bagsCap) * 100);
                const days = currentLevels.clesana_days ?? '--';
                grid.innerHTML += `
                    <div class="resource-card ${pct < 20 ? 'critical' : pct < 40 ? 'warning' : ''}" style="position:relative;">
                        <div class="resource-header">
                            <span class="resource-icon">üöΩ</span>
                            <span class="resource-percentage">${bagsRemaining}</span>
                        </div>
                        <div class="resource-name">Clesana</div>
                        <div class="resource-bar-bg">
                            <div class="resource-bar toilet" style="width:${pct}%"></div>
                        </div>
                        <div class="resource-remaining">~${days} Tage</div>
                        <div class="resource-value">${bagsRemaining} / ${bagsCap} T√ºten</div>
                        <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;margin-top:8px;width:100%;" onclick="toiletUse('clesana')">üöΩ Benutzt (-1 T√ºte)</button>
                    </div>
                `;
            } else if (toiletType === 'chemical') {
                const tankCap = currentVehicle.chemical_tank_capacity || 20;
                const pct = currentLevels.chemical_percentage || 0;
                const level = currentLevels.chemical_level || 0;
                const days = currentLevels.chemical_days ?? '--';
                grid.innerHTML += `
                    <div class="resource-card inverted ${pct > 80 ? 'critical' : pct > 60 ? 'warning' : ''}" style="position:relative;">
                        <div class="resource-header">
                            <span class="resource-icon">üöΩ</span>
                            <span class="resource-percentage">${Math.round(pct)}%</span>
                        </div>
                        <div class="resource-name">Chemie-WC</div>
                        <div class="resource-bar-bg">
                            <div class="resource-bar toilet" style="width:${pct}%"></div>
                        </div>
                        <div class="resource-remaining">~${days} Tage</div>
                        <div class="resource-value">${Math.round(level)} / ${tankCap} L</div>
                        <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;margin-top:8px;width:100%;" onclick="toiletUse('chemical')">üöΩ Benutzt</button>
                    </div>
                `;
            }
        }

        async function toiletUse(type) {
            try {
                await fetchAPI('/resources/toilet-use', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, useType: type })
                });
                const data = await fetchAPI('/resources/current');
                if (data) {
                    currentLevels = data.levels;
                    updateUI();
                }
            } catch (error) { console.error('Toilet use error:', error); }
        }

        function renderQuickActions() {
            const grid = document.getElementById('quickActionsGrid');
            grid.innerHTML = '';
            for (const key of enabledResources) {
                const config = RESOURCE_CONFIG[key];
                const action = config.inverted ? 'empty' : 'full';
                const label = config.inverted ? 'Geleert' : 'Voll';
                grid.innerHTML += `
                    <button class="quick-action-btn" onclick="quickAction('${key}', '${action}')">
                        <span class="icon">${config.icon}</span>
                        <span class="label">${label}</span>
                    </button>
                `;
            }
        }

        function openResourceModal(type) {
            currentResourceType = type;
            const config = RESOURCE_CONFIG[type];
            document.getElementById('modalTitle').textContent = `${config.icon} ${getResourceName(currentResourceType)}`;
            const pct = currentLevels[`${type}_percentage`] || 0;
            document.getElementById('modalSlider').value = pct;
            document.getElementById('modalSliderValue').textContent = `${Math.round(pct)}%`;
            document.getElementById('resourceModal').classList.add('active');
        }

        function closeResourceModal() { document.getElementById('resourceModal').classList.remove('active'); }
        function updateSliderValue() { document.getElementById('modalSliderValue').textContent = `${document.getElementById('modalSlider').value}%`; }
        function setLevel(pct) { document.getElementById('modalSlider').value = pct; updateSliderValue(); }

        async function saveResourceLevel() {
            const pct = parseInt(document.getElementById('modalSlider').value);
            const config = RESOURCE_CONFIG[currentResourceType];
            const capacity = currentVehicle[toSnakeCase(config.capacityField)] || 100;
            const amount = (pct / 100) * capacity;
            try {
                const data = await fetchAPI('/resources/log', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, resourceType: currentResourceType, action: 'set_level', amount })
                });
                currentLevels = data.levels;
                updateUI();
                closeResourceModal();
            } catch (error) { console.error('Save error:', error); }
        }

        async function quickAction(type, action) {
            try {
                const data = await fetchAPI('/resources/log', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, resourceType: type, action, amount: 0 })
                });
                currentLevels = data.levels;
                updateUI();
            } catch (error) { console.error('Quick action error:', error); }
        }

        async function saveVehicle(event) {
            event.preventDefault();
            const personCount = parseInt(document.getElementById('setupPersonCount').value) || 2;
            const vehicleData = { name: document.getElementById('setupName').value, enabledResources, isDefault: true, personCount };
            for (const key of enabledResources) {
                const config = RESOURCE_CONFIG[key];
                const capEl = document.getElementById(`setup_${config.capacityField}`);
                if (capEl && capEl.value) vehicleData[config.capacityField] = parseFloat(capEl.value);
                if (config.consumptionField) {
                    const conEl = document.getElementById(`setup_${config.consumptionField}`);
                    if (conEl && conEl.value) vehicleData[config.consumptionField] = parseFloat(conEl.value);
                }
            }
            // Solar-Leistung speichern
            const solarPowerEl = document.getElementById('setup_solarPower');
            if (solarPowerEl?.value) vehicleData.solarPower = parseInt(solarPowerEl.value);
            
            const toiletType = document.getElementById('setup_toiletType');
            if (toiletType) {
                vehicleData.toiletType = toiletType.value;
                if (toiletType.value === 'ttt') {
                    const solid = document.getElementById('setup_tttSolidCapacity');
                    const liquid = document.getElementById('setup_tttLiquidCapacity');
                    if (solid?.value) vehicleData.tttSolidCapacity = parseInt(solid.value);
                    if (liquid?.value) vehicleData.tttLiquidCapacity = parseInt(liquid.value);
                } else if (toiletType.value === 'clesana') {
                    const bags = document.getElementById('setup_clesanaBagsCapacity');
                    if (bags?.value) vehicleData.clesanaBagsCapacity = parseInt(bags.value);
                } else if (toiletType.value === 'chemical') {
                    const tank = document.getElementById('setup_chemicalTankCapacity');
                    if (tank?.value) vehicleData.chemicalTankCapacity = parseInt(tank.value);
                }
            }
            try {
                document.body.insertAdjacentHTML('beforeend', `<div id="debug" style="position:fixed;bottom:0;left:0;right:0;background:#333;color:#0f0;padding:10px;font-size:12px;z-index:9999;">Speichere: ${JSON.stringify(vehicleData).substring(0,100)}...</div>`);
                let result;
                if (currentVehicle && currentVehicle.id) {
                    result = await fetchAPI(`/vehicles/${currentVehicle.id}`, { method: 'PUT', body: JSON.stringify(vehicleData) });
                } else {
                    result = await fetchAPI('/vehicles', { method: 'POST', body: JSON.stringify(vehicleData) });
                }
                document.getElementById('debug').textContent = 'Gespeichert: ' + JSON.stringify(result);
                setTimeout(() => document.getElementById('debug')?.remove(), 3000);
                await init();
            } catch (error) { 
                document.body.insertAdjacentHTML('beforeend', `<div style="position:fixed;bottom:0;left:0;right:0;background:#900;color:#fff;padding:10px;font-size:12px;z-index:9999;">FEHLER: ${error.message}</div>`);
            }
        }

        function logout() { localStorage.removeItem('token'); window.location.href = 'index.html'; }

        let consumers = [];

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            updateLangButtons();
            updatePremiumUI();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function updateLangButtons() {
            const deBtn = document.getElementById('langDe');
            const enBtn = document.getElementById('langEn');
            if (deBtn) deBtn.className = currentLang === 'de' ? 'btn btn-primary' : 'btn btn-secondary';
            if (enBtn) enBtn.className = currentLang === 'en' ? 'btn btn-primary' : 'btn btn-secondary';
        }

        async function openConsumersModal() {
            document.getElementById('consumersModal').classList.add('active');
            await loadConsumers();
        }

        function closeConsumersModal() {
            document.getElementById('consumersModal').classList.remove('active');
        }

        async function loadConsumers() {
            if (!currentVehicle) return;
            try {
                const data = await fetchAPI(`/consumers/${currentVehicle.id}`);
                if (data) {
                    consumers = data.consumers || [];
                    renderConsumers();
                    updateConsumersSummary(data);
                }
            } catch (error) { console.error('Load consumers error:', error); }
        }

        function renderConsumers() {
            const list = document.getElementById('consumersList');
            if (consumers.length === 0) {
                list.innerHTML = '<p style="opacity: 0.7; text-align: center;">Noch keine Verbraucher angelegt</p>';
                return;
            }
            list.innerHTML = consumers.map(c => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px;">
                    <span style="font-size: 24px;">${c.icon || '‚ö°'}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${c.name}</div>
                        <div style="font-size: 12px; opacity: 0.7;">${c.consumption_ah} Ah/Tag</div>
                    </div>
                    <button class="icon-btn" onclick="toggleConsumer(${c.id})" style="opacity: ${c.is_active ? 1 : 0.4};">${c.is_active ? '‚úÖ' : '‚¨ú'}</button>
                    <button class="icon-btn" onclick="deleteConsumer(${c.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateConsumersSummary(data) {
            const summary = document.getElementById('consumersSummary');
            const batteryCapacity = currentVehicle.battery_capacity || 100;
            const daysRemaining = data.totalConsumption > 0 ? (batteryCapacity / data.totalConsumption).toFixed(1) : '‚àû';
            summary.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Aktive Verbraucher:</span>
                    <strong>${data.activeCount}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Gesamtverbrauch:</span>
                    <strong>${data.totalConsumption.toFixed(1)} Ah/Tag</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Reichweite bei 100%:</span>
                    <strong>${daysRemaining} Tage</strong>
                </div>
            `;
        }

        async function addConsumer() {
            const name = document.getElementById('newConsumerName').value.trim();
            const ah = parseFloat(document.getElementById('newConsumerAh').value);
            if (!name || !ah) { alert('Bitte Name und Verbrauch eingeben'); return; }
            try {
                await fetchAPI('/consumers', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, name, consumptionAh: ah })
                });
                document.getElementById('newConsumerName').value = '';
                document.getElementById('newConsumerAh').value = '';
                await loadConsumers();
            } catch (error) { console.error('Add consumer error:', error); }
        }

        async function toggleConsumer(id) {
            try {
                await fetchAPI(`/consumers/${id}/toggle`, { method: 'PATCH' });
                await loadConsumers();
            } catch (error) { console.error('Toggle consumer error:', error); }
        }

        async function deleteConsumer(id) {
            if (!confirm('Verbraucher wirklich l√∂schen?')) return;
            try {
                await fetchAPI(`/consumers/${id}`, { method: 'DELETE' });
                await loadConsumers();
            } catch (error) { console.error('Delete consumer error:', error); }
        }

        // ========== SOLAR & STANDORT FUNKTIONEN ==========
        let userLocation = JSON.parse(localStorage.getItem('userLocation') || 'null');
        let weatherData = null;

        function loadSolarData() {
            const solarInput = document.getElementById('setup_solarPower');
            if (solarInput && currentVehicle?.solar_power) {
                solarInput.value = currentVehicle.solar_power;
            }
            if (userLocation) {
                updateLocationDisplay();
                fetchWeatherAndSolar();
            }
        }

        async function requestLocation() {
            const btn = document.getElementById('locationBtn');
            const info = document.getElementById('locationInfo');
            if (!navigator.geolocation) {
                if (info) info.textContent = 'Geolocation nicht unterst√ºtzt';
                return;
            }
            if (btn) btn.textContent = '‚è≥ Suche...';
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    localStorage.setItem('userLocation', JSON.stringify(userLocation));
                    updateLocationDisplay();
                    await fetchWeatherAndSolar();
                },
                (err) => {
                    if (info) info.textContent = 'Standort-Zugriff verweigert';
                    if (btn) btn.textContent = 'üìç Standort';
                },
                { enableHighAccuracy: false, timeout: 10000 }
            );
        }

        function updateLocationDisplay() {
            const btn = document.getElementById('locationBtn');
            const info = document.getElementById('locationInfo');
            if (btn) btn.textContent = '‚úÖ Standort aktiv';
            if (info && userLocation) {
                info.textContent = `üìç ${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
            }
        }

        async function fetchWeatherAndSolar() {
            if (!userLocation) return;
            const forecastEl = document.getElementById('solarForecast');
            const yieldEl = document.getElementById('setup_solarYield');
            
            try {
                // Open-Meteo API f√ºr Wetter und Sonnenstrahlung (kostenlos, kein API-Key n√∂tig)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLocation.lat}&longitude=${userLocation.lon}&daily=sunshine_duration,shortwave_radiation_sum,weathercode&timezone=auto&forecast_days=3`;
                const res = await fetch(url);
                const data = await res.json();
                weatherData = data;
                
                // Solarertrag berechnen
                const solarWp = parseFloat(document.getElementById('setup_solarPower')?.value) || currentVehicle?.solar_power || 0;
                if (solarWp > 0 && data.daily) {
                    const today = data.daily;
                    const sunshineHours = (today.sunshine_duration?.[0] || 0) / 3600; // Sekunden -> Stunden
                    const radiation = today.shortwave_radiation_sum?.[0] || 0; // kWh/m¬≤
                    
                    // Einfache Sch√§tzung: Wp * Sonnenstunden * Effizienzfaktor (0.7) / 12V = Ah
                    // Alternativ: Basierend auf Strahlungssumme
                    const efficiency = 0.7; // Panel-Effizienz, Verluste
                    const voltage = 12; // Systemspannung
                    const estimatedAh = (solarWp * sunshineHours * efficiency * 0.15) / voltage;
                    
                    if (yieldEl) yieldEl.value = estimatedAh.toFixed(1);
                    
                    // Wettercode zu Icon
                    const weatherIcons = {
                        0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
                        45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                        51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è',
                        61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
                        71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
                        80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',
                        95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
                    };
                    
                    if (forecastEl) {
                        forecastEl.style.display = 'block';
                        forecastEl.innerHTML = `
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;">
                                <div style="font-weight:600;margin-bottom:8px;">‚òÄÔ∏è Solar-Prognose</div>
                                <div style="display:flex;gap:8px;">
                                    ${today.time.slice(0, 3).map((date, i) => {
                                        const code = today.weathercode?.[i] || 0;
                                        const icon = weatherIcons[code] || 'üå§Ô∏è';
                                        const sun = ((today.sunshine_duration?.[i] || 0) / 3600).toFixed(1);
                                        const dayAh = (solarWp * parseFloat(sun) * efficiency * 0.15) / voltage;
                                        return `
                                            <div style="flex:1;text-align:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
                                                <div style="font-size:11px;opacity:0.7;">${new Date(date).toLocaleDateString('de', {weekday:'short'})}</div>
                                                <div style="font-size:24px;">${icon}</div>
                                                <div style="font-size:12px;">${sun}h ‚òÄÔ∏è</div>
                                                <div style="font-size:13px;font-weight:600;color:#f39c12;">~${dayAh.toFixed(0)} Ah</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div style="font-size:11px;opacity:0.6;margin-top:8px;text-align:center;">
                                    Basierend auf ${solarWp}Wp Solar-Anlage
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Weather fetch error:', e);
                if (forecastEl) forecastEl.innerHTML = '<div style="opacity:0.5;">Wetterdaten nicht verf√ºgbar</div>';
            }
        }

        // Solar-Input onChange -> Neu berechnen
        document.addEventListener('input', (e) => {
            if (e.target.id === 'setup_solarPower' && userLocation) {
                fetchWeatherAndSolar();
            }
        });

        let setupConsumers = [];

        async function loadSetupConsumers() {
            if (!currentVehicle) return;
            try {
                const data = await fetchAPI(`/consumers/${currentVehicle.id}`);
                if (data) {
                    setupConsumers = data.consumers || [];
                    renderSetupConsumers();
                }
            } catch (error) { console.error('Load setup consumers error:', error); }
        }

        function renderSetupConsumers() {
            const list = document.getElementById('setupConsumersList');
            const totalEl = document.getElementById('setupConsumersTotal');
            const consumptionInput = document.getElementById('setup_powerConsumptionPerDay');
            const summaryEl = document.getElementById('setupConsumersSummary');
            if (!list) return;
            if (!Array.isArray(setupConsumers)) setupConsumers = [];
            
            const activeCount = setupConsumers.filter(c => c.is_active).length;
            const total = setupConsumers.filter(c => c.is_active).reduce((sum, c) => sum + parseFloat(c.consumption_ah || 0), 0);
            const batteryCapacity = parseFloat(document.getElementById('setup_batteryCapacity')?.value) || (currentVehicle?.battery_capacity) || 100;
            const daysRemaining = total > 0 ? (batteryCapacity / total).toFixed(1) : '‚àû';
            
            if (totalEl) totalEl.textContent = `${total.toFixed(1)} Ah/Tag`;
            if (consumptionInput) consumptionInput.value = total.toFixed(2);
            
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span>Aktive Verbraucher:</span>
                        <strong>${activeCount}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span>Gesamtverbrauch:</span>
                        <strong>${total.toFixed(1)} Ah/Tag</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span>Reichweite bei 100%:</span>
                        <strong>${daysRemaining} Tage</strong>
                    </div>
                `;
            }
            
            if (setupConsumers.length === 0) {
                list.innerHTML = '<p style="opacity: 0.5; text-align: center; font-size: 12px; margin: 8px 0;">Keine Verbraucher</p>';
                return;
            }
            list.innerHTML = setupConsumers.map(c => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 4px; font-size: 13px;">
                    <button class="icon-btn" onclick="toggleSetupConsumer(${c.id})" style="font-size:12px;padding:2px;">${c.is_active ? '‚úÖ' : '‚¨ú'}</button>
                    <span style="flex: 1;">${c.name}</span>
                    <span style="opacity: 0.7;">${c.consumption_ah} Ah</span>
                    <button class="icon-btn" onclick="deleteSetupConsumer(${c.id})" style="font-size:12px;padding:2px;">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function addSetupConsumer() {
            const name = document.getElementById('setupNewConsumerName').value.trim();
            const ah = parseFloat(document.getElementById('setupNewConsumerAh').value);
            if (!name || !ah) { alert('Bitte Name und Verbrauch eingeben'); return; }
            try {
                await fetchAPI('/consumers', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, name, consumptionAh: ah })
                });
                document.getElementById('setupNewConsumerName').value = '';
                document.getElementById('setupNewConsumerAh').value = '';
                await loadSetupConsumers();
            } catch (error) { console.error('Add setup consumer error:', error); }
        }

        async function toggleSetupConsumer(id) {
            try {
                await fetchAPI(`/consumers/${id}/toggle`, { method: 'PATCH' });
                await loadSetupConsumers();
            } catch (error) { console.error('Toggle setup consumer error:', error); }
        }

        async function deleteSetupConsumer(id) {
            if (!confirm('Verbraucher l√∂schen?')) return;
            try {
                await fetchAPI(`/consumers/${id}`, { method: 'DELETE' });
                await loadSetupConsumers();
            } catch (error) { console.error('Delete setup consumer error:', error); }
        }

        let customResources = [];

        async function openCustomResourcesModal() {
            document.getElementById('customResourcesModal').classList.add('active');
            await loadCustomResources();
        }

        function closeCustomResourcesModal() {
            document.getElementById('customResourcesModal').classList.remove('active');
        }

        async function loadCustomResources() {
            if (!currentVehicle) return;
            try {
                customResources = await fetchAPI(`/custom-resources/${currentVehicle.id}`);
                renderCustomResources();
            } catch (error) { console.error('Load custom resources error:', error); }
        }

        function renderCustomResources() {
            const list = document.getElementById('customResourcesList');
            if (!customResources || customResources.length === 0) {
                list.innerHTML = '<p style="opacity: 0.7; text-align: center;">Noch keine eigenen Ressourcen angelegt</p>';
                return;
            }
            list.innerHTML = customResources.map(r => {
                const pct = r.current_percentage || 0;
                const color = r.is_inverted ? (pct > 75 ? '#e74c3c' : pct > 50 ? '#f39c12' : '#27ae60') : (pct < 25 ? '#e74c3c' : pct < 50 ? '#f39c12' : '#27ae60');
                const modalPersonCount = currentVehicle.person_count || 2;
                const modalTotalConsumption = r.consumption_per_day ? r.consumption_per_day * modalPersonCount : null;
                const daysRemaining = modalTotalConsumption ? (r.current_level / modalTotalConsumption).toFixed(1) : null;
                return `
                <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span style="font-size: 24px;">${r.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${r.name}</div>
                            <div style="font-size: 12px; opacity: 0.7;">${r.current_level || 0} / ${r.capacity} ${r.unit}${daysRemaining ? ` ‚Ä¢ ${daysRemaining} Tage` : ''}</div>
                        </div>
                        <button class="icon-btn" onclick="deleteCustomResource(${r.id})">üóëÔ∏è</button>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                        <div style="background: ${color}; height: 100%; width: ${pct}%; transition: width 0.3s;"></div>
                    </div>
                    <input type="range" min="0" max="${r.capacity}" step="0.1" value="${r.current_level || 0}" 
                        style="width: 100%; margin-top: 8px;" onchange="updateCustomResourceLevel(${r.id}, this.value)">
                </div>
            `}).join('');
        }

        async function addCustomResource() {
            const icon = document.getElementById('newCustomIcon').value || 'üì¶';
            const name = document.getElementById('newCustomName').value.trim();
            const unit = document.getElementById('newCustomUnit').value || 'St√ºck';
            const capacity = parseFloat(document.getElementById('newCustomCapacity').value);
            const consumption = parseFloat(document.getElementById('newCustomConsumption').value) || null;
            const isInverted = document.getElementById('newCustomInverted').checked;
            
            if (!name || !capacity) { alert('Bitte Name und Kapazit√§t eingeben'); return; }
            
            try {
                await fetchAPI('/custom-resources', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, name, icon, unit, capacity, consumptionPerDay: consumption, isInverted })
                });
                document.getElementById('newCustomName').value = '';
                document.getElementById('newCustomCapacity').value = '';
                document.getElementById('newCustomConsumption').value = '';
                document.getElementById('newCustomInverted').checked = false;
                await loadCustomResources();
                await init();
            } catch (error) { console.error('Add custom resource error:', error); }
        }

        async function updateCustomResourceLevel(id, level) {
            try {
                await fetchAPI(`/custom-resources/${id}/level`, {
                    method: 'PUT',
                    body: JSON.stringify({ level: parseFloat(level) })
                });
                await loadCustomResources();
            } catch (error) { console.error('Update custom resource level error:', error); }
        }

        async function deleteCustomResource(id) {
            if (!confirm('Ressource wirklich l√∂schen?')) return;
            try {
                await fetchAPI(`/custom-resources/${id}`, { method: 'DELETE' });
                await loadCustomResources();
                await init();
            } catch (error) { console.error('Delete custom resource error:', error); }
        }

        init();
    </script>
</body>
</html>
