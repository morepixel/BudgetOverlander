<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget-Radar - Budget Overlander</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üöô Budget Overlander</h1>
            <div class="user-info" id="userInfo">
                <span id="userName"></span>
                <button onclick="window.location.href='vehicles.html'" class="btn btn-secondary">üöó Fahrzeuge</button>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
                <button onclick="goHome()" class="btn btn-secondary">‚Üê Zur√ºck</button>
            </div>
        </header>

        <main>
            <h2>üí∞ Budget-Radar</h2>
            <p>Gib dein Budget ein und erhalte passende Routenvorschl√§ge</p>

            <div style="background: white; padding: 30px; border-radius: 10px; margin: 20px 0;">
                <form onsubmit="searchRoutes(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label><strong>üí∞ Budget (‚Ç¨)</strong></label>
                            <input type="number" id="budget" placeholder="300" required min="50" step="10">
                        </div>
                        <div>
                            <label><strong>üìè Radius (km)</strong></label>
                            <input type="number" id="radius" placeholder="200" required min="50" step="10">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label><strong>üìç Startpunkt (Lat,Lon)</strong></label>
                            <input type="text" id="startPoint" placeholder="48.1351,11.5820" required>
                            <small style="color: #95a5a6;">z.B. M√ºnchen: 48.1351,11.5820</small>
                        </div>
                        <div>
                            <label><strong>üóìÔ∏è Tage</strong></label>
                            <input type="number" id="days" placeholder="3" required min="1" max="14">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label><strong>üó∫Ô∏è Region</strong></label>
                        <select id="regionSelect" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="pyrenees">Pyren√§en (Frankreich/Spanien)</option>
                            <option value="sierra_nevada">Sierra Nevada (Spanien)</option>
                            <option value="alps_south">S√ºdalpen (Frankreich/Italien)</option>
                            <option value="norway_south">S√ºdnorwegen</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary btn-large" style="width: 100%;">
                        üîç Routen suchen
                    </button>
                </form>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Suche passende Routen...</p>
            </div>

            <div id="results" style="display: none;">
                <h3>üìä Ergebnisse</h3>
                <div id="resultsSummary" style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 15px 0;"></div>
                <div id="suggestions"></div>
            </div>
        </main>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        async function init() {
            if (!checkAuth()) {
                window.location.href = 'index.html';
                return;
            }
        }

        async function searchRoutes(event) {
            event.preventDefault();

            const budget = parseFloat(document.getElementById('budget').value);
            const radius = parseFloat(document.getElementById('radius').value);
            const startPoint = document.getElementById('startPoint').value;
            const days = parseInt(document.getElementById('days').value);
            const regionId = document.getElementById('regionSelect').value;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const data = await api.budgetRadar(budget, radius, startPoint, days, regionId);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                // Summary
                const summaryDiv = document.getElementById('resultsSummary');
                summaryDiv.innerHTML = `
                    <strong>${data.message}</strong><br>
                    Budget: ${data.budget}‚Ç¨ | Radius: ${data.radius}km | Tage: ${data.days}<br>
                    Verf√ºgbare Cluster: ${data.clustersAvailable}
                `;

                // Suggestions
                const suggestionsDiv = document.getElementById('suggestions');
                
                if (data.suggestions.length === 0) {
                    suggestionsDiv.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 40px;">Keine passenden Routen im Budget gefunden. Versuche ein h√∂heres Budget oder gr√∂√üeren Radius.</p>';
                    return;
                }

                suggestionsDiv.innerHTML = data.suggestions.map((suggestion, idx) => `
                    <div style="background: white; padding: 25px; margin: 20px 0; border-radius: 10px; border: 2px solid ${idx === 0 ? '#2ecc71' : '#ecf0f1'};">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="margin-bottom: 10px;">
                                    ${idx + 1}. ${suggestion.name}
                                    ${idx === 0 ? '<span style="background: #2ecc71; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">Empfohlen</span>' : ''}
                                </h3>
                                <p style="color: #95a5a6; margin-bottom: 15px;">${suggestion.description}</p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                                    <div style="background: #ecf0f1; padding: 15px; border-radius: 5px;">
                                        <strong>üìè Distanz</strong><br>
                                        ${suggestion.stats.totalDistance} km<br>
                                        <small>${suggestion.stats.offroadKm} km Offroad (${suggestion.stats.offroadPercentage}%)</small>
                                    </div>
                                    <div style="background: #ecf0f1; padding: 15px; border-radius: 5px;">
                                        <strong>‚ö° Schwierigkeit</strong><br>
                                        ${suggestion.stats.avgDifficulty}/100<br>
                                        <small>${suggestion.stats.avgDifficulty < 50 ? 'Leicht' : suggestion.stats.avgDifficulty < 70 ? 'Mittel' : 'Schwer'}</small>
                                    </div>
                                    <div style="background: #ecf0f1; padding: 15px; border-radius: 5px;">
                                        <strong>üí∞ Kosten</strong><br>
                                        ${suggestion.cost.total}‚Ç¨<br>
                                        <small>Rest: ${suggestion.cost.remaining}‚Ç¨</small>
                                    </div>
                                    <div style="background: #ecf0f1; padding: 15px; border-radius: 5px;">
                                        <strong>üóìÔ∏è Dauer</strong><br>
                                        ${suggestion.stats.days} Tage<br>
                                        <small>${suggestion.clusters.length} Cluster</small>
                                    </div>
                                </div>

                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; color: #3498db;">Kosten-Details anzeigen</summary>
                                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                        <p>‚õΩ Sprit: ${suggestion.cost.fuel}‚Ç¨</p>
                                        <p>üèïÔ∏è Camping: ${suggestion.cost.camping}‚Ç¨ (${suggestion.stats.days} N√§chte √† 15‚Ç¨)</p>
                                        <p>üçΩÔ∏è Verpflegung: ${suggestion.cost.food}‚Ç¨ (${suggestion.stats.days} Tage √† 25‚Ç¨)</p>
                                        <hr style="margin: 10px 0;">
                                        <p><strong>Gesamt: ${suggestion.cost.total}‚Ç¨</strong></p>
                                    </div>
                                </details>
                            </div>
                            <div style="margin-left: 20px;">
                                <button onclick="selectRoute('${regionId}', '${suggestion.clusters.join(',')}')" class="btn btn-primary">
                                    Route planen ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Fehler:', error);
                document.getElementById('loading').style.display = 'none';
                alert('Fehler bei der Suche: ' + error.message);
            }
        }

        function selectRoute(regionId, clusterIds) {
            window.location.href = `app.html?region=${regionId}&clusters=${clusterIds}`;
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        init();
    </script>
</body>
</html>
