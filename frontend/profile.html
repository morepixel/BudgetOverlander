<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - TrailQuest Offgrid</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üöô TrailQuest Offgrid</h1>
            <div class="user-info" id="userInfo">
                <span id="userName"></span>
                <button onclick="window.location.href='vehicles.html'" class="btn btn-secondary">üöó Fahrzeuge</button>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
                <button onclick="goHome()" class="btn btn-secondary">‚Üê Zur√ºck</button>
            </div>
        </header>

        <main>
            <h2>üë§ Profil</h2>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Lade Profil...</p>
            </div>

            <div id="profileContent" style="display: none;">
                <!-- XP & Level -->
                <div style="background: white; padding: 30px; border-radius: 10px; margin: 20px 0;">
                    <h3>‚≠ê Level & XP</h3>
                    <div style="display: flex; align-items: center; gap: 20px; margin: 20px 0;">
                        <div style="font-size: 48px; font-weight: bold; color: #3498db;">
                            <span id="userLevel">1</span>
                        </div>
                        <div style="flex: 1;">
                            <p style="margin: 0;"><strong>XP:</strong> <span id="userXP">0</span></p>
                            <div style="background: #ecf0f1; height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden;">
                                <div id="xpBar" style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: 0%; transition: width 0.5s;"></div>
                            </div>
                            <p style="margin: 0; font-size: 0.9em; color: #7f8c8d;">
                                <span id="xpProgress">0</span> / <span id="xpNeeded">100</span> XP bis Level <span id="nextLevel">2</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div style="background: white; padding: 30px; border-radius: 10px; margin: 20px 0;">
                    <h3>üìä Statistiken</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="background: #ecf0f1; padding: 20px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #3498db;" id="totalDistance">0</div>
                            <div style="color: #7f8c8d; margin-top: 5px;">Gesamt km</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 20px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #e67e22;" id="offroadDistance">0</div>
                            <div style="color: #7f8c8d; margin-top: 5px;">Offroad km</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 20px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #9b59b6;" id="totalElevation">0</div>
                            <div style="color: #7f8c8d; margin-top: 5px;">H√∂henmeter</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 20px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #2ecc71;" id="questsCompleted">0</div>
                            <div style="color: #7f8c8d; margin-top: 5px;">Quests</div>
                        </div>
                        <div style="background: #ecf0f1; padding: 20px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 32px; font-weight: bold; color: #f39c12;" id="badgeCount">0</div>
                            <div style="color: #7f8c8d; margin-top: 5px;">Badges</div>
                        </div>
                    </div>
                </div>

                <!-- Badges -->
                <div style="background: white; padding: 30px; border-radius: 10px; margin: 20px 0;">
                    <h3>üèÜ Badges</h3>
                    <div id="badgesList" style="margin-top: 20px;"></div>
                </div>

                <!-- Quest Progress -->
                <div style="background: white; padding: 30px; border-radius: 10px; margin: 20px 0;">
                    <h3>üéØ Quest-Fortschritt</h3>
                    <div id="questProgress" style="margin-top: 20px;"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/api.js?v=3"></script>
    <script src="js/auth.js?v=2"></script>
    <script>
        async function init() {
            if (!checkAuth()) {
                window.location.href = 'index.html';
                return;
            }

            await loadProfile();
        }

        async function loadProfile() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                // Load profile data
                const profile = await api.getProfile();
                const badgeProgress = await api.getBadgeProgress();
                const questProgress = await api.getQuestProgress();
                
                // Update XP & Level
                document.getElementById('userLevel').textContent = profile.user.level;
                document.getElementById('userXP').textContent = profile.user.xp;
                document.getElementById('xpProgress').textContent = profile.user.xp_progress;
                document.getElementById('xpNeeded').textContent = profile.user.xp_needed;
                document.getElementById('nextLevel').textContent = profile.user.level + 1;
                document.getElementById('xpBar').style.width = profile.user.xp_percent + '%';
                
                // Update stats
                document.getElementById('totalDistance').textContent = Math.round(profile.stats.total_distance_km);
                document.getElementById('offroadDistance').textContent = Math.round(profile.stats.total_offroad_km);
                document.getElementById('totalElevation').textContent = profile.stats.total_elevation_m;
                document.getElementById('questsCompleted').textContent = profile.stats.total_quests_completed;
                document.getElementById('badgeCount').textContent = profile.stats.badge_count;
                
                // Display badges
                const badgesDiv = document.getElementById('badgesList');
                if (badgeProgress.badges.length === 0) {
                    badgesDiv.innerHTML = '<p style="text-align: center; color: #95a5a6;">Noch keine Badges freigeschaltet</p>';
                } else {
                    badgesDiv.innerHTML = badgeProgress.badges.map(badge => `
                        <div style="background: ${badge.earned ? '#ecf0f1' : '#f8f9fa'}; padding: 20px; margin: 10px 0; border-radius: 5px; border-left: 5px solid ${badge.earned ? '#2ecc71' : '#bdc3c7'};">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 32px;">${badge.icon}</div>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 5px 0;">${badge.name} ${badge.earned ? '‚úÖ' : ''}</h4>
                                    <p style="margin: 0; color: #7f8c8d; font-size: 0.9em;">${badge.description}</p>
                                    ${!badge.earned ? `
                                        <div style="margin-top: 10px;">
                                            <div style="background: #ecf0f1; height: 10px; border-radius: 5px; overflow: hidden;">
                                                <div style="background: #3498db; height: 100%; width: ${badge.progress_percent}%;"></div>
                                            </div>
                                            <p style="margin: 5px 0 0 0; font-size: 0.8em; color: #7f8c8d;">
                                                ${badge.current_value} / ${badge.requirement_value} (${badge.progress_percent}%)
                                            </p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Display quest progress
                const questDiv = document.getElementById('questProgress');
                if (questProgress.progress.length === 0) {
                    questDiv.innerHTML = '<p style="text-align: center; color: #95a5a6;">Noch keine Quests gestartet</p>';
                } else {
                    const completed = questProgress.progress.filter(q => q.status === 'completed');
                    const inProgress = questProgress.progress.filter(q => q.status === 'in_progress');
                    
                    questDiv.innerHTML = `
                        <p><strong>Abgeschlossen:</strong> ${completed.length} | <strong>In Arbeit:</strong> ${inProgress.length}</p>
                        ${questProgress.progress.slice(0, 10).map(quest => `
                            <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${quest.name}</strong>
                                        <span style="margin-left: 10px; padding: 3px 8px; background: ${quest.status === 'completed' ? '#2ecc71' : '#f39c12'}; color: white; border-radius: 3px; font-size: 0.8em;">
                                            ${quest.status === 'completed' ? '‚úÖ Abgeschlossen' : 'üîÑ In Arbeit'}
                                        </span>
                                    </div>
                                    <div style="color: #3498db; font-weight: bold;">+${quest.reward_xp} XP</div>
                                </div>
                                ${quest.completed_at ? `<p style="margin: 5px 0 0 0; font-size: 0.8em; color: #7f8c8d;">Abgeschlossen: ${new Date(quest.completed_at).toLocaleDateString('de-DE')}</p>` : ''}
                            </div>
                        `).join('')}
                    `;
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('profileContent').style.display = 'block';
                
            } catch (error) {
                console.error('Profil-Fehler:', error);
                alert('Fehler beim Laden des Profils: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        init();
    </script>
</body>
</html>
