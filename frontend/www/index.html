<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2E7D32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>DaysLeft</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html {
            height: 100%;
            background: #2E7D32;
            overscroll-behavior-y: none;
            overflow: hidden;
        }
        body {
            height: 100%;
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            background-attachment: fixed;
            overscroll-behavior-y: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #fff;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .app-container { 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 20px;
            padding-top: calc(env(safe-area-inset-top, 0px) + 20px);
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) - 180px);
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            max-width: 500px;
            margin: 0 auto;
            padding: calc(env(safe-area-inset-top, 0px) - 22px) 20px 8px 20px;
            position: fixed;
            height: 50px;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background:29752D;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { font-size: 32px; }
        .logo-text { font-size: 20px; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; }
        .icon-btn {
            width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.1);
            border: none; color: white; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .vehicle-selector {
            background: rgba(255,255,255,0.1); border-radius: 16px; padding: 16px;
            margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer;
        }
        .vehicle-info { display: flex; align-items: center; gap: 12px; }
        .vehicle-icon { font-size: 28px; }
        .vehicle-name { font-size: 18px; font-weight: 600; }
        .vehicle-details { font-size: 14px; opacity: 0.8; }
        .resources-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); grid-auto-rows: auto; gap: 12px; margin-bottom: 20px; }
        .resource-card.span-2 { grid-row: span 2; }
        .resource-card {
            background: rgba(255,255,255,0.1); border-radius: 16px; padding: 16px;
            cursor: pointer; transition: transform 0.2s, background 0.2s;
            min-width: 0; overflow: hidden;
        }
        .resource-card:hover { transform: scale(1.02); background: rgba(255,255,255,0.15); }
        /* iOS-Style Edit Mode */
        @keyframes wiggle {
            0%, 100% { transform: rotate(-1deg); }
            50% { transform: rotate(1deg); }
        }
        .edit-mode .resource-card {
            animation: wiggle 0.15s ease-in-out infinite;
            cursor: grab;
        }
        .edit-mode .resource-card:active { cursor: grabbing; }
        .edit-mode .resource-card.dragging {
            opacity: 0.5;
            animation: none;
            transform: scale(1.05);
        }
        .edit-mode .resource-card .drag-handle {
            position: absolute; top: 8px; right: 8px;
            background: rgba(0,0,0,0.3); border-radius: 50%;
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }
        .edit-mode-btn {
            position: fixed; bottom: calc(env(safe-area-inset-bottom, 0px) + 75px); right: 16px;
            background: rgba(76,175,80,0.9); border: none; border-radius: 50%;
            width: 50px; height: 50px; font-size: 20px;
            cursor: pointer; z-index: 1001; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .edit-mode-btn.active { background: rgba(244,67,54,0.9); }
        .resource-card.warning { background: rgba(255, 193, 7, 0.2); border: 2px solid rgba(255, 193, 7, 0.5); }
        .resource-card.critical { background: rgba(220, 53, 69, 0.2); border: 2px solid rgba(220, 53, 69, 0.5); }
        .resource-card.inverted.warning { background: rgba(220, 53, 69, 0.2); border: 2px solid rgba(220, 53, 69, 0.5); }
        .resource-card.inverted.critical { background: rgba(220, 53, 69, 0.3); border: 2px solid rgba(220, 53, 69, 0.7); }
        .resource-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .resource-icon { font-size: 24px; }
        .resource-percentage { font-size: 20px; font-weight: 700; }
        .resource-name { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
        .resource-bar-bg { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .resource-bar { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .resource-bar.water { background: #3498db; }
        .resource-bar.power { background: #f39c12; }
        .resource-bar.fuel { background: #ff7b7b; }
        .resource-bar.gas { background: #9b59b6; }
        .resource-bar.greywater { background: #95a5a6; }
        .resource-bar.toilet { background: #1abc9c; }
        .resource-bar.food { background: #e67e22; }
        .resource-bar.drinks { background: #3498db; }
        .resource-bar.beer { background: #f1c40f; }
        .resource-remaining { font-size: 12px; opacity: 0.9; }
        .resource-value { font-size: 11px; opacity: 0.7; }
        .autarky-dashboard {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(45, 90, 39, 0.4) 100%);
            border-radius: 16px; padding: 16px; margin-bottom: 20px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .autarky-main {
            display: flex; align-items: center; gap: 16px; margin-bottom: 12px;
        }
        .autarky-days {
            font-size: 48px; font-weight: 700; color: #4CAF50; line-height: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            background: rgba(0,0,0,0.2);
            padding: 8px 16px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        .autarky-days.warning { color: #f39c12; }
        .autarky-days.critical { color: #ff7b7b; }
        .autarky-label {
            font-size: 14px; opacity: 0.9;
        }
        .autarky-bottleneck {
            font-size: 12px; background: rgba(0,0,0,0.2); padding: 8px 12px;
            border-radius: 8px; margin-bottom: 12px;
        }
        .autarky-bottleneck-icon { margin-right: 6px; }
        .autarky-critical-list {
            display: flex; flex-direction: column; gap: 6px;
        }
        .autarky-critical-item {
            display: flex; align-items: center; gap: 8px; font-size: 12px;
            background: rgba(0,0,0,0.15); padding: 8px 12px; border-radius: 8px;
        }
        .autarky-critical-item.warning { border-left: 3px solid #f39c12; }
        .autarky-critical-item.critical { border-left: 3px solid #ff7b7b; }
        .autarky-critical-days { font-weight: 600; margin-left: auto; }
        .quick-actions { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 16px; margin-bottom: 20px; }
        .quick-actions-title { font-size: 14px; opacity: 0.8; margin-bottom: 12px; }
        .quick-actions-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .quick-action-btn {
            background: rgba(255,255,255,0.1); border: none; border-radius: 10px; padding: 10px;
            color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px;
            flex: 0 0 calc(25% - 6px); transition: background 0.2s;
        }
        .quick-action-btn:hover { background: rgba(255,255,255,0.2); }
        .quick-action-btn .icon { font-size: 20px; }
        .quick-action-btn .label { font-size: 10px; text-align: center; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7);
            display: none; align-items: flex-end; justify-content: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1a3a1a; border-radius: 24px 24px 0 0; padding: 24px;
            width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 20px; cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 6px; opacity: 0.9; }
        .form-input {
            width: 100%; padding: 12px 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px;
            background: rgba(255,255,255,0.1); color: white; font-size: 16px;
        }
        .form-input:focus { outline: none; border-color: #4CAF50; }
        .form-input::placeholder { color: rgba(255,255,255,0.5); }
        .slider-container { padding: 10px 0; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .slider-value { font-weight: 700; color: #4CAF50; }
        input[type="range"] { width: 100%; height: 8px; border-radius: 4px; background: rgba(255,255,255,0.2); -webkit-appearance: none; appearance: none; margin: 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; cursor: pointer; margin-top: -6px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        input[type="range"]::-webkit-slider-runnable-track { height: 8px; border-radius: 4px; background: rgba(255,255,255,0.2); }
        .custom-res-slider input[type="range"]::-webkit-slider-runnable-track { background: transparent; }
        .custom-res-slider input[type="range"]::-moz-range-track { background: transparent; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        input[type="range"]::-moz-range-track { height: 8px; border-radius: 4px; background: rgba(255,255,255,0.2); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 16px 0; }
        .setup-screen { display: none; }
        .setup-screen.active { display: block; }
        .setup-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .setup-subtitle { font-size: 15px; opacity: 0.8; margin-bottom: 20px; }
        .setup-section { background: rgba(255,255,255,0.1); border-radius: 14px; padding: 16px; margin-bottom: 14px; }
        .setup-section-title { font-size: 15px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .category-toggle { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
        .category-toggle input { width: 22px; height: 22px; cursor: pointer; }
        .category-toggle-label { flex: 1; font-size: 15px; }
        .category-toggle-icon { font-size: 20px; }
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .no-vehicle { text-align: center; padding: 40px 20px; min-height: calc(100vh - 100px); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .no-vehicle-icon { font-size: 64px; margin-bottom: 16px; }
        .no-vehicle-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .no-vehicle-text { opacity: 0.8; margin-bottom: 24px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { flex: 1; padding: 10px; text-align: center; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: white; cursor: pointer; font-size: 14px; }
        .tab.active { background: #4CAF50; }

        /* POI Pill Buttons */
        .poi-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px 6px 6px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .poi-pill.active {
            background: rgba(255,255,255,0.25);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .poi-pill:not(.active) {
            opacity: 0.4;
        }
        .poi-pill-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .poi-pill-count {
            font-size: 12px;
            font-weight: 600;
            color: white;
            min-width: 16px;
        }
        
        /* POI Marker Styles */
        .poi-marker-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            border: 2px solid white;
        }

        /* Animated Logo */
        .animated-logo {
            width: 120px;
            height: 50px;
            position: relative;
            overflow: hidden;
            background: #D2B48C;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .animated-logo .logo-sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 28px;
            background: #87CEEB;
        }
        .animated-logo .logo-sun {
            position: absolute;
            top: 4px;
            right: 8px;
            width: 12px;
            height: 12px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }
        .animated-logo .logo-mountains {
            position: absolute;
            bottom: 22px;
            left: 0;
            width: 100%;
            height: 15px;
        }
        .animated-logo .logo-mountain {
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 15px solid #8B7355;
        }
        .animated-logo .logo-text-inner {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 700;
            color: #000;
            white-space: nowrap;
            z-index: 0;
            letter-spacing: 0.5px;
        }
        .animated-logo .logo-truck {
            position: absolute;
            bottom: 22px;
            left: -25px;
            width: 20px;
            height: 12px;
            z-index: 10;
            animation: driveTruck 4s linear infinite;
        }
        @keyframes driveTruck {
            0% { left: -25px; }
            100% { left: 125px; }
        }
        .animated-logo .truck-cabin {
            background: #4CAF50;
            width: 14px;
            height: 8px;
            border-radius: 1px;
            position: absolute;
            bottom: 3px;
        }
        .animated-logo .truck-cargo {
            background: #2E7D32;
            width: 6px;
            height: 6px;
            border-radius: 1px;
            position: absolute;
            bottom: 3px;
            left: 14px;
        }
        .animated-logo .truck-window {
            background: #81C784;
            width: 5px;
            height: 4px;
            position: absolute;
            bottom: 7px;
            left: 2px;
            border-radius: 1px;
        }
        .animated-logo .truck-wheel {
            position: absolute;
            bottom: 0;
            width: 5px;
            height: 5px;
            background: #222;
            border-radius: 50%;
            border: 1px solid #555;
        }
        .animated-logo .dust {
            position: absolute;
            bottom: 0;
            width: 3px;
            height: 3px;
            background: rgba(210, 180, 140, 0.6);
            border-radius: 50%;
            animation: dustCloud 0.8s ease-out infinite;
        }
        @keyframes dustCloud {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-5px) scale(1.5); }
        }

        /* Google AdSense Demo Styles */
        .ad-container {
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .ad-container.ad-banner {
            min-height: 60px;
            padding: 12px;
        }
        .ad-container.ad-rectangle {
            min-height: 250px;
        }
        .ad-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.5;
            margin-bottom: 8px;
        }
        .ad-demo-text {
            font-size: 14px;
            opacity: 0.7;
        }
        .ad-demo-size {
            font-size: 11px;
            opacity: 0.4;
            margin-top: 4px;
        }
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 80px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.success { border-left: 4px solid #4CAF50; }
        .toast.info { border-left: 4px solid #2196F3; }
        .toast.warning { border-left: 4px solid #FF9800; }
        .toast-icon { font-size: 18px; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 2px; }
        .toast-message { font-size: 12px; opacity: 0.8; }
        /* Pull-to-Refresh */
        .pull-refresh {
            position: fixed;
            top: calc(env(safe-area-inset-top, 0px) + 65px);
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .pull-refresh.visible {
            display: flex;
        }
        .pull-refresh .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: rgba(255,255,255,0.9);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Animated Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        .splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .splash-logo {
            width: 200px;
            height: 85px;
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: splash-pulse 2s ease-in-out infinite;
        }
        @keyframes splash-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .splash-logo .logo-sky { position: absolute; top: 0; left: 0; width: 100%; height: 48px; background: #87CEEB; }
        .splash-logo .logo-sun { position: absolute; top: 8px; right: 16px; width: 28px; height: 28px; background: #FFD700; border-radius: 50%; box-shadow: 0 0 12px rgba(255, 215, 0, 0.6); }
        .splash-logo .logo-mountains { position: absolute; bottom: 37px; left: 0; width: 100%; height: 25px; }
        .splash-logo .logo-mountain { position: absolute; bottom: 0; width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 25px solid #8B7355; }
        .splash-logo .logo-text-inner { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); background: #5D4037; color: #fff; font-size: 22px; font-weight: 700; padding: 4px 16px; border-radius: 4px; }
        .splash-logo .logo-truck { position: absolute; bottom: 37px; left: -40px; width: 35px; height: 18px; animation: splash-drive 3s linear infinite; }
        @keyframes splash-drive { 0% { left: -40px; } 100% { left: 210px; } }
        .splash-logo .truck-cabin { background: #4CAF50; width: 22px; height: 12px; border-radius: 3px 3px 0 0; position: absolute; bottom: 5px; }
        .splash-logo .truck-cargo { background: #2E7D32; width: 10px; height: 10px; position: absolute; bottom: 5px; left: 22px; }
        .splash-logo .truck-window { background: #81C784; width: 8px; height: 6px; position: absolute; top: 2px; left: 3px; border-radius: 2px; }
        .splash-logo .truck-wheel { position: absolute; bottom: 0; width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .splash-title { color: white; font-size: 18px; margin-top: 24px; opacity: 0.9; font-weight: 500; }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            background: #1B5E20;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            padding-bottom: 0;
            z-index: 9999 !important;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0 6px 0;
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            flex: 1;
            -webkit-tap-highlight-color: transparent;
        }
        .bottom-nav-item:active {
            color: #fff;
        }
        .bottom-nav-item .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bottom-nav-item .nav-icon svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }
        .bottom-nav-item .nav-label {
            font-weight: 500;
            letter-spacing: 0.2px;
        }
        .bottom-nav-item.nav-home {
            position: relative;
        }
        .bottom-nav-item.nav-home .nav-icon {
            width: 50px;
            height: 50px;
            background: #4CAF50;
            border-radius: 50%;
            margin-top: -22px;
            margin-bottom: 3px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        }
        .bottom-nav-item.nav-home .nav-icon svg {
            width: 26px;
            height: 26px;
            fill: #fff;
        }
        .bottom-nav-item.nav-home:active .nav-icon {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Pull-to-Refresh Spinner -->
    <div class="pull-refresh" id="pullRefresh">
        <div class="spinner"></div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon">üîÑ</span>
        <div class="toast-content">
            <div class="toast-title">Aktualisiert</div>
            <div class="toast-message"></div>
        </div>
    </div>

    <!-- Animated Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <div class="logo-sky"></div>
            <div class="logo-sun"></div>
            <div class="logo-mountains">
                <div class="logo-mountain" style="left: 15px;"></div>
                <div class="logo-mountain" style="left: 60px; border-bottom-width: 20px; border-left-width: 20px; border-right-width: 20px;"></div>
                <div class="logo-mountain" style="left: 105px; border-bottom-width: 18px; border-left-width: 18px; border-right-width: 18px;"></div>
            </div>
            <div class="logo-text-inner">DaysLeft</div>
            <div class="logo-truck">
                <div class="truck-cabin"></div>
                <div class="truck-cargo"></div>
                <div class="truck-window"></div>
                <div class="truck-wheel" style="left: 3px;"></div>
                <div class="truck-wheel" style="left: 15px;"></div>
            </div>
        </div>
        <div class="splash-title">Budget Overlander</div>
    </div>

    <div class="header" id="mainHeader">
            <div class="logo">
                <div class="animated-logo">
                    <div class="logo-sky"></div>
                    <div class="logo-sun"></div>
                    <div class="logo-mountains">
                        <div class="logo-mountain" style="left: 10px;"></div>
                        <div class="logo-mountain" style="left: 35px; border-bottom-width: 12px; border-left-width: 12px; border-right-width: 12px;"></div>
                        <div class="logo-mountain" style="left: 60px; border-bottom-width: 10px; border-left-width: 10px; border-right-width: 10px;"></div>
                    </div>
                    <div class="logo-text-inner">DaysLeft</div>
                    <div class="logo-truck">
                        <div class="truck-cabin"></div>
                        <div class="truck-cargo"></div>
                        <div class="truck-window"></div>
                        <div class="truck-wheel" style="left: 2px;"></div>
                        <div class="truck-wheel" style="left: 14px;"></div>
                        <div class="dust" style="left: -3px;"></div>
                        <div class="dust" style="left: -6px; animation-delay: 0.2s;"></div>
                        <div class="dust" style="left: -9px; animation-delay: 0.4s;"></div>
                    </div>
                </div>
        </div>
    </div>

    <div class="app-container">
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p data-i18n="messages.loading">Lade Daten...</p>
        </div>

        <div id="loginState" style="display: none; text-align: center; padding: 20px; padding-top: calc(env(safe-area-inset-top) + 20px);">
            <div class="animated-logo" style="margin: 0 auto 20px; transform: scale(1.5);">
                <div class="logo-sky"></div>
                <div class="logo-sun"></div>
                <div class="logo-mountains">
                    <div class="logo-mountain" style="left: 10px;"></div>
                    <div class="logo-mountain" style="left: 35px; border-bottom-width: 12px; border-left-width: 12px; border-right-width: 12px;"></div>
                    <div class="logo-mountain" style="left: 60px; border-bottom-width: 10px; border-left-width: 10px; border-right-width: 10px;"></div>
                </div>
                <div class="logo-text-inner">DaysLeft</div>
                <div class="logo-truck">
                    <div class="truck-cabin"></div>
                    <div class="truck-cargo"></div>
                    <div class="truck-window"></div>
                    <div class="truck-wheel" style="left: 2px;"></div>
                    <div class="truck-wheel" style="left: 14px;"></div>
                    <div class="dust" style="left: -3px;"></div>
                    <div class="dust" style="left: -6px; animation-delay: 0.2s;"></div>
                    <div class="dust" style="left: -9px; animation-delay: 0.4s;"></div>
                </div>
            </div>
            <h1 style="font-size: 28px; margin-bottom: 8px;">DaysLeft</h1>
            <p style="opacity: 0.8; margin-bottom: 30px;" data-i18n="app.subtitle">Deine Autarkie im Blick</p>
            
            <div class="form-group">
                <input type="email" class="form-input" id="loginEmail" placeholder="E-Mail" data-i18n-placeholder="auth.email" style="text-align: center;">
            </div>
            <div class="form-group">
                <input type="password" class="form-input" id="loginPassword" placeholder="Passwort" data-i18n-placeholder="auth.password" style="text-align: center;">
            </div>
            
            <button class="btn btn-primary" onclick="doLogin()" style="margin-bottom: 10px;" data-i18n="auth.login">Einloggen</button>
            <button class="btn btn-secondary" onclick="openRegisterModal()" data-i18n="auth.register">Neuen Account erstellen</button>
            
            <!-- Rechtliche Links -->
            <div style="margin-top: 20px; font-size: 12px; opacity: 0.7;">
                <a href="#" onclick="openLegalModal('impressum'); return false;" style="color: rgba(255,255,255,0.8); margin: 0 8px;">Impressum</a> |
                <a href="#" onclick="openLegalModal('datenschutz'); return false;" style="color: rgba(255,255,255,0.8); margin: 0 8px;">Datenschutz</a> |
                <a href="#" onclick="openLegalModal('agb'); return false;" style="color: rgba(255,255,255,0.8); margin: 0 8px;">AGB</a>
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                <div style="display:flex;gap:8px;justify-content:center;">
                    <button class="btn btn-secondary" onclick="setLanguage('de')" style="padding:8px 16px;">üá©üá™ DE</button>
                    <button class="btn btn-secondary" onclick="setLanguage('en')" style="padding:8px 16px;">üá¨üáß EN</button>
                </div>
            </div>

            <!-- DEMO: Google AdSense - Banner im Login-Bereich -->
            <div class="ad-container ad-banner" id="adLoginBanner" style="margin-top: 20px;">
                <div class="ad-label">Anzeige</div>
                <div class="ad-demo-text">üì¢ Google AdSense</div>
                <div class="ad-demo-size">320x50 (Mobile Banner)</div>
            </div>
        </div>

        <div id="noVehicleState" class="no-vehicle" style="display: none;">
            <div class="no-vehicle-icon">üöê</div>
            <div class="no-vehicle-title" data-i18n="messages.noVehicleTitle">Kein Fahrzeug eingerichtet</div>
            <div class="no-vehicle-text" data-i18n="messages.noVehicleText">Richte zuerst dein Fahrzeug ein.</div>
            <button class="btn btn-primary" onclick="showSetup()" data-i18n="setup.createVehicle">Fahrzeug einrichten</button>
        </div>

        <div id="dashboardState" style="display: none;">
            <div class="vehicle-selector" onclick="showSetup()">
                <div class="vehicle-info">
                    <span class="vehicle-icon">üöê</span>
                    <div>
                        <div class="vehicle-name" id="vehicleName">Mein Fahrzeug</div>
                        <div class="vehicle-details" id="vehicleDetails">-</div>
                    </div>
                </div>
                <div id="vehicleWeather" style="display:none; margin-left:auto; margin-right:12px; align-items:center; gap:6px;">
                    <div id="vehicleWeatherIcon" style="font-size:28px; line-height:1; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));">üåßÔ∏è</div>
                    <div id="vehicleWeatherTemp" style="font-size:22px; font-weight:300; letter-spacing:-0.5px; color:rgba(255,255,255,0.95);">--¬∞</div>
                </div>
                <span>‚ñ∂</span>
            </div>

            <div class="autarky-dashboard" id="autarkyDashboard">
                <div class="autarky-main">
                    <div class="autarky-days" id="autarkyDays">--</div>
                    <div class="autarky-label">Tage<br>autark</div>
                </div>
                <div class="autarky-bottleneck" id="autarkyBottleneck">
                    <span class="autarky-bottleneck-icon">‚ö†Ô∏è</span>
                    <span id="autarkyBottleneckText">Berechne...</span>
                </div>
                <div class="autarky-critical-list" id="autarkyCriticalList"></div>
            </div>

            <!-- AdSense Banner unter Dashboard -->
            <div class="ad-container ad-banner" id="adBannerDashboard">
                <div class="ad-label">Anzeige</div>
                <div class="ad-demo-text">üì¢ Google AdSense Banner</div>
                <div class="ad-demo-size">320x100 (Large Mobile Banner)</div>
            </div>

            <div class="resources-grid" id="resourcesGrid"></div>
            
            <!-- Edit Mode Button -->
            <button class="edit-mode-btn" id="editModeBtn" onclick="toggleEditMode()">‚úèÔ∏è</button>

            <!-- DEMO: Google AdSense - Banner zwischen Ressourcen und Quick Actions -->
            <div class="ad-container ad-banner" id="adBannerTop">
                <div class="ad-label">Anzeige</div>
                <div class="ad-demo-text">üì¢ Google AdSense Banner</div>
                <div class="ad-demo-size">320x50 / 320x100 (Mobile Banner)</div>
            </div>

            <div class="quick-actions">
                <div class="quick-actions-title" data-i18n="quickActions.title">Schnellaktionen</div>
                <div class="quick-actions-grid" id="quickActionsGrid"></div>
            </div>

            <!-- DEMO: Google AdSense - Rectangle Ad am Ende -->
            <div class="ad-container ad-rectangle" id="adRectangleBottom">
                <div class="ad-label">Anzeige</div>
                <div class="ad-demo-text">üì¢ Google AdSense Rectangle</div>
                <div class="ad-demo-size">300x250 (Medium Rectangle)</div>
            </div>
        </div>

        <div id="setupScreen" class="setup-screen">
            <div class="setup-title" data-i18n="setup.title">Fahrzeug einrichten</div>
            <div class="setup-subtitle" data-i18n="setup.subtitle">W√§hle deine Ressourcen und gib die Kapazit√§ten ein</div>

            <div class="tabs">
                <button class="tab active" onclick="switchSetupTab('categories')" data-i18n="setup.categories">Kategorien</button>
                <button class="tab" onclick="switchSetupTab('details')" data-i18n="setup.details">Details</button>
            </div>

            <form id="vehicleForm" onsubmit="saveVehicle(event)">
                <div id="categoriesTab">
                    <div class="input-row">
                        <div class="form-group" style="flex:2;">
                            <label class="form-label" data-i18n="setup.vehicleName">Fahrzeugname</label>
                            <input type="text" class="form-input" id="setupName" placeholder="z.B. Mein Fuso" required>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label class="form-label" data-i18n="setup.personCount">Personen</label>
                            <input type="number" class="form-input" id="setupPersonCount" placeholder="2" min="1" max="10" value="2">
                        </div>
                    </div>

                    <div class="setup-section">
                        <div class="setup-section-title" data-i18n="setup.activeResources">Aktive Ressourcen</div>
                        <div id="categoryToggles"></div>
                    </div>
                </div>

                <div id="detailsTab" style="display: none;">
                    <div id="resourceDetails"></div>
                </div>

                <!-- DEMO: Google AdSense - Banner im Setup-Screen -->
                <div class="ad-container ad-banner" id="adSetupBanner" style="margin: 20px 0;">
                    <div class="ad-label">Anzeige</div>
                    <div class="ad-demo-text">üì¢ Google AdSense Banner</div>
                    <div class="ad-demo-size">320x50 (Mobile Banner)</div>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 16px;" data-i18n="actions.save">Speichern</button>
                <button type="button" class="btn btn-secondary" style="margin-top: 10px;" onclick="cancelSetup()" data-i18n="actions.cancel">Abbrechen</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="resourceModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Ressource anpassen</span>
                <button class="modal-close" onclick="closeResourceModal()">‚úï</button>
            </div>
            <div class="slider-container">
                <div class="slider-header">
                    <span data-i18n="modal.level">F√ºllstand</span>
                    <span class="slider-value" id="modalSliderValue">50%</span>
                </div>
                <input type="range" id="modalSlider" min="0" max="100" value="50" oninput="updateSliderValue()">
            </div>
            <div class="btn-grid">
                <button class="btn btn-secondary" onclick="setLevel(0)" data-i18n="modal.empty">Leer</button>
                <button class="btn btn-secondary" onclick="setLevel(25)">25%</button>
                <button class="btn btn-secondary" onclick="setLevel(50)">50%</button>
                <button class="btn btn-secondary" onclick="setLevel(75)">75%</button>
                <button class="btn btn-secondary" onclick="setLevel(100)" data-i18n="modal.full">Voll</button>
            </div>
            <button class="btn btn-primary" onclick="saveResourceLevel()" data-i18n="actions.save">Speichern</button>
            
            <!-- Verbraucher-Bereich nur f√ºr Power -->
            <div id="modalConsumersSection" style="display:none; margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2);">
                <div class="setup-section-title" style="margin-bottom:12px;">‚ö° Verbraucher verwalten</div>
                <div id="modalConsumersList"></div>
                
                <!-- Neuer Verbraucher -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="setup-section-title">Neuer Verbraucher</div>
                    <div class="input-row" style="gap: 10px; margin-bottom: 12px;">
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <input type="text" class="form-input" id="modalNewConsumerName" placeholder="z.B. K√ºhlschrank">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <input type="number" class="form-input" id="modalNewConsumerAh" placeholder="Ah/Tag" step="0.1">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addModalConsumer()" style="width: 100%;">Hinzuf√ºgen</button>
                </div>
                
                <div id="modalConsumersSummary" style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="consumersModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <span class="modal-title">üîã <span data-i18n="consumers.manage">Verbraucher verwalten</span></span>
                <button class="modal-close" onclick="closeConsumersModal()">‚úï</button>
            </div>
            <div id="consumersList"></div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="setup-section-title" data-i18n="consumers.new">Neuer Verbraucher</div>
                <div class="input-row">
                    <div class="form-group" style="flex: 2;">
                        <input type="text" class="form-input" id="newConsumerName" placeholder="z.B. K√ºhlschrank">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <input type="number" class="form-input" id="newConsumerAh" placeholder="Ah/Tag" step="0.1">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addConsumer()" data-i18n="actions.add">Hinzuf√ºgen</button>
            </div>
            <div id="consumersSummary" style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="customResourcesModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <span class="modal-title">üì¶ <span data-i18n="customResources.title">Eigene Ressourcen</span></span>
                <button class="modal-close" onclick="closeCustomResourcesModal()">‚úï</button>
            </div>
            <!-- Tabs -->
            <div style="display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid rgba(255,255,255,0.1);">
                <button class="custom-res-tab active" id="tabExisting" onclick="switchCustomResTab('existing')" style="flex:1;padding:12px;background:transparent;border:none;color:white;font-weight:600;cursor:pointer;border-bottom:2px solid #4CAF50;margin-bottom:-2px;">üìã Alle</button>
                <button class="custom-res-tab" id="tabNew" onclick="switchCustomResTab('new')" style="flex:1;padding:12px;background:transparent;border:none;color:white;font-weight:600;cursor:pointer;opacity:0.6;">‚ûï Neu anlegen</button>
            </div>
            <!-- Tab: Existing -->
            <div id="customResTabExisting">
                <div id="customResourcesList"></div>
            </div>
            <!-- Tab: New -->
            <div id="customResTabNew" style="display:none;">
                <div class="setup-section-title">Neue Ressource erstellen</div>
                <div class="input-row">
                    <div class="form-group" style="flex: 0.5;">
                        <label>Icon</label>
                        <select class="form-input" id="newCustomIcon" style="font-size:18px;">
                            <option value="üì¶">üì¶ Paket</option>
                            <option value="üêï">üêï Hund</option>
                            <option value="üêà">üêà Katze</option>
                            <option value="üß¥">üß¥ Hygiene</option>
                            <option value="üíä">üíä Medizin</option>
                            <option value="üßª">üßª Papier</option>
                            <option value="üßπ">üßπ Reinigung</option>
                            <option value="üîã">üîã Batterie</option>
                            <option value="‚õΩ">‚õΩ Benzin</option>
                            <option value="ü™µ">ü™µ Holz</option>
                            <option value="üßä">üßä Eis</option>
                            <option value="‚òï">‚òï Kaffee</option>
                            <option value="üç∫">üç∫ Bier</option>
                            <option value="ü•õ">ü•õ Milch</option>
                            <option value="ü•ö">ü•ö Eier</option>
                            <option value="üçû">üçû Brot</option>
                            <option value="ü•©">ü•© Fleisch</option>
                            <option value="üßÄ">üßÄ K√§se</option>
                            <option value="üóëÔ∏è">üóëÔ∏è M√ºll</option>
                            <option value="üéí">üéí Rucksack</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Name</label>
                        <input type="text" class="form-input" id="newCustomName" placeholder="z.B. Hundefutter">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Einheit</label>
                        <input type="text" class="form-input" id="newCustomUnit" placeholder="kg, L, St√ºck" value="St√ºck">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Kapazit√§t</label>
                        <input type="number" class="form-input" id="newCustomCapacity" placeholder="Max" step="0.1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>pro Person/Tag</label>
                        <input type="number" class="form-input" id="newCustomConsumption" placeholder="Optional" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="newCustomInverted"> Invertiert (je voller desto schlechter, z.B. M√ºll)
                    </label>
                </div>
                <button class="btn btn-primary" onclick="addCustomResource()">Ressource erstellen</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚öôÔ∏è <span data-i18n="settings.title">Einstellungen</span> <span id="premiumBadge" style="display:none;background:#f1c40f;color:#000;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:8px;">‚≠ê PREMIUM</span></span>
                <button class="modal-close" onclick="closeSettingsModal()">‚úï</button>
            </div>
            
            <div class="setup-section" id="premiumSection">
                <div class="setup-section-title">‚≠ê Premium</div>
                <div style="text-align:center;padding:12px;">Lade...</div>
            </div>
            
            <div class="setup-section">
                <div class="setup-section-title" data-i18n="settings.language">Sprache</div>
                <div style="display:flex;gap:8px;">
                    <button class="btn" id="langDe" onclick="setLanguage('de')" style="flex:1;">üá©üá™ Deutsch</button>
                    <button class="btn" id="langEn" onclick="setLanguage('en')" style="flex:1;">üá¨üáß English</button>
                </div>
            </div>
            
            <div class="setup-section">
                <div class="setup-section-title">üìú Rechtliches</div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <button class="btn btn-secondary" onclick="openLegalModal('impressum'); closeSettingsModal();" style="text-align:left;padding:12px;">üìã Impressum</button>
                    <button class="btn btn-secondary" onclick="openLegalModal('datenschutz'); closeSettingsModal();" style="text-align:left;padding:12px;">üîí Datenschutzerkl√§rung</button>
                    <button class="btn btn-secondary" onclick="openLegalModal('agb'); closeSettingsModal();" style="text-align:left;padding:12px;">üìÑ Nutzungsbedingungen (AGB)</button>
                    <button class="btn btn-secondary" onclick="logout()" style="text-align:left;padding:12px;margin-top:8px;color:#ff7b7b;">üö™ Logout</button>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="closeSettingsModal()" style="margin-top:16px;" data-i18n="actions.close">Schlie√üen</button>
        </div>
    </div>

    <!-- Karten Modal -->
    <div class="modal-overlay" id="mapModal" style="align-items:stretch;">
        <div class="modal" style="max-width:100%;height:100%;border-radius:0;padding:0;display:flex;flex-direction:column;background:#1a1a1a;">
            <!-- Kompakter Header -->
            <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);flex-shrink:0;">
                <span style="font-size:16px;font-weight:600;color:white;">üó∫Ô∏è POIs in der N√§he</span>
                <button onclick="closeMapModal()" style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.2);border:none;color:white;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
            </div>
            
            <!-- Horizontale Pill-Filter -->
            <div style="display:flex;gap:6px;padding:10px 12px;background:#1a1a1a;overflow-x:auto;flex-shrink:0;-webkit-overflow-scrolling:touch;" id="poiFilters">
                <button class="poi-pill active" data-poi="water" onclick="togglePoiFilter('water')">
                    <span class="poi-pill-icon" style="background:#3498db;">üíß</span>
                    <span class="poi-pill-count" id="count-water">0</span>
                </button>
                <button class="poi-pill active" data-poi="fuel" onclick="togglePoiFilter('fuel')">
                    <span class="poi-pill-icon" style="background:#e74c3c;">‚õΩ</span>
                    <span class="poi-pill-count" id="count-fuel">0</span>
                </button>
                <button class="poi-pill active" data-poi="power" onclick="togglePoiFilter('power')">
                    <span class="poi-pill-icon" style="background:#f39c12;">‚õ∫</span>
                    <span class="poi-pill-count" id="count-power">0</span>
                </button>
                <button class="poi-pill active" data-poi="shop" onclick="togglePoiFilter('shop')">
                    <span class="poi-pill-icon" style="background:#27ae60;">üõí</span>
                    <span class="poi-pill-count" id="count-shop">0</span>
                </button>
                <button class="poi-pill active" data-poi="dump" onclick="togglePoiFilter('dump')">
                    <span class="poi-pill-icon" style="background:#1abc9c;">üöø</span>
                    <span class="poi-pill-count" id="count-dump">0</span>
                </button>
            </div>
            
            <!-- Karte -->
            <div id="mapContainer" style="flex:1;min-height:300px;position:relative;">
                <!-- Reload Button -->
                <button id="mapReloadBtn" onclick="reloadPOIsAtCenter()" style="display:none;position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:1000;background:#4CAF50;color:white;border:none;padding:10px 20px;border-radius:25px;font-size:13px;font-weight:600;box-shadow:0 3px 12px rgba(0,0,0,0.3);cursor:pointer;">
                    üîÑ POIs hier laden
                </button>
                <!-- Loading Overlay -->
                <div id="mapLoading" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1001;">
                    <div style="width:40px;height:40px;border:3px solid rgba(255,255,255,0.2);border-top-color:#4CAF50;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
                    <div id="mapLoadingText" style="color:white;margin-top:12px;font-size:13px;">Lade POIs...</div>
                    <div id="mapLoadingProgress" style="width:200px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;margin-top:10px;overflow:hidden;">
                        <div id="mapLoadingBar" style="width:0%;height:100%;background:#4CAF50;transition:width 0.3s;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Debug -->
            <div id="mapDebug" style="padding:10px 12px;font-size:11px;background:#111;color:#4CAF50;min-height:60px;max-height:100px;overflow-y:auto;font-family:monospace;"></div>
        </div>
    </div>

    <!-- Standort Modal -->
    <div class="modal-overlay" id="locationModal">
        <div class="modal" style="max-width: 340px;">
            <div class="modal-header">
                <span class="modal-title">üìç Standort f√ºr Solar</span>
                <button class="modal-close" onclick="closeLocationModal()">‚úï</button>
            </div>
            <div style="padding: 16px 0; font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.9);">
                <p style="margin-bottom: 12px;">
                    <strong>Warum brauchen wir deinen Standort?</strong>
                </p>
                <p style="margin-bottom: 12px; opacity: 0.85;">
                    Mit deinem Standort k√∂nnen wir die <strong>Wetterprognose</strong> abrufen und den 
                    <strong>t√§glichen Solarertrag</strong> deiner Anlage sch√§tzen.
                </p>
                <p style="margin-bottom: 16px; opacity: 0.85;">
                    ‚òÄÔ∏è Sonnenstunden heute<br>
                    ‚ö° Gesch√§tzter Ertrag in Ah<br>
                    üå§Ô∏è 3-Tage Wettervorhersage
                </p>
                <p style="font-size: 12px; opacity: 0.6; margin-bottom: 0;">
                    Dein Standort wird nur lokal gespeichert und nicht an unsere Server gesendet.
                </p>
            </div>
            <div id="locationModalStatus" style="display:none; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 12px; font-size: 13px;"></div>
            <button class="btn btn-primary" onclick="confirmLocationRequest()" style="width: 100%;">üìç Standort freigeben</button>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal" style="max-width: 380px;">
            <div class="modal-header">
                <span class="modal-title">üöÄ Account erstellen</span>
                <button class="modal-close" onclick="closeRegisterModal()">‚úï</button>
            </div>
            <div style="padding: 8px 0;">
                <div class="form-group">
                    <input type="email" class="form-input" id="registerEmail" placeholder="E-Mail" style="text-align: center;">
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="registerPassword" placeholder="Passwort" style="text-align: center;">
                </div>
                <div style="text-align: left; margin: 16px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-size: 13px; line-height: 1.4;">
                        <input type="checkbox" id="registerLegalConsent" style="width: 20px; height: 20px; margin-top: 2px; flex-shrink: 0;">
                        <span>Ich akzeptiere die <a href="#" onclick="openLegalModal('agb'); return false;" style="color: #4CAF50;">Nutzungsbedingungen (AGB)</a> und habe die <a href="#" onclick="openLegalModal('datenschutz'); return false;" style="color: #4CAF50;">Datenschutzerkl√§rung</a> gelesen.</span>
                    </label>
                </div>
                <button class="btn btn-primary" onclick="doRegister()" style="width: 100%;">Account erstellen</button>
            </div>
        </div>
    </div>

    <!-- Rechtliche Modals (Impressum, Datenschutz, AGB) -->
    <div class="modal-overlay" id="legalModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <span class="modal-title" id="legalModalTitle">Rechtliches</span>
                <button class="modal-close" onclick="closeLegalModal()">‚úï</button>
            </div>
            <div id="legalModalContent" style="font-size: 14px; line-height: 1.6; color: rgba(255,255,255,0.9);"></div>
            <button class="btn btn-primary" onclick="closeLegalModal()" style="margin-top: 20px;">Schlie√üen</button>
        </div>
    </div>

    <!-- Aktivit√§tslog Modal -->
    <div class="modal-overlay" id="activityLogModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <span class="modal-title">üìã Aktivit√§tslog</span>
                <button class="modal-close" onclick="closeActivityLogModal()">‚úï</button>
            </div>
            <div id="activityLogContent" style="font-size: 14px;">
                <div style="text-align: center; padding: 20px; opacity: 0.7;">
                    <div class="spinner"></div>
                    <p>Lade Aktivit√§ten...</p>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="closeActivityLogModal()" style="margin-top: 16px;">Schlie√üen</button>
        </div>
    </div>

    <!-- Capacitor Bridge f√ºr Native App Features -->
    <script src="js/capacitor-bridge.js"></script>
    
    <script>
        // API-URL: Native App, Lokal oder Web
        const isNativeApp = window.Capacitor !== undefined || window.location.protocol === 'capacitor:' || window.location.protocol === 'ionic:';
        const isLocalDev = !isNativeApp && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
        const API_BASE = isNativeApp 
            ? 'http://budget.wirkstoff.com/api'
            : isLocalDev 
                ? 'http://localhost:3001/api' 
                : '/api';
        
        console.log('API Config:', { isNativeApp, isLocalDev, API_BASE });

        // i18n - Mehrsprachigkeit
        let currentLang = localStorage.getItem('language') || 'de';
        let translations = {};

        async function loadTranslations() {
            try {
                const response = await fetch(`/i18n/${currentLang}.json`);
                translations = await response.json();
            } catch (e) {
                console.error('Translations load error:', e);
                translations = {};
            }
        }

        function t(key, params = {}) {
            const keys = key.split('.');
            let value = translations;
            for (const k of keys) {
                value = value?.[k];
            }
            if (typeof value !== 'string') return key;
            return value.replace(/\{(\w+)\}/g, (_, p) => params[p] ?? '');
        }

        async function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;
            await loadTranslations();
            applyTranslations();
            updateLangButtons();
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
            if (currentVehicle) updateUI();
        }

        const RESOURCE_CONFIG = {
            water: { icon: 'üíß', key: 'water', unit: 'L', color: '#3498db', capacityField: 'freshWaterCapacity', consumptionField: 'waterConsumptionPerDay', inverted: false },
            power: { icon: 'üîã', key: 'power', unit: 'Ah', color: '#f39c12', capacityField: 'batteryCapacity', consumptionField: 'powerConsumptionPerDay', inverted: false },
            fuel: { icon: '‚õΩ', key: 'fuel', unit: 'L', color: '#ff7b7b', capacityField: 'fuelTankCapacity', consumptionField: 'fuelConsumption', inverted: false },
            gas: { icon: 'üî•', key: 'gas', unit: 'kg', color: '#9b59b6', capacityField: 'gasCapacity', consumptionField: 'gasConsumptionPerDay', inverted: false },
            greywater: { icon: 'üöø', key: 'greywater', unit: 'L', color: '#95a5a6', capacityField: 'greyWaterCapacity', consumptionField: null, inverted: true },
            toilet: { icon: 'üöΩ', key: 'toilet', unit: '', color: '#1abc9c', capacityField: 'toiletCapacity', consumptionField: null, inverted: true, hasType: true, types: ['ttt', 'clesana', 'chemical'] },
            food: { icon: 'üçΩÔ∏è', key: 'food', unit: 'Tage', color: '#e67e22', capacityField: 'foodCapacity', consumptionField: null, inverted: false },
            drinks: { icon: 'ü•§', key: 'drinks', unit: 'L', color: '#3498db', capacityField: 'drinksCapacity', consumptionField: null, inverted: false },
            beer: { icon: 'üç∫', key: 'beer', unit: 'Flaschen', color: '#f1c40f', capacityField: 'beerCapacity', consumptionField: 'beerConsumptionPerDay', inverted: false }
        };

        function getResourceName(key) {
            return t(`resources.${key}`) || key;
        }

        let currentVehicle = null;
        let currentLevels = null;
        let currentResourceType = null;
        let enabledResources = ['water', 'power', 'fuel', 'gas'];
        let isPremium = false;
        let isEditMode = false;
        let customResourceOrder = JSON.parse(localStorage.getItem('resourceOrder') || 'null');

        function getToken() { return localStorage.getItem('token'); }

        async function fetchAPI(endpoint, options = {}) {
            const token = getToken();
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers }
            });
            if (response.status === 401 || response.status === 403) { 
                localStorage.removeItem('token');
                const loginEl = document.getElementById('loginState');
                if (loginEl) {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('noVehicleState').style.display = 'none';
                    document.getElementById('dashboardState').style.display = 'none';
                    document.getElementById('setupScreen').classList.remove('active');
                    loginEl.style.display = 'block';
                }
                return null; 
            }
            return response.json();
        }

        function hideSplash() {
            const splash = document.getElementById('splashScreen');
            if (splash) {
                splash.classList.add('fade-out');
                setTimeout(() => splash.remove(), 500);
            }
        }

        // Toast Notification
        function showToast(title, message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            const icons = { success: '‚úÖ', info: 'üîÑ', warning: '‚ö†Ô∏è' };
            toast.querySelector('.toast-icon').textContent = icons[type] || 'üîÑ';
            toast.querySelector('.toast-title').textContent = title;
            toast.querySelector('.toast-message').textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // Pull-to-Refresh
        let pullStartY = 0;
        let isPulling = false;
        let isRefreshing = false;

        function initPullToRefresh() {
            const dashboard = document.getElementById('dashboardState');
            if (!dashboard || dashboard.dataset.pullInit) return;
            dashboard.dataset.pullInit = 'true';

            dashboard.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0 && !isRefreshing) {
                    pullStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });

            dashboard.addEventListener('touchmove', (e) => {
                if (!isPulling || isRefreshing) return;
                const pullDistance = e.touches[0].clientY - pullStartY;
                const pullRefresh = document.getElementById('pullRefresh');
                
                if (pullDistance > 50 && window.scrollY === 0) {
                    pullRefresh.classList.add('visible');
                } else {
                    pullRefresh.classList.remove('visible');
                }
            }, { passive: true });

            // Immer isPulling zur√ºcksetzen bei touchend (global)
            document.addEventListener('touchend', () => {
                if (!isPulling) return;
                isPulling = false;
            }, { passive: true });

            dashboard.addEventListener('touchend', async () => {
                const pullRefresh = document.getElementById('pullRefresh');
                
                if (pullRefresh.classList.contains('visible')) {
                    isRefreshing = true;
                    pullRefresh.classList.add('loading');
                    
                    try {
                        const data = await fetchAPI('/resources/current');
                        if (data && data.levels) {
                            currentLevels = data.levels;
                            previousLevels = { ...data.levels };
                            await updateUI();
                            showToast('Aktualisiert', 'Daten wurden geladen', 'success');
                        }
                    } catch (e) {
                        showToast('Fehler', 'Aktualisierung fehlgeschlagen', 'warning');
                    }
                    
                    // Spinner ausblenden und nach oben scrollen
                    setTimeout(() => {
                        pullRefresh.classList.remove('visible', 'loading');
                        window.scrollTo(0, 0);
                        document.documentElement.scrollTop = 0;
                        document.body.scrollTop = 0;
                        isRefreshing = false;
                    }, 200);
                }
            });
        }

        // Auto-Refresh alle 5 Minuten
        let autoRefreshInterval = null;
        let previousLevels = null;

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(async () => {
                if (!currentVehicle || document.hidden) return;
                try {
                    const data = await fetchAPI('/resources/current');
                    if (data && data.levels) {
                        const changes = detectChanges(previousLevels, data.levels);
                        previousLevels = { ...data.levels };
                        currentLevels = data.levels;
                        if (changes.length > 0) {
                            await updateUI();
                            showToast('Daten aktualisiert', changes.join(', '), 'success');
                        }
                    }
                } catch (e) { console.error('Auto-refresh error:', e); }
            }, 5 * 60 * 1000); // 5 Minuten
        }

        function detectChanges(oldLevels, newLevels) {
            if (!oldLevels) return [];
            const changes = [];
            const fields = ['water_percentage', 'power_percentage', 'gas_percentage', 'fuel_percentage'];
            const names = { water: 'Wasser', power: 'Batterie', gas: 'Gas', fuel: 'Treibstoff' };
            for (const field of fields) {
                const key = field.split('_')[0];
                const oldVal = parseFloat(oldLevels[field]) || 0;
                const newVal = parseFloat(newLevels[field]) || 0;
                const diff = newVal - oldVal;
                if (Math.abs(diff) >= 1) {
                    const sign = diff > 0 ? '+' : '';
                    changes.push(`${names[key]} ${sign}${Math.round(diff)}%`);
                }
            }
            return changes;
        }

        async function init() {
            await loadTranslations();
            const token = getToken();
            if (!token) { 
                hideSplash();
                showLogin(); 
                return; 
            }
            try {
                // Premium-Status laden
                await checkPremiumStatus();
                
                const data = await fetchAPI('/resources/current');
                if (!data || !data.vehicle) { showNoVehicle(); return; }
                currentVehicle = data.vehicle;
                currentLevels = data.levels;
                enabledResources = currentVehicle.enabled_resources || ['water', 'power', 'fuel', 'gas'];
                
                // Wetterdaten laden wenn Standort vorhanden
                if (userLocation) {
                    fetchWeatherAndSolar().catch(() => {});
                }
                
                showDashboard();
                updateUI();
            } catch (error) {
                console.error('Init error:', error);
                showNoVehicle();
            }
        }

        async function checkPremiumStatus() {
            try {
                const data = await fetchAPI('/premium/status');
                isPremium = data?.isPremium || false;
                updateAdsVisibility();
                updatePremiumUI();
            } catch (e) {
                isPremium = false;
            }
        }

        function updateAdsVisibility() {
            const ads = document.querySelectorAll('.ad-container');
            ads.forEach(ad => {
                ad.style.display = isPremium ? 'none' : 'flex';
            });
        }

        function updatePremiumUI() {
            const premiumBadge = document.getElementById('premiumBadge');
            const premiumSection = document.getElementById('premiumSection');
            if (premiumBadge) premiumBadge.style.display = isPremium ? 'inline' : 'none';
            if (premiumSection) {
                premiumSection.innerHTML = isPremium 
                    ? `<div style="text-align:center;padding:16px;background:rgba(76,175,80,0.2);border-radius:12px;"><div style="font-size:24px;margin-bottom:8px;">‚≠ê</div><div style="font-weight:600;">Premium aktiv</div><div style="font-size:12px;opacity:0.7;">Keine Werbung</div><button class="btn btn-secondary" onclick="toggleDebugPremium()" style="margin-top:12px;padding:6px 12px;font-size:11px;opacity:0.6;">üêõ Debug: Premium deaktivieren</button></div>`
                    : renderPremiumOptions() + `<button class="btn btn-secondary" onclick="toggleDebugPremium()" style="margin-top:12px;padding:6px 12px;font-size:11px;opacity:0.6;">üêõ Debug: Premium aktivieren</button>`;
            }
        }

        function toggleDebugPremium() {
            isPremium = !isPremium;
            updateAdsVisibility();
            updatePremiumUI();
        }

        // === EDIT MODE & DRAG-AND-DROP ===
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const grid = document.getElementById('resourcesGrid');
            const btn = document.getElementById('editModeBtn');
            
            if (isEditMode) {
                grid.classList.add('edit-mode');
                btn.classList.add('active');
                btn.textContent = '‚úì';
                initDragAndDrop();
            } else {
                grid.classList.remove('edit-mode');
                btn.classList.remove('active');
                btn.textContent = '‚úèÔ∏è';
                saveResourceOrder();
            }
        }

        function initDragAndDrop() {
            const grid = document.getElementById('resourcesGrid');
            const cards = grid.querySelectorAll('.resource-card');
            
            cards.forEach(card => {
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('touchstart', handleTouchStart, { passive: false });
                card.addEventListener('touchmove', handleTouchMove, { passive: false });
                card.addEventListener('touchend', handleTouchEnd);
            });
        }

        let draggedCard = null;
        let touchStartY = 0;
        let touchStartX = 0;

        function handleDragStart(e) {
            if (!isEditMode) return;
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedCard = null;
        }

        function handleDragOver(e) {
            if (!isEditMode) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            if (!isEditMode || !draggedCard || draggedCard === this) return;
            e.preventDefault();
            
            const grid = document.getElementById('resourcesGrid');
            const cards = [...grid.querySelectorAll('.resource-card')];
            const draggedIdx = cards.indexOf(draggedCard);
            const targetIdx = cards.indexOf(this);
            
            if (draggedIdx < targetIdx) {
                this.parentNode.insertBefore(draggedCard, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedCard, this);
            }
        }

        // Touch-Support f√ºr Mobile
        function handleTouchStart(e) {
            if (!isEditMode) return;
            draggedCard = this;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            this.classList.add('dragging');
        }

        function handleTouchMove(e) {
            if (!isEditMode || !draggedCard) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetCard = elementBelow?.closest('.resource-card');
            
            if (targetCard && targetCard !== draggedCard) {
                const grid = document.getElementById('resourcesGrid');
                const cards = [...grid.querySelectorAll('.resource-card')];
                const draggedIdx = cards.indexOf(draggedCard);
                const targetIdx = cards.indexOf(targetCard);
                
                if (draggedIdx < targetIdx) {
                    targetCard.parentNode.insertBefore(draggedCard, targetCard.nextSibling);
                } else {
                    targetCard.parentNode.insertBefore(draggedCard, targetCard);
                }
            }
        }

        function handleTouchEnd(e) {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                draggedCard = null;
            }
        }

        function saveResourceOrder() {
            const grid = document.getElementById('resourcesGrid');
            const cards = grid.querySelectorAll('.resource-card');
            const order = [...cards].map(card => card.dataset.resource).filter(Boolean);
            
            if (order.length > 0) {
                customResourceOrder = order;
                localStorage.setItem('resourceOrder', JSON.stringify(order));
            }
        }

        function renderPremiumOptions() {
            return `
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:24px;margin-bottom:8px;">üö´‚û°Ô∏è‚≠ê</div>
                    <div style="font-weight:600;">Werbefrei werden</div>
                    <div style="font-size:12px;opacity:0.7;">Unterst√ºtze die App & entferne Werbung</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <button class="btn btn-primary" onclick="purchasePremium('lifetime')" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>‚≠ê Einmalig - F√ºr immer</span>
                        <span style="font-weight:700;">9,99 ‚Ç¨</span>
                    </button>
                    <button class="btn btn-secondary" onclick="purchasePremium('yearly')" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>üìÖ J√§hrlich</span>
                        <span>4,99 ‚Ç¨/Jahr</span>
                    </button>
                    <button class="btn btn-secondary" onclick="purchasePremium('monthly')" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>üìÜ Monatlich</span>
                        <span>0,99 ‚Ç¨/Monat</span>
                    </button>
                </div>
                <div style="font-size:11px;opacity:0.5;text-align:center;margin-top:12px;">Zahlung √ºber Apple Pay / Google Pay (Demo)</div>
            `;
        }

        async function purchasePremium(type) {
            // Demo: Direkt aktivieren (sp√§ter durch echte Payment-Integration ersetzen)
            if (!confirm(`Premium ${type} f√ºr Demo aktivieren?`)) return;
            
            try {
                const result = await fetchAPI('/premium/activate', {
                    method: 'POST',
                    body: JSON.stringify({ premiumType: type, paymentId: 'demo-' + Date.now() })
                });
                
                if (result?.success) {
                    isPremium = true;
                    updateAdsVisibility();
                    updatePremiumUI();
                    alert('Premium erfolgreich aktiviert! Werbung wurde entfernt.');
                    closeSettingsModal();
                } else {
                    alert('Fehler: ' + (result?.error || 'Unbekannt'));
                }
            } catch (e) {
                alert('Fehler beim Aktivieren: ' + e.message);
            }
        }

        function showLogin() {
            document.getElementById('mainHeader').style.display = 'none';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'none';
            document.getElementById('dashboardState').style.display = 'none';
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('loginState').style.display = 'block';
        }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { alert('Bitte E-Mail und Passwort eingeben'); return; }
            
            // Debug: API URL anzeigen
            console.log('Login attempt to:', API_BASE + '/auth/login');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    init();
                } else {
                    alert(data.message || data.error || 'Login fehlgeschlagen');
                }
            } catch (error) {
                console.error('Login error:', error.message, error.stack);
                alert('Login fehlgeschlagen: ' + (error.message || 'Netzwerkfehler'));
            }
        }

        function openRegisterModal() {
            document.getElementById('registerModal').classList.add('active');
            document.getElementById('registerEmail').value = document.getElementById('loginEmail').value || '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerLegalConsent').checked = false;
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
        }

        async function doRegister() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const legalConsent = document.getElementById('registerLegalConsent').checked;
            
            if (!email || !password) { alert('Bitte E-Mail und Passwort eingeben'); return; }
            if (!legalConsent) { 
                alert('Bitte akzeptiere die Nutzungsbedingungen und Datenschutzerkl√§rung, um fortzufahren.'); 
                return; 
            }
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email.split('@')[0], email, password })
                });
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    closeRegisterModal();
                    init();
                } else if (response.ok) {
                    closeRegisterModal();
                    alert('Registrierung erfolgreich! Bitte einloggen.');
                } else {
                    alert(data.message || 'Registrierung fehlgeschlagen');
                }
            } catch (error) {
                console.error('Register error:', error);
                alert('Registrierung fehlgeschlagen');
            }
        }

        // Rechtliche Texte
        const legalTexts = {
            impressum: {
                title: 'Impressum',
                content: `
                    <h3 style="margin-bottom: 12px;">Angaben gem√§√ü ¬ß 5 TMG</h3>
                    <p style="margin-bottom: 16px;">
                        <strong>[Dein Name / Firmenname]</strong><br>
                        [Stra√üe und Hausnummer]<br>
                        [PLZ Ort]<br>
                        Deutschland
                    </p>
                    <h4 style="margin: 16px 0 8px;">Kontakt</h4>
                    <p style="margin-bottom: 16px;">
                        E-Mail: [deine@email.de]<br>
                        Telefon: [optional]
                    </p>
                    <h4 style="margin: 16px 0 8px;">Verantwortlich f√ºr den Inhalt nach ¬ß 55 Abs. 2 RStV</h4>
                    <p>[Dein Name]<br>[Adresse]</p>
                    <h4 style="margin: 16px 0 8px;">Haftungsausschluss</h4>
                    <p style="font-size: 13px; opacity: 0.9;">
                        Die Inhalte dieser App wurden mit gr√∂√üter Sorgfalt erstellt. F√ºr die Richtigkeit, 
                        Vollst√§ndigkeit und Aktualit√§t der Inhalte k√∂nnen wir jedoch keine Gew√§hr √ºbernehmen.
                    </p>
                `
            },
            datenschutz: {
                title: 'Datenschutzerkl√§rung',
                content: `
                    <h3 style="margin-bottom: 12px;">1. Verantwortlicher</h3>
                    <p style="margin-bottom: 16px;">
                        Verantwortlich f√ºr die Datenverarbeitung ist:<br>
                        <strong>[Dein Name / Firmenname]</strong><br>
                        [Adresse]<br>
                        E-Mail: [deine@email.de]
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">2. Erhobene Daten</h3>
                    <p style="margin-bottom: 16px;">Wir erheben und speichern folgende Daten:</p>
                    <ul style="margin-left: 20px; margin-bottom: 16px;">
                        <li>E-Mail-Adresse (f√ºr Account-Erstellung)</li>
                        <li>Passwort (verschl√ºsselt gespeichert)</li>
                        <li>Fahrzeug- und Ressourcendaten (von dir eingegeben)</li>
                    </ul>
                    
                    <h3 style="margin: 16px 0 8px;">3. Zweck der Datenverarbeitung</h3>
                    <p style="margin-bottom: 16px;">
                        Die Daten werden ausschlie√ülich zur Bereitstellung der App-Funktionalit√§t verwendet:
                        Verwaltung deines Benutzerkontos und Speicherung deiner Fahrzeug-/Ressourcendaten.
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">4. Datenspeicherung</h3>
                    <p style="margin-bottom: 16px;">
                        Deine Daten werden auf sicheren Servern in der EU gespeichert. 
                        Die √úbertragung erfolgt verschl√ºsselt (HTTPS).
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">5. Deine Rechte</h3>
                    <p style="margin-bottom: 16px;">Du hast das Recht auf:</p>
                    <ul style="margin-left: 20px; margin-bottom: 16px;">
                        <li>Auskunft √ºber deine gespeicherten Daten</li>
                        <li>Berichtigung unrichtiger Daten</li>
                        <li>L√∂schung deiner Daten</li>
                        <li>Einschr√§nkung der Verarbeitung</li>
                        <li>Daten√ºbertragbarkeit</li>
                    </ul>
                    <p>Kontaktiere uns per E-Mail f√ºr entsprechende Anfragen.</p>
                    
                    <h3 style="margin: 16px 0 8px;">6. Cookies & Lokale Speicherung</h3>
                    <p style="margin-bottom: 16px;">
                        Diese App verwendet localStorage zur Speicherung deines Login-Tokens 
                        und deiner Spracheinstellung. Es werden keine Tracking-Cookies verwendet.
                    </p>
                `
            },
            agb: {
                title: 'Nutzungsbedingungen (AGB)',
                content: `
                    <h3 style="margin-bottom: 12px;">1. Geltungsbereich</h3>
                    <p style="margin-bottom: 16px;">
                        Diese Nutzungsbedingungen gelten f√ºr die Nutzung der DaysLeft App 
                        (im Folgenden "App" genannt).
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">2. Leistungsbeschreibung</h3>
                    <p style="margin-bottom: 16px;">
                        Die App erm√∂glicht die Verwaltung und √úberwachung von Ressourcen 
                        f√ºr Wohnmobile, Campervans und √§hnliche Fahrzeuge. 
                        Die Berechnung der Autarkie-Tage erfolgt auf Basis der eingegebenen Daten.
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">3. Nutzerkonto</h3>
                    <p style="margin-bottom: 16px;">
                        F√ºr die Nutzung ist ein Benutzerkonto erforderlich. 
                        Du bist f√ºr die Geheimhaltung deiner Zugangsdaten verantwortlich.
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">4. Haftungsausschluss</h3>
                    <p style="margin-bottom: 16px;">
                        Die in der App angezeigten Werte und Berechnungen dienen nur als Orientierungshilfe. 
                        Wir √ºbernehmen keine Haftung f√ºr Sch√§den, die durch die Nutzung der App entstehen. 
                        √úberpr√ºfe deine Ressourcen stets eigenst√§ndig.
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">5. √Ñnderungen</h3>
                    <p style="margin-bottom: 16px;">
                        Wir behalten uns vor, diese Nutzungsbedingungen jederzeit zu √§ndern. 
                        √Ñnderungen werden in der App bekannt gegeben.
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">6. K√ºndigung</h3>
                    <p style="margin-bottom: 16px;">
                        Du kannst dein Konto jederzeit l√∂schen. 
                        Kontaktiere uns hierf√ºr per E-Mail.
                    </p>
                    
                    <h3 style="margin: 16px 0 8px;">7. Anwendbares Recht</h3>
                    <p>Es gilt deutsches Recht.</p>
                `
            }
        };

        function openLegalModal(type) {
            const modal = document.getElementById('legalModal');
            const title = document.getElementById('legalModalTitle');
            const content = document.getElementById('legalModalContent');
            
            const legal = legalTexts[type];
            if (legal) {
                title.textContent = legal.title;
                content.innerHTML = legal.content;
                modal.classList.add('active');
            }
        }

        function closeLegalModal() {
            document.getElementById('legalModal').classList.remove('active');
        }

        // === AKTIVIT√ÑTSLOG ===
        async function openActivityLogModal() {
            const modal = document.getElementById('activityLogModal');
            const content = document.getElementById('activityLogContent');
            modal.classList.add('active');
            
            content.innerHTML = `
                <div style="text-align: center; padding: 20px; opacity: 0.7;">
                    <div class="spinner"></div>
                    <p>Lade Aktivit√§ten...</p>
                </div>
            `;
            
            try {
                const data = await fetchAPI('/resources/activity-log?limit=100');
                if (data && data.activities && data.activities.length > 0) {
                    renderActivityLog(data.activities);
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 30px; opacity: 0.7;">
                            <div style="font-size: 48px; margin-bottom: 12px;">üìã</div>
                            <p>Noch keine Aktivit√§ten vorhanden.</p>
                            <p style="font-size: 12px; margin-top: 8px;">Aktivit√§ten werden automatisch erfasst wenn:</p>
                            <ul style="text-align: left; font-size: 12px; margin-top: 8px; padding-left: 20px;">
                                <li>Du Ressourcen anpasst</li>
                                <li>Der st√ºndliche Verbrauch berechnet wird</li>
                                <li>Tanks geleert oder gef√ºllt werden</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Activity log error:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #ff7b7b;">
                        <div style="font-size: 48px; margin-bottom: 12px;">‚ö†Ô∏è</div>
                        <p>Fehler beim Laden der Aktivit√§ten</p>
                    </div>
                `;
            }
        }

        function renderActivityLog(activities) {
            const content = document.getElementById('activityLogContent');
            
            // Gruppiere nach Datum
            const grouped = {};
            for (const act of activities) {
                const date = new Date(act.created_at);
                const dateKey = date.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(act);
            }
            
            let html = '';
            for (const [dateKey, acts] of Object.entries(grouped)) {
                html += `<div style="font-weight: 600; font-size: 13px; margin: 16px 0 8px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.1);">${dateKey}</div>`;
                
                for (const act of acts) {
                    const time = new Date(act.created_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    const icon = act.resource_icon || getActivityIcon(act.activity_type);
                    const typeLabel = getActivityTypeLabel(act.activity_type);
                    const typeBadgeColor = getActivityTypeColor(act.activity_type);
                    
                    html += `
                        <div style="display: flex; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 6px;">
                            <div style="font-size: 20px; width: 28px; text-align: center;">${icon}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: ${typeBadgeColor};">${typeLabel}</span>
                                    <span style="font-size: 11px; opacity: 0.6;">${time}</span>
                                </div>
                                <div style="font-size: 13px; line-height: 1.4;">${act.description}</div>
                                ${act.old_value != null && act.new_value != null ? `
                                    <div style="font-size: 11px; opacity: 0.6; margin-top: 4px;">
                                        ${parseFloat(act.old_value).toFixed(1)} ‚Üí ${parseFloat(act.new_value).toFixed(1)} ${act.unit || ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            content.innerHTML = html || '<p style="text-align: center; opacity: 0.7;">Keine Aktivit√§ten</p>';
        }

        function getActivityIcon(type) {
            const icons = {
                'cron_consumption': '‚è∞',
                'user_update': '‚úèÔ∏è',
                'user_fill': '‚¨ÜÔ∏è',
                'user_empty': '‚¨áÔ∏è',
                'user_set': 'üéØ',
                'system': 'üîß'
            };
            return icons[type] || 'üìù';
        }

        function getActivityTypeLabel(type) {
            const labels = {
                'cron_consumption': 'Auto',
                'user_update': 'Anpassung',
                'user_fill': 'Gef√ºllt',
                'user_empty': 'Geleert',
                'user_set': 'Gesetzt',
                'system': 'System'
            };
            return labels[type] || type;
        }

        function getActivityTypeColor(type) {
            const colors = {
                'cron_consumption': 'rgba(156, 39, 176, 0.3)',
                'user_update': 'rgba(33, 150, 243, 0.3)',
                'user_fill': 'rgba(76, 175, 80, 0.3)',
                'user_empty': 'rgba(255, 152, 0, 0.3)',
                'user_set': 'rgba(0, 188, 212, 0.3)',
                'system': 'rgba(158, 158, 158, 0.3)'
            };
            return colors[type] || 'rgba(255,255,255,0.1)';
        }

        function closeActivityLogModal() {
            document.getElementById('activityLogModal').classList.remove('active');
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('loginState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'none';
            document.getElementById('dashboardState').style.display = 'none';
            document.getElementById('setupScreen').classList.remove('active');
        }

        function showNoVehicle() {
            hideSplash();
            document.getElementById('mainHeader').style.display = 'flex';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'block';
            document.getElementById('dashboardState').style.display = 'none';
            document.getElementById('setupScreen').classList.remove('active');
        }

        function showDashboard() {
            hideSplash();
            document.getElementById('mainHeader').style.display = 'flex';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'none';
            document.getElementById('dashboardState').style.display = 'block';
            document.getElementById('setupScreen').classList.remove('active');
            // Auto-Refresh und Pull-to-Refresh starten
            previousLevels = currentLevels ? { ...currentLevels } : null;
            startAutoRefresh();
            initPullToRefresh();
        }

        function showSetup() {
            document.getElementById('mainHeader').style.display = 'flex';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('loginState').style.display = 'none';
            document.getElementById('noVehicleState').style.display = 'none';
            document.getElementById('dashboardState').style.display = 'none';
            document.getElementById('setupScreen').classList.add('active');
            renderCategoryToggles();
            renderResourceDetails();
            if (currentVehicle) setTimeout(prefillSetup, 50);
        }

        function cancelSetup() {
            if (currentVehicle) showDashboard();
            else showNoVehicle();
        }

        function switchSetupTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('categoriesTab').style.display = tab === 'categories' ? 'block' : 'none';
            document.getElementById('detailsTab').style.display = tab === 'details' ? 'block' : 'none';
            if (tab === 'details') renderResourceDetails();
        }

        function renderCategoryToggles() {
            const container = document.getElementById('categoryToggles');
            container.innerHTML = '';
            for (const [key, config] of Object.entries(RESOURCE_CONFIG)) {
                const checked = enabledResources.includes(key) ? 'checked' : '';
                container.innerHTML += `
                    <label class="category-toggle">
                        <input type="checkbox" id="toggle_${key}" ${checked} onchange="toggleCategory('${key}')">
                        <span class="category-toggle-icon">${config.icon}</span>
                        <span class="category-toggle-label">${getResourceName(key)}</span>
                    </label>
                `;
            }
        }

        function toggleCategory(key) {
            const checked = document.getElementById(`toggle_${key}`).checked;
            if (checked && !enabledResources.includes(key)) enabledResources.push(key);
            else if (!checked) enabledResources = enabledResources.filter(r => r !== key);
            renderResourceDetails();
        }

        function renderResourceDetails() {
            const container = document.getElementById('resourceDetails');
            container.innerHTML = '';
            let resourceIndex = 0;
            for (const key of enabledResources) {
                // Ad-Banner nach der 2. Ressource (z.B. nach Batterie)
                if (resourceIndex === 2 && !isPremium) {
                    container.innerHTML += `
                        <div class="ad-container ad-banner" style="margin: 16px 0;">
                            <div class="ad-label">Anzeige</div>
                            <div class="ad-demo-text">üì¢ Google AdSense Banner</div>
                            <div class="ad-demo-size">320x100 (Large Mobile Banner)</div>
                        </div>
                    `;
                }
                resourceIndex++;
                const config = RESOURCE_CONFIG[key];
                
                if (key === 'toilet') {
                    const savedType = currentVehicle?.toilet_type || 'ttt';
                    container.innerHTML += `
                        <div class="setup-section">
                            <div class="setup-section-title">${config.icon} ${getResourceName(key)}</div>
                            <div class="form-group">
                                <label class="form-label">Toiletten-Typ</label>
                                <select class="form-input" id="setup_toiletType" onchange="updateToiletFields()">
                                    <option value="ttt" ${savedType === 'ttt' ? 'selected' : ''}>Trockentrenntoilette (TTT)</option>
                                    <option value="clesana" ${savedType === 'clesana' ? 'selected' : ''}>Clesana (T√ºten-System)</option>
                                    <option value="chemical" ${savedType === 'chemical' ? 'selected' : ''}>Chemie-Toilette</option>
                                </select>
                            </div>
                            <div id="toiletTypeFields"></div>
                        </div>
                    `;
                    setTimeout(updateToiletFields, 0);
                } else if (key === 'power') {
                    const capValue = currentVehicle?.[toSnakeCase(config.capacityField)] || '';
                    const conValue = currentVehicle?.[toSnakeCase(config.consumptionField)] || '';
                    container.innerHTML += `
                        <div class="setup-section">
                            <div class="setup-section-title">${config.icon} ${getResourceName(key)}</div>
                            <div class="input-row">
                                <div class="form-group">
                                    <label class="form-label">Kapazit√§t (${config.unit})</label>
                                    <input type="number" class="form-input" id="setup_${config.capacityField}" placeholder="z.B. 100" step="0.1" value="${capValue}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Verbrauch/Tag (calc)</label>
                                    <input type="number" class="form-input" id="setup_${config.consumptionField}" placeholder="aus Verbrauchern" step="0.1" readonly style="opacity:0.7;" value="${conValue}">
                                </div>
                            </div>
                            
                            <div style="margin-top:16px;padding:12px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:8px;">
                                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                    <span style="font-size:20px;">‚òÄÔ∏è</span>
                                    <label class="form-label" style="margin:0;font-weight:600;">Solar-Anlage</label>
                                </div>
                                <div class="input-row">
                                    <div class="form-group">
                                        <label class="form-label">Solar-Leistung (Wp)</label>
                                        <input type="number" class="form-input" id="setup_solarPower" placeholder="z.B. 200" step="1" value="${currentVehicle?.solar_power || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ertrag/Tag (Ah)</label>
                                        <input type="number" class="form-input" id="setup_solarYield" placeholder="gesch√§tzt" readonly style="opacity:0.7;">
                                    </div>
                                </div>
                                <div style="margin-top:16px; padding:12px; background:rgba(0,0,0,0.2); border-radius:10px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                        <label class="form-label" style="margin:0;">üìç Standort f√ºr Wetterprognose</label>
                                        <button type="button" class="btn btn-secondary" onclick="requestLocation()" style="padding:6px 12px;font-size:12px;" id="locationBtn">üìç Aktualisieren</button>
                                    </div>
                                    <div id="locationInfo" style="padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;">
                                        <div id="locationName" style="font-weight:600;font-size:14px;margin-bottom:4px;">Kein Standort</div>
                                        <div id="locationCoords" style="font-size:11px;opacity:0.6;"></div>
                                    </div>
                                    <div id="solarForecast" style="margin-top:10px;display:none;"></div>
                                </div>
                            </div>
                            
                            <div style="margin-top:12px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                    <label class="form-label" style="margin:0;">Verbraucher</label>
                                    <span id="setupConsumersTotal" style="font-size:12px;opacity:0.7;">0 Ah/Tag</span>
                                </div>
                                <div id="setupConsumersList" style="max-height:150px;overflow-y:auto;margin-bottom:8px;"></div>
                                <div class="input-row" style="gap:8px;">
                                    <input type="text" class="form-input" id="setupNewConsumerName" placeholder="z.B. K√ºhlschrank" style="flex:2;">
                                    <input type="number" class="form-input" id="setupNewConsumerAh" placeholder="Ah/Tag" step="0.1" style="flex:1;">
                                    <button type="button" class="btn btn-secondary" onclick="addSetupConsumer()" style="padding:8px 12px;">+</button>
                                </div>
                                <div id="setupConsumersSummary" style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.3);border-radius:8px;font-size:13px;"></div>
                            </div>
                        </div>
                    `;
                    setTimeout(loadSetupConsumers, 0);
                    setTimeout(loadSolarData, 0);
                } else if (key === 'fuel') {
                    const capValue = currentVehicle?.fuel_tank_capacity || '';
                    const conValue = currentVehicle?.fuel_consumption || '';
                    container.innerHTML += `
                        <div class="setup-section">
                            <div class="setup-section-title">${config.icon} ${getResourceName(key)}</div>
                            <div class="input-row">
                                <div class="form-group">
                                    <label class="form-label">Tankgr√∂√üe (L)</label>
                                    <input type="number" class="form-input" id="setup_fuelTankCapacity" placeholder="z.B. 100" step="1" value="${capValue}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">L/100km</label>
                                    <input type="number" class="form-input" id="setup_fuelConsumption" placeholder="z.B. 12" step="0.1" value="${conValue}">
                                </div>
                            </div>
                        </div>
                    `;
                } else if (key === 'greywater') {
                    const capValue = currentVehicle?.grey_water_capacity || '';
                    const linkEnabled = currentVehicle?.greywater_linked_to_water ?? true;
                    const linkFactor = currentVehicle?.greywater_link_factor || 90;
                    container.innerHTML += `
                        <div class="setup-section">
                            <div class="setup-section-title">${config.icon} ${getResourceName(key)}</div>
                            <div class="form-group">
                                <label class="form-label">Kapazit√§t (${config.unit})</label>
                                <input type="number" class="form-input" id="setup_${config.capacityField}" placeholder="z.B. 100" step="0.1" value="${capValue}">
                            </div>
                            <div style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;">
                                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                                    <input type="checkbox" id="setup_greywaterLinked" ${linkEnabled ? 'checked' : ''} onchange="toggleGreywaterLink()">
                                    <span>Mit Wasserverbrauch koppeln</span>
                                </label>
                                <div id="greywaterLinkOptions" style="margin-top:10px;${linkEnabled ? '' : 'display:none;'}">
                                    <div style="display:flex;align-items:center;gap:10px;">
                                        <input type="range" id="setup_greywaterFactor" min="50" max="100" value="${linkFactor}" class="filled-slider" style="flex:1;background:linear-gradient(to right, #f1c40f 0%, #f1c40f ${(linkFactor-50)/50*100}%, rgba(255,255,255,0.2) ${(linkFactor-50)/50*100}%, rgba(255,255,255,0.2) 100%);" oninput="document.getElementById('greywaterFactorValue').textContent = this.value + '%'; updateSliderFill(this)">
                                        <span id="greywaterFactorValue" style="min-width:40px;font-weight:600;">${linkFactor}%</span>
                                    </div>
                                    <div style="font-size:11px;opacity:0.6;margin-top:4px;">Anteil des Wasserverbrauchs der ins Abwasser geht</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const capValue = currentVehicle?.[toSnakeCase(config.capacityField)] || '';
                    const conValue = config.consumptionField ? (currentVehicle?.[toSnakeCase(config.consumptionField)] || '') : '';
                    container.innerHTML += `
                        <div class="setup-section">
                            <div class="setup-section-title">${config.icon} ${getResourceName(key)}</div>
                            <div class="input-row">
                                <div class="form-group">
                                    <label class="form-label">Kapazit√§t (${config.unit})</label>
                                    <input type="number" class="form-input" id="setup_${config.capacityField}" placeholder="z.B. 100" step="0.1" value="${capValue}">
                                </div>
                                ${config.consumptionField ? `
                                <div class="form-group">
                                    <label class="form-label">pro Person/Tag</label>
                                    <input type="number" class="form-input" id="setup_${config.consumptionField}" placeholder="z.B. 15" step="0.1" value="${conValue}">
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }
        }

        function updateToiletFields() {
            const type = document.getElementById('setup_toiletType')?.value || 'ttt';
            const container = document.getElementById('toiletTypeFields');
            if (!container) return;
            
            if (type === 'ttt') {
                const solidIgnore = currentVehicle?.ttt_solid_ignore_autarky ?? false;
                const liquidIgnore = currentVehicle?.ttt_liquid_ignore_autarky ?? false;
                container.innerHTML = `
                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Feststoff-Tank (L)</label>
                            <input type="number" class="form-input" id="setup_tttSolidCapacity" placeholder="z.B. 10" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pipi-Tank (L)</label>
                            <input type="number" class="form-input" id="setup_tttLiquidCapacity" placeholder="z.B. 10" step="1">
                        </div>
                    </div>
                    <div style="margin-top:12px;padding:12px;background:rgba(76,175,80,0.15);border:1px solid rgba(76,175,80,0.3);border-radius:8px;">
                        <div style="font-size:13px;font-weight:600;margin-bottom:8px;">üåø Nat√ºrliche Entsorgung m√∂glich</div>
                        <div style="font-size:11px;opacity:0.8;margin-bottom:10px;">Markiere Tanks die nicht die Autarkie einschr√§nken, weil sie naturnah entsorgt werden k√∂nnen.</div>
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:8px;">
                            <input type="checkbox" id="setup_tttLiquidIgnore" ${liquidIgnore ? 'checked' : ''} style="width:18px;height:18px;">
                            <span style="font-size:13px;">üíß Pipi-Tank ignorieren <span style="opacity:0.6;font-size:11px;">(kann in Natur entleert werden)</span></span>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                            <input type="checkbox" id="setup_tttSolidIgnore" ${solidIgnore ? 'checked' : ''} style="width:18px;height:18px;">
                            <span style="font-size:13px;">üí© Feststoff ignorieren <span style="opacity:0.6;font-size:11px;">(mit Kokos vergraben)</span></span>
                        </label>
                    </div>
                `;
            } else if (type === 'clesana') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Anzahl T√ºten</label>
                        <input type="number" class="form-input" id="setup_clesanaBagsCapacity" placeholder="z.B. 50" step="1">
                    </div>
                `;
            } else if (type === 'chemical') {
                container.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Tank-Kapazit√§t (L)</label>
                        <input type="number" class="form-input" id="setup_chemicalTankCapacity" placeholder="z.B. 20" step="1">
                    </div>
                `;
            }
            
            if (currentVehicle) prefillToiletFields();
        }

        function toggleGreywaterLink() {
            const checkbox = document.getElementById('setup_greywaterLinked');
            const options = document.getElementById('greywaterLinkOptions');
            if (options) options.style.display = checkbox?.checked ? 'block' : 'none';
            // Slider-Fill beim √ñffnen aktualisieren
            const slider = document.getElementById('setup_greywaterFactor');
            if (slider) setTimeout(() => updateSliderFill(slider), 50);
        }
        
        function updateSliderFill(slider) {
            const min = parseFloat(slider.min) || 0;
            const max = parseFloat(slider.max) || 100;
            const val = parseFloat(slider.value) || 0;
            const pct = ((val - min) / (max - min)) * 100;
            slider.style.background = `linear-gradient(to right, #f1c40f 0%, #f1c40f ${pct}%, rgba(255,255,255,0.2) ${pct}%, rgba(255,255,255,0.2) 100%)`;
        }

        function prefillToiletFields() {
            const type = document.getElementById('setup_toiletType')?.value;
            if (type === 'ttt') {
                const solid = document.getElementById('setup_tttSolidCapacity');
                const liquid = document.getElementById('setup_tttLiquidCapacity');
                if (solid && currentVehicle.ttt_solid_capacity) solid.value = currentVehicle.ttt_solid_capacity;
                if (liquid && currentVehicle.ttt_liquid_capacity) liquid.value = currentVehicle.ttt_liquid_capacity;
            } else if (type === 'clesana') {
                const bags = document.getElementById('setup_clesanaBagsCapacity');
                if (bags && currentVehicle.clesana_bags_capacity) bags.value = currentVehicle.clesana_bags_capacity;
            } else if (type === 'chemical') {
                const tank = document.getElementById('setup_chemicalTankCapacity');
                if (tank && currentVehicle.chemical_tank_capacity) tank.value = currentVehicle.chemical_tank_capacity;
            }
        }

        function prefillSetup() {
            document.getElementById('setupName').value = currentVehicle.name || '';
            document.getElementById('setupPersonCount').value = currentVehicle.person_count || 2;
            for (const key of enabledResources) {
                const config = RESOURCE_CONFIG[key];
                const capEl = document.getElementById(`setup_${config.capacityField}`);
                const conEl = config.consumptionField ? document.getElementById(`setup_${config.consumptionField}`) : null;
                if (capEl && currentVehicle[toSnakeCase(config.capacityField)]) capEl.value = currentVehicle[toSnakeCase(config.capacityField)];
                if (conEl && currentVehicle[toSnakeCase(config.consumptionField)]) conEl.value = currentVehicle[toSnakeCase(config.consumptionField)];
            }
            if (currentVehicle.toilet_type) {
                const el = document.getElementById('setup_toiletType');
                if (el) el.value = currentVehicle.toilet_type;
            }
        }

        function toSnakeCase(str) { return str.replace(/([A-Z])/g, '_$1').toLowerCase(); }

        async function updateAutarkyDashboard() {
            if (!currentVehicle || !currentLevels) return;
            
            const resourceDays = [];
            
            // Standard-Ressourcen sammeln (nur die mit Tages-Verbrauch)
            for (const key of enabledResources) {
                const config = RESOURCE_CONFIG[key];
                if (key === 'greywater') continue; // Abwasser ausschlie√üen (hat keine Autarkie-Relevanz)
                if (key === 'fuel') continue; // Fuel hat km statt Tage
                
                let days = null;
                if (key === 'toilet') {
                    const toiletType = currentVehicle.toilet_type || 'ttt';
                    if (toiletType === 'ttt') {
                        const solidDays = currentLevels.ttt_solid_days;
                        const liquidDays = currentLevels.ttt_liquid_days;
                        const solidIgnore = currentVehicle.ttt_solid_ignore_autarky || false;
                        const liquidIgnore = currentVehicle.ttt_liquid_ignore_autarky || false;
                        
                        // Nur nicht-ignorierte Tanks in Berechnung einbeziehen
                        const relevantDays = [];
                        if (!solidIgnore && solidDays != null) relevantDays.push(solidDays);
                        if (!liquidIgnore && liquidDays != null) relevantDays.push(liquidDays);
                        
                        if (relevantDays.length > 0) {
                            days = Math.min(...relevantDays);
                        } else if (solidIgnore && liquidIgnore) {
                            // Beide ignoriert = keine Einschr√§nkung durch Toilette
                            days = null;
                        }
                    } else if (toiletType === 'clesana') {
                        days = currentLevels.clesana_days;
                    } else if (toiletType === 'chemical') {
                        days = currentLevels.chemical_days;
                    }
                    if (days != null) {
                        resourceDays.push({ key, icon: 'üöΩ', name: 'Toilette', days: parseFloat(days) });
                    }
                } else {
                    const remainField = `${key}_days_remaining`;
                    days = currentLevels[remainField];
                    if (days != null) {
                        resourceDays.push({ key, icon: config.icon, name: getResourceName(key), days: parseFloat(days) });
                    }
                }
            }
            
            // Custom Resources hinzuf√ºgen
            try {
                const customRes = await fetchAPI(`/custom-resources/${currentVehicle.id}`);
                if (customRes && customRes.length > 0) {
                    const personCount = currentVehicle.person_count || 2;
                    for (const r of customRes) {
                        if (r.is_inverted) continue;
                        const totalConsumption = r.consumption_per_day ? r.consumption_per_day * personCount : null;
                        if (totalConsumption && r.current_level) {
                            const days = r.current_level / totalConsumption;
                            resourceDays.push({ key: `custom_${r.id}`, icon: r.icon, name: r.name, days: parseFloat(days.toFixed(1)) });
                        }
                    }
                }
            } catch (e) {}
            
            // Nach Tagen sortieren (aufsteigend = kritischste zuerst)
            resourceDays.sort((a, b) => a.days - b.days);
            
            // Dashboard aktualisieren
            const daysEl = document.getElementById('autarkyDays');
            const bottleneckTextEl = document.getElementById('autarkyBottleneckText');
            const criticalListEl = document.getElementById('autarkyCriticalList');
            
            if (resourceDays.length === 0) {
                daysEl.textContent = '--';
                daysEl.className = 'autarky-days';
                bottleneckTextEl.textContent = 'Keine Verbrauchsdaten';
                criticalListEl.innerHTML = '';
                return;
            }
            
            // Minimale Tage = Bottleneck
            const minDays = resourceDays[0].days;
            const bottleneck = resourceDays[0];
            
            // Animation f√ºr Z√§hler
            const currentDays = parseInt(daysEl.textContent) || 0;
            const targetDays = Math.floor(minDays);
            const diff = targetDays - currentDays;
            const steps = Math.abs(diff);
            const duration = 500; // ms
            const stepDuration = duration / steps;
            
            if (diff !== 0) {
                let step = 0;
                const interval = setInterval(() => {
                    step++;
                    if (diff > 0) {
                        daysEl.textContent = currentDays + step;
                    } else {
                        daysEl.textContent = currentDays - step;
                    }
                    if (step >= steps) {
                        clearInterval(interval);
                        daysEl.textContent = targetDays;
                    }
                }, stepDuration);
            } else {
                daysEl.textContent = targetDays;
            }
            daysEl.className = 'autarky-days' + (minDays < 2 ? ' critical' : minDays < 5 ? ' warning' : '');
            
            bottleneckTextEl.innerHTML = `<strong>${bottleneck.icon} ${bottleneck.name}</strong> begrenzt auf ~${bottleneck.days.toFixed(1)} Tage`;
            
            // Top 3 kritischste Ressourcen anzeigen
            const top3 = resourceDays.slice(0, 3);
            criticalListEl.innerHTML = top3.map(r => {
                const statusClass = r.days < 2 ? 'critical' : r.days < 5 ? 'warning' : '';
                return `
                    <div class="autarky-critical-item ${statusClass}">
                        <span>${r.icon}</span>
                        <span>${r.name}</span>
                        <span class="autarky-critical-days">~${r.days.toFixed(1)} Tage</span>
                    </div>
                `;
            }).join('');
        }

        let isUpdatingUI = false;
        async function updateUI() {
            if (!currentVehicle || !currentLevels) return;
            if (isUpdatingUI) return; // Verhindere parallele Aufrufe
            isUpdatingUI = true;
            
            try {
                document.getElementById('vehicleName').textContent = currentVehicle.name || 'Mein Fahrzeug';
                
                // Z√§hle auch Custom Resources
                let customCount = 0;
                try {
                    const customRes = await fetchAPI(`/custom-resources/${currentVehicle.id}`);
                    customCount = customRes?.length || 0;
                } catch (e) {}
                const totalResources = enabledResources.length + customCount;
                const personCount = currentVehicle.person_count || 2;
                document.getElementById('vehicleDetails').textContent = `${personCount} Personen ‚Ä¢ ${totalResources} Ressourcen`;
                
                await updateAutarkyDashboard();
                await renderResourceCards();
                renderQuickActions();
            } finally {
                isUpdatingUI = false;
            }
        }

        async function renderResourceCards() {
            const grid = document.getElementById('resourcesGrid');
            grid.innerHTML = '';
            
            // Gespeicherte oder optimierte Reihenfolge
            let sortedResources;
            if (customResourceOrder && customResourceOrder.length > 0) {
                // Gespeicherte Reihenfolge verwenden, neue Ressourcen am Ende
                sortedResources = [...customResourceOrder.filter(r => enabledResources.includes(r))];
                enabledResources.forEach(r => { if (!sortedResources.includes(r)) sortedResources.push(r); });
            } else {
                // Standard: Wasser zuerst, dann Power (span-2), dann Grauwasser
                sortedResources = [...enabledResources].sort((a, b) => {
                    const order = { water: 0, power: 1, greywater: 2 };
                    return (order[a] ?? 99) - (order[b] ?? 99);
                });
            }
            
            for (const key of sortedResources) {
                if (key === 'toilet') {
                    renderToiletCard(grid);
                    continue;
                }
                if (key === 'power') {
                    await renderPowerCard(grid);
                    continue;
                }
                const config = RESOURCE_CONFIG[key];
                const levelField = `${key}_level`;
                const pctField = `${key}_percentage`;
                const remainField = key === 'fuel' ? 'fuel_km_remaining' : `${key}_days_remaining`;
                let level = parseFloat(currentLevels[levelField]) || 0;
                const pct = parseFloat(currentLevels[pctField]) || 0;
                const remaining = currentLevels[remainField];
                const capacity = currentVehicle[toSnakeCase(config.capacityField)] || 0;
                // Fix: Berechne Level aus Percentage wenn Level 0 oder Level > Kapazit√§t (falsch gespeichert)
                if ((level === 0 || level > capacity) && pct > 0 && capacity > 0) {
                    level = capacity * pct / 100;
                }
                // Fix: Berechne km-Remaining f√ºr Fuel wenn nicht vorhanden
                let calcRemaining = remaining;
                if (key === 'fuel' && (remaining == null || remaining === 0) && level > 0) {
                    const consumption = currentVehicle.fuel_consumption || currentVehicle.fuel_consumption_onroad || 12;
                    calcRemaining = Math.round(level / consumption * 100);
                }
                let statusClass = '';
                if (config.inverted) {
                    if (pct > 80) statusClass = 'critical inverted';
                    else if (pct > 60) statusClass = 'warning inverted';
                } else {
                    if (pct < 20) statusClass = 'critical';
                    else if (pct < 40) statusClass = 'warning';
                }
                // F√ºr food/drinks mit Unit "Tage" ist Kapazit√§t * Prozent = verbleibende Tage
                let remainingText = '--';
                if (config.unit === 'Tage') {
                    const daysRemaining = Math.round(capacity * pct / 100);
                    remainingText = `~${daysRemaining} Tage`;
                } else if (key === 'fuel') {
                    remainingText = calcRemaining != null ? `~${calcRemaining} km` : '--';
                } else if (calcRemaining != null) {
                    remainingText = `~${calcRemaining} Tage`;
                }
                
                // Verbraucht-Button f√ºr Getr√§nke und Proviant
                let consumeBtn = '';
                if (key === 'drinks') {
                    consumeBtn = `<button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;margin-top:8px;width:100%;" onclick="event.stopPropagation(); consumeResource('drinks', 0.5)">ü•§ Getrunken (-0.5L)</button>`;
                } else if (key === 'food') {
                    consumeBtn = `<button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;margin-top:8px;width:100%;" onclick="event.stopPropagation(); consumeResource('food', 1)">üçΩÔ∏è Tag vorbei (-1)</button>`;
                }
                
                grid.innerHTML += `
                    <div class="resource-card ${statusClass}" data-resource="${key}" onclick="openResourceModal('${key}')" style="position:relative;">
                        <div class="resource-header">
                            <span class="resource-icon">${config.icon}</span>
                            <span class="resource-percentage">${Math.round(pct)}%</span>
                        </div>
                        <div class="resource-name">${getResourceName(key)}</div>
                        <div class="resource-bar-bg">
                            <div class="resource-bar ${key}" style="width: ${pct}%"></div>
                        </div>
                        <div class="resource-remaining">${remainingText}</div>
                        <div class="resource-value">${config.unit === 'kg' ? level.toFixed(1) : Math.round(level)} / ${capacity} ${config.unit}</div>
                        ${consumeBtn}
                    </div>
                `;
            }
            
            // Custom Resources laden und anzeigen
            try {
                const customRes = await fetchAPI(`/custom-resources/${currentVehicle.id}`);
                if (customRes && customRes.length > 0) {
                    for (const r of customRes) {
                        const pct = r.current_percentage || 0;
                        let statusClass = '';
                        if (r.is_inverted) {
                            if (pct > 80) statusClass = 'critical inverted';
                            else if (pct > 60) statusClass = 'warning inverted';
                        } else {
                            if (pct < 20) statusClass = 'critical';
                            else if (pct < 40) statusClass = 'warning';
                        }
                        const customPersonCount = currentVehicle.person_count || 2;
                        const customTotalConsumption = r.consumption_per_day ? r.consumption_per_day * customPersonCount : null;
                        const daysRemaining = customTotalConsumption ? (r.current_level / customTotalConsumption).toFixed(1) : null;
                        grid.innerHTML += `
                            <div class="resource-card ${statusClass}" data-resource="custom-${r.id}" onclick="openCustomResourcesModal()" style="position:relative;">
                                <div class="resource-header">
                                    <span class="resource-icon">${r.icon}</span>
                                    <span class="resource-percentage">${Math.round(pct)}%</span>
                                </div>
                                <div class="resource-name">${r.name}</div>
                                <div class="resource-bar-bg">
                                    <div class="resource-bar" style="width: ${pct}%; background: #9b59b6;"></div>
                                </div>
                                <div class="resource-remaining">${daysRemaining ? `~${daysRemaining} Tage` : '--'}</div>
                                <div class="resource-value">${Math.round(r.current_level || 0)} / ${r.capacity} ${r.unit}</div>
                            </div>
                        `;
                    }
                }
            } catch (e) { /* Custom resources not loaded */ }
            
            // Button zum Hinzuf√ºgen neuer Custom Resources
            grid.innerHTML += `
                <div class="resource-card" onclick="openCustomResourcesModal()" style="display:flex;align-items:center;justify-content:center;border:2px dashed rgba(255,255,255,0.3);background:transparent;cursor:pointer;">
                    <div style="text-align:center;">
                        <div style="font-size:32px;opacity:0.5;">‚ûï</div>
                        <div style="font-size:12px;opacity:0.7;">Eigene Ressource</div>
                    </div>
                </div>
            `;
        }

        async function renderPowerCard(grid) {
            const config = RESOURCE_CONFIG.power;
            const level = currentLevels.power_level || 0;
            const pct = currentLevels.power_percentage || 0;
            const remaining = currentLevels.power_days_remaining;
            const capacity = currentVehicle.battery_capacity || 0;
            let statusClass = pct < 20 ? 'critical' : pct < 40 ? 'warning' : '';
            const remainingText = remaining != null ? `~${remaining} Tage` : '--';
            
            // Verbraucher laden
            let consumersHtml = '';
            let totalConsumption = 0;
            try {
                const data = await fetchAPI(`/consumers/${currentVehicle.id}`);
                const consumersList = data?.consumers || [];
                const activeConsumers = consumersList.filter(c => c.is_active);
                totalConsumption = activeConsumers.reduce((sum, c) => sum + parseFloat(c.consumption_ah || 0), 0);
                
                if (consumersList.length > 0) {
                    consumersHtml = `
                        <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.1);padding-top:8px;">
                            <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px;">
                                <span style="opacity:0.7;">‚ö° Verbrauch</span>
                                <span style="color:#ff7b7b;">-${totalConsumption.toFixed(1)} Ah/Tag</span>
                            </div>
                            <div style="max-height:60px;overflow-y:auto;font-size:11px;">
                                ${consumersList.slice(0, 3).map(c => `
                                    <div style="display:flex;align-items:center;gap:4px;padding:2px 0;opacity:${c.is_active ? 1 : 0.5};">
                                        <span>${c.is_active ? '‚úÖ' : '‚¨ú'}</span>
                                        <span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</span>
                                        <span>${c.consumption_ah} Ah</span>
                                    </div>
                                `).join('')}
                                ${consumersList.length > 3 ? `<div style="opacity:0.5;text-align:center;">+${consumersList.length - 3} weitere</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            } catch (e) { /* Verbraucher nicht geladen */ }
            
            // Solar-Ertrag berechnen
            let solarHtml = '';
            const solarWp = currentVehicle.solar_power || 0;
            if (solarWp > 0) {
                let estimatedSolarAh = 0;
                let solarStatus = '‚òÄÔ∏è';
                
                if (userLocation && weatherData?.daily) {
                    const sunshineHours = (weatherData.daily.sunshine_duration?.[0] || 0) / 3600;
                    const efficiency = 0.7;
                    const voltage = 12;
                    estimatedSolarAh = (solarWp * sunshineHours * efficiency * 0.15) / voltage;
                    const code = weatherData.daily.weathercode?.[0] || 0;
                    if (code >= 61) solarStatus = 'üåßÔ∏è';
                    else if (code >= 45) solarStatus = 'üå´Ô∏è';
                    else if (code >= 3) solarStatus = '‚òÅÔ∏è';
                    else if (code >= 1) solarStatus = '‚õÖ';
                } else {
                    // Fallback ohne Wetterdaten: ~4h Sonne angenommen
                    estimatedSolarAh = (solarWp * 4 * 0.7 * 0.15) / 12;
                }
                
                const netBalance = estimatedSolarAh - totalConsumption;
                const balanceColor = netBalance >= 0 ? '#4CAF50' : '#ff7b7b';
                const balanceSign = netBalance >= 0 ? '+' : '';
                
                solarHtml = `
                    <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.1);padding-top:8px;">
                        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px;">
                            <span style="opacity:0.7;">${solarStatus} Solar (${solarWp}Wp)</span>
                            <span style="color:#4CAF50;">+${estimatedSolarAh.toFixed(1)} Ah/Tag</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:12px;font-weight:600;padding:4px 8px;background:rgba(0,0,0,0.2);border-radius:4px;">
                            <span>Bilanz</span>
                            <span style="color:${balanceColor};">${balanceSign}${netBalance.toFixed(1)} Ah/Tag</span>
                        </div>
                    </div>
                `;
            }
            
            // Nur span-2 wenn Verbraucher oder Solar vorhanden
            const hasExtras = consumersHtml || solarHtml;
            const spanClass = hasExtras ? 'span-2' : '';
            
            grid.innerHTML += `
                <div class="resource-card ${spanClass} ${statusClass}" data-resource="power" onclick="openResourceModal('power')" style="position:relative;">
                    <div class="resource-header">
                        <span class="resource-icon">${config.icon}</span>
                        <span class="resource-percentage">${Math.round(pct)}%</span>
                    </div>
                    <div class="resource-name">${getResourceName('power')}</div>
                    <div class="resource-bar-bg">
                        <div class="resource-bar power" style="width: ${pct}%"></div>
                    </div>
                    <div class="resource-remaining">${remainingText}</div>
                    <div class="resource-value">${Math.round(level)} / ${capacity} ${config.unit}</div>
                    ${consumersHtml}
                    ${solarHtml}
                </div>
            `;
        }

        function renderWaterCard(grid) {
            // Frischwasser
            const waterLevel = currentLevels.water_level || 0;
            const waterPct = currentLevels.water_percentage || 0;
            const waterDays = currentLevels.water_days_remaining;
            const waterCap = currentVehicle.fresh_water_capacity || 0;
            
            // Grauwasser
            const greyLevel = currentLevels.greywater_level || 0;
            const greyPct = currentLevels.greywater_percentage || 0;
            const greyCap = currentVehicle.grey_water_capacity || 0;
            
            // Status f√ºr Frischwasser (normal)
            let waterStatus = waterPct < 20 ? 'critical' : waterPct < 40 ? 'warning' : '';
            // Status f√ºr Grauwasser (inverted - voll = schlecht)
            let greyStatus = greyPct > 80 ? 'critical' : greyPct > 60 ? 'warning' : '';
            
            grid.innerHTML += `
                <div class="resource-card" style="position:relative;display:flex;flex-direction:column;gap:12px;">
                    <!-- Frischwasser -->
                    <div onclick="openResourceModal('water')" style="cursor:pointer;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <div style="display:flex;align-items:center;gap:6px;">
                                <span style="font-size:18px;">üíß</span>
                                <span style="font-weight:600;">Frischwasser</span>
                            </div>
                            <span style="font-size:20px;font-weight:700;color:${waterStatus === 'critical' ? '#ff7b7b' : waterStatus === 'warning' ? '#f39c12' : '#fff'};">${Math.round(waterPct)}%</span>
                        </div>
                        <div class="resource-bar-bg"><div class="resource-bar water" style="width:${waterPct}%"></div></div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px;opacity:0.7;">
                            <span>${waterDays != null ? `~${waterDays} Tage` : '--'}</span>
                            <span>${Math.round(waterLevel)} / ${waterCap} L</span>
                        </div>
                    </div>
                    <!-- Grauwasser -->
                    <div onclick="openResourceModal('greywater')" style="cursor:pointer;border-top:1px solid rgba(255,255,255,0.1);padding-top:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <div style="display:flex;align-items:center;gap:6px;">
                                <span style="font-size:18px;">üöø</span>
                                <span style="font-weight:600;">Grauwasser</span>
                            </div>
                            <span style="font-size:20px;font-weight:700;color:${greyStatus === 'critical' ? '#ff7b7b' : greyStatus === 'warning' ? '#f39c12' : '#fff'};">${Math.round(greyPct)}%</span>
                        </div>
                        <div class="resource-bar-bg"><div class="resource-bar greywater" style="width:${greyPct}%"></div></div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px;opacity:0.7;">
                            <span>${greyPct > 80 ? '‚ö†Ô∏è Fast voll' : greyPct > 60 ? 'üî∂ Bald leeren' : '‚úì OK'}</span>
                            <span>${Math.round(greyLevel)} / ${greyCap} L</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderToiletCard(grid) {
            const toiletType = currentVehicle.toilet_type || 'ttt';
            
            if (toiletType === 'ttt') {
                const solidCap = currentVehicle.ttt_solid_capacity || 10;
                const liquidCap = currentVehicle.ttt_liquid_capacity || 10;
                const solidPct = currentLevels.ttt_solid_percentage || 0;
                const liquidPct = currentLevels.ttt_liquid_percentage || 0;
                const solidDays = currentLevels.ttt_solid_days ?? '--';
                const liquidDays = currentLevels.ttt_liquid_days ?? '--';
                const solidIgnore = currentVehicle.ttt_solid_ignore_autarky || false;
                const liquidIgnore = currentVehicle.ttt_liquid_ignore_autarky || false;
                const solidIgnoreStyle = solidIgnore ? 'opacity:0.5;' : '';
                const liquidIgnoreStyle = liquidIgnore ? 'opacity:0.5;' : '';
                const solidIgnoreBadge = solidIgnore ? '<span style="font-size:9px;background:rgba(76,175,80,0.3);padding:2px 4px;border-radius:4px;margin-left:4px;">üåø</span>' : '';
                const liquidIgnoreBadge = liquidIgnore ? '<span style="font-size:9px;background:rgba(76,175,80,0.3);padding:2px 4px;border-radius:4px;margin-left:4px;">üåø</span>' : '';
                grid.innerHTML += `
                    <div class="resource-card inverted span-2" data-resource="toilet" style="position:relative; grid-column: span 2;">
                        <div class="resource-header">
                            <span class="resource-icon">üöΩ</span>
                            <span class="resource-percentage">TTT</span>
                        </div>
                        <div class="resource-name" style="margin-bottom: 12px;">Trockentrenn-Toilette</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <!-- Feststoff-Bereich -->
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="font-size: 16px;">üí©</span>
                                        <span style="font-size: 12px; font-weight: 600;">Feststoffe</span>
                                    </div>
                                    <span style="font-size: 12px; font-weight: 700;">${Math.round(solidPct)}%</span>
                                </div>
                                <div class="resource-bar-bg" style="margin-bottom: 6px;"><div class="resource-bar toilet" style="width:${solidPct}%"></div></div>
                                <div style="display: flex; justify-content: space-between; font-size: 10px; opacity: 0.8; margin-bottom: 8px;">
                                    <span>${solidIgnore ? 'üåø Ignoriert' : '~' + solidDays + ' Tage'}</span>
                                    <span>${(solidPct * solidCap / 100).toFixed(1)} / ${solidCap} L</span>
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    <button style="flex: 1; padding: 8px; font-size: 12px; background: rgba(139,90,43,0.5); border: none; border-radius: 8px; color: #fff; font-weight: 600;" onclick="event.stopPropagation(); toiletUse('solid')">+1</button>
                                    <button style="padding: 8px 10px; font-size: 12px; background: rgba(76,175,80,0.4); border: none; border-radius: 8px; color: #fff;" onclick="event.stopPropagation(); quickToiletEmpty('solid')">üóëÔ∏è</button>
                                </div>
                            </div>
                            
                            <!-- Urin-Bereich -->
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="font-size: 16px;">üíß</span>
                                        <span style="font-size: 12px; font-weight: 600;">Urin</span>
                                    </div>
                                    <span style="font-size: 12px; font-weight: 700;">${Math.round(liquidPct)}%</span>
                                </div>
                                <div class="resource-bar-bg" style="margin-bottom: 6px;"><div class="resource-bar toilet" style="width:${liquidPct}%"></div></div>
                                <div style="display: flex; justify-content: space-between; font-size: 10px; opacity: 0.8; margin-bottom: 8px;">
                                    <span>${liquidIgnore ? 'üåø Ignoriert' : '~' + liquidDays + ' Tage'}</span>
                                    <span>${(liquidPct * liquidCap / 100).toFixed(1)} / ${liquidCap} L</span>
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    <button style="flex: 1; padding: 8px; font-size: 12px; background: rgba(52,152,219,0.5); border: none; border-radius: 8px; color: #fff; font-weight: 600;" onclick="event.stopPropagation(); toiletUse('liquid')">+1</button>
                                    <button style="padding: 8px 10px; font-size: 12px; background: rgba(76,175,80,0.4); border: none; border-radius: 8px; color: #fff;" onclick="event.stopPropagation(); quickToiletEmpty('liquid')">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (toiletType === 'clesana') {
                const bagsCap = currentVehicle.clesana_bags_capacity || 50;
                const bagsRemaining = currentLevels.clesana_bags_remaining ?? bagsCap;
                const pct = Math.round((bagsRemaining / bagsCap) * 100);
                const days = currentLevels.clesana_days ?? '--';
                grid.innerHTML += `
                    <div class="resource-card ${pct < 20 ? 'critical' : pct < 40 ? 'warning' : ''}" data-resource="toilet" style="position:relative;">
                        <div class="resource-header">
                            <span class="resource-icon">üöΩ</span>
                            <span class="resource-percentage">${bagsRemaining}</span>
                        </div>
                        <div class="resource-name">Clesana</div>
                        <div class="resource-bar-bg">
                            <div class="resource-bar toilet" style="width:${pct}%"></div>
                        </div>
                        <div class="resource-remaining">~${days} Tage</div>
                        <div class="resource-value">${bagsRemaining} / ${bagsCap} T√ºten</div>
                        <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;margin-top:8px;width:100%;" onclick="toiletUse('clesana')">üöΩ Benutzt (-1 T√ºte)</button>
                    </div>
                `;
            } else if (toiletType === 'chemical') {
                const tankCap = currentVehicle.chemical_tank_capacity || 20;
                const pct = parseFloat(currentLevels.chemical_percentage) || 0;
                const level = parseFloat(currentLevels.chemical_level) || 0;
                const days = currentLevels.chemical_days ?? '--';
                grid.innerHTML += `
                    <div class="resource-card inverted ${pct > 80 ? 'critical' : pct > 60 ? 'warning' : ''}" style="position:relative;">
                        <div class="resource-header">
                            <span class="resource-icon">üöΩ</span>
                            <span class="resource-percentage">${Math.round(pct)}%</span>
                        </div>
                        <div class="resource-name">Chemie-WC</div>
                        <div class="resource-bar-bg">
                            <div class="resource-bar toilet" style="width:${pct}%"></div>
                        </div>
                        <div class="resource-remaining">~${days} Tage</div>
                        <div class="resource-value">${Math.round(level)} / ${tankCap} L</div>
                        <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;margin-top:8px;width:100%;" onclick="toiletUse('chemical')">üöΩ Benutzt</button>
                    </div>
                `;
            }
        }

        async function consumeResource(resourceType, amount) {
            const scrollY = window.scrollY;
            try {
                const config = RESOURCE_CONFIG[resourceType];
                const levelField = `${resourceType}_level`;
                const currentLevel = parseFloat(currentLevels[levelField]) || 0;
                const capacity = currentVehicle[toSnakeCase(config.capacityField)] || 100;
                const newLevel = Math.max(currentLevel - amount, 0);
                
                const data = await fetchAPI('/resources/log', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, resourceType, action: 'set_level', amount: newLevel })
                });
                currentLevels = data.levels;
                await updateUI();
                requestAnimationFrame(() => window.scrollTo(0, scrollY));
            } catch (error) { console.error('Consume error:', error); }
        }

        async function toiletUse(type) {
            try {
                await fetchAPI('/resources/toilet-use', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, useType: type })
                });
                const data = await fetchAPI('/resources/current');
                if (data) {
                    currentLevels = data.levels;
                    updateToiletCardOnly();
                }
            } catch (error) { console.error('Toilet use error:', error); }
        }

        function updateToiletCardOnly() {
            const toiletCard = document.querySelector('[data-resource="toilet"]');
            if (!toiletCard || currentVehicle.toilet_type !== 'ttt') return;
            
            const solidCap = currentVehicle.ttt_solid_capacity || 10;
            const liquidCap = currentVehicle.ttt_liquid_capacity || 10;
            const solidPct = currentLevels.ttt_solid_percentage || 0;
            const liquidPct = currentLevels.ttt_liquid_percentage || 0;
            const solidDays = currentLevels.ttt_solid_days ?? '--';
            const liquidDays = currentLevels.ttt_liquid_days ?? '--';
            const solidIgnore = currentVehicle.ttt_solid_ignore_autarky || false;
            const liquidIgnore = currentVehicle.ttt_liquid_ignore_autarky || false;
            
            // Update Feststoffe
            const solidSection = toiletCard.querySelectorAll('[style*="background: rgba(255,255,255,0.1)"]')[0];
            if (solidSection) {
                solidSection.querySelector('[style*="font-weight: 700"]').textContent = `${Math.round(solidPct)}%`;
                solidSection.querySelector('.resource-bar').style.width = `${solidPct}%`;
                const infoRow = solidSection.querySelectorAll('span');
                if (infoRow.length >= 2) {
                    infoRow[infoRow.length - 2].textContent = solidIgnore ? 'üåø Ignoriert' : `~${solidDays} Tage`;
                    infoRow[infoRow.length - 1].textContent = `${(solidPct * solidCap / 100).toFixed(1)} / ${solidCap} L`;
                }
            }
            
            // Update Urin
            const liquidSection = toiletCard.querySelectorAll('[style*="background: rgba(255,255,255,0.1)"]')[1];
            if (liquidSection) {
                liquidSection.querySelector('[style*="font-weight: 700"]').textContent = `${Math.round(liquidPct)}%`;
                liquidSection.querySelector('.resource-bar').style.width = `${liquidPct}%`;
                const infoRow = liquidSection.querySelectorAll('span');
                if (infoRow.length >= 2) {
                    infoRow[infoRow.length - 2].textContent = liquidIgnore ? 'üåø Ignoriert' : `~${liquidDays} Tage`;
                    infoRow[infoRow.length - 1].textContent = `${(liquidPct * liquidCap / 100).toFixed(1)} / ${liquidCap} L`;
                }
            }
        }

        function renderQuickActions() {
            const grid = document.getElementById('quickActionsGrid');
            grid.innerHTML = '';
            for (const key of enabledResources) {
                const config = RESOURCE_CONFIG[key];
                
                // TTT: Separate Buttons f√ºr Pipi und Fest
                if (key === 'toilet' && currentVehicle.toilet_type === 'ttt') {
                    grid.innerHTML += `
                        <button class="quick-action-btn" onclick="quickToiletEmpty('solid')">
                            <span class="icon">üí©</span>
                            <span class="label">Fest ‚àÖ</span>
                        </button>
                        <button class="quick-action-btn" onclick="quickToiletEmpty('liquid')">
                            <span class="icon">üíß</span>
                            <span class="label">Pipi ‚àÖ</span>
                        </button>
                    `;
                    continue;
                }
                
                const action = config.inverted ? 'empty' : 'full';
                const label = config.inverted ? 'Geleert' : 'Voll';
                grid.innerHTML += `
                    <button class="quick-action-btn" onclick="quickAction('${key}', '${action}')">
                        <span class="icon">${config.icon}</span>
                        <span class="label">${label}</span>
                    </button>
                `;
            }
        }

        function openResourceModal(type) {
            currentResourceType = type;
            const config = RESOURCE_CONFIG[type];
            document.getElementById('modalTitle').textContent = `${config.icon} ${getResourceName(currentResourceType)}`;
            const pct = currentLevels[`${type}_percentage`] || 0;
            document.getElementById('modalSlider').value = pct;
            document.getElementById('modalSliderValue').textContent = `${Math.round(pct)}%`;
            
            // Verbraucher-Bereich nur bei Power anzeigen
            const consumersSection = document.getElementById('modalConsumersSection');
            if (type === 'power') {
                consumersSection.style.display = 'block';
                loadModalConsumers();
            } else {
                consumersSection.style.display = 'none';
            }
            
            document.getElementById('resourceModal').classList.add('active');
        }
        
        async function loadModalConsumers() {
            if (!currentVehicle) return;
            try {
                const data = await fetchAPI(`/consumers/${currentVehicle.id}`);
                if (data) {
                    consumers = data.consumers || [];
                    renderModalConsumers();
                    updateModalConsumersSummary(data);
                }
            } catch (error) { console.error('Load modal consumers error:', error); }
        }
        
        function renderModalConsumers() {
            const list = document.getElementById('modalConsumersList');
            if (consumers.length === 0) {
                list.innerHTML = '<p style="opacity: 0.7; text-align: center; font-size:13px;">Noch keine Verbraucher angelegt</p>';
                return;
            }
            list.innerHTML = consumers.map(c => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 6px;">
                    <span style="font-size: 20px;">${c.icon || '‚ö°'}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size:14px;">${c.name}</div>
                        <div style="font-size: 11px; opacity: 0.7;">${c.consumption_ah} Ah/Tag</div>
                    </div>
                    <button class="icon-btn" onclick="toggleModalConsumer(${c.id})" style="width:36px;height:36px;opacity: ${c.is_active ? 1 : 0.4};">${c.is_active ? '‚úÖ' : '‚¨ú'}</button>
                    <button class="icon-btn" onclick="deleteModalConsumer(${c.id})" style="width:36px;height:36px;">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        function updateModalConsumersSummary(data) {
            const summary = document.getElementById('modalConsumersSummary');
            const batteryCapacity = currentVehicle.battery_capacity || 100;
            const daysRemaining = data.totalConsumption > 0 ? (batteryCapacity / data.totalConsumption).toFixed(1) : '‚àû';
            summary.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size:13px;">
                    <span>Aktive Verbraucher:</span>
                    <strong>${data.activeCount}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size:13px;">
                    <span>Gesamtverbrauch:</span>
                    <strong>${data.totalConsumption.toFixed(1)} Ah/Tag</strong>
                </div>
                <div style="display: flex; justify-content: space-between; font-size:13px;">
                    <span>Reichweite bei 100%:</span>
                    <strong>${daysRemaining} Tage</strong>
                </div>
            `;
        }
        
        async function addModalConsumer() {
            const name = document.getElementById('modalNewConsumerName').value.trim();
            const ah = parseFloat(document.getElementById('modalNewConsumerAh').value);
            if (!name || !ah) { alert('Bitte Name und Verbrauch eingeben'); return; }
            try {
                await fetchAPI('/consumers', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, name, consumptionAh: ah })
                });
                document.getElementById('modalNewConsumerName').value = '';
                document.getElementById('modalNewConsumerAh').value = '';
                await loadModalConsumers();
            } catch (error) { console.error('Add modal consumer error:', error); }
        }
        
        async function toggleModalConsumer(id) {
            try {
                await fetchAPI(`/consumers/${id}/toggle`, { method: 'PATCH' });
                await loadModalConsumers();
            } catch (error) { console.error('Toggle modal consumer error:', error); }
        }
        
        async function deleteModalConsumer(id) {
            if (!confirm('Verbraucher wirklich l√∂schen?')) return;
            try {
                await fetchAPI(`/consumers/${id}`, { method: 'DELETE' });
                await loadModalConsumers();
            } catch (error) { console.error('Delete modal consumer error:', error); }
        }

        function closeResourceModal() { 
            document.getElementById('resourceModal').classList.remove('active');
            // UI aktualisieren wenn Power Modal geschlossen wird (wegen Verbraucher-√Ñnderungen)
            if (currentResourceType === 'power') {
                updateUI();
            }
        }
        
        // Legal Modal Funktionen
        function openLegalModal(type) {
            const titles = { impressum: 'Impressum', datenschutz: 'Datenschutzerkl√§rung', agb: 'Nutzungsbedingungen (AGB)' };
            const contents = {
                impressum: `<h3>Impressum</h3>
                    <p><strong>Angaben gem√§√ü ¬ß 5 TMG:</strong></p>
                    <p>morepixel<br>Inhaber: Marcel Reichelt<br>Musterstra√üe 1<br>12345 Musterstadt</p>
                    <p><strong>Kontakt:</strong><br>E-Mail: info@morepixel.de</p>
                    <p><strong>Umsatzsteuer-ID:</strong><br>DE123456789</p>`,
                datenschutz: `<h3>Datenschutzerkl√§rung</h3>
                    <p><strong>1. Verantwortlicher</strong><br>morepixel, info@morepixel.de</p>
                    <p><strong>2. Erhobene Daten</strong><br>Wir speichern: E-Mail-Adresse, Passwort (verschl√ºsselt), Fahrzeugdaten, Ressourcen-Logs.</p>
                    <p><strong>3. Zweck der Verarbeitung</strong><br>Bereitstellung der App-Funktionen, Benutzerauthentifizierung.</p>
                    <p><strong>4. Speicherdauer</strong><br>Daten werden gespeichert bis zur L√∂schung des Accounts.</p>
                    <p><strong>5. Rechte</strong><br>Auskunft, Berichtigung, L√∂schung, Widerspruch gem√§√ü DSGVO.</p>`,
                agb: `<h3>Nutzungsbedingungen</h3>
                    <p><strong>1. Geltungsbereich</strong><br>Diese AGB gelten f√ºr die Nutzung der DaysLeft App.</p>
                    <p><strong>2. Leistungen</strong><br>DaysLeft ist ein Ressourcen-Tracker f√ºr Overlander und Camper.</p>
                    <p><strong>3. Haftung</strong><br>Die Nutzung erfolgt auf eigene Gefahr. Keine Gew√§hr f√ºr Richtigkeit der Berechnungen.</p>
                    <p><strong>4. Datenschutz</strong><br>Siehe Datenschutzerkl√§rung.</p>`
            };
            
            // Modal erstellen falls nicht vorhanden
            let modal = document.getElementById('legalModal');
            if (!modal) {
                document.body.insertAdjacentHTML('beforeend', `
                    <div class="modal-overlay" id="legalModal">
                        <div class="modal" style="max-height:90vh;overflow-y:auto;">
                            <div class="modal-header">
                                <span class="modal-title" id="legalModalTitle">Rechtliches</span>
                                <button class="modal-close" onclick="closeLegalModal()">‚úï</button>
                            </div>
                            <div id="legalModalContent" style="font-size:14px;line-height:1.6;"></div>
                            <button class="btn btn-primary" onclick="closeLegalModal()" style="margin-top:20px;">Schlie√üen</button>
                        </div>
                    </div>
                `);
                modal = document.getElementById('legalModal');
            }
            
            document.getElementById('legalModalTitle').textContent = titles[type] || 'Rechtliches';
            document.getElementById('legalModalContent').innerHTML = contents[type] || '<p>Inhalt nicht verf√ºgbar.</p>';
            modal.classList.add('active');
        }
        
        function closeLegalModal() {
            document.getElementById('legalModal')?.classList.remove('active');
        }
        
        function updateSliderValue() { document.getElementById('modalSliderValue').textContent = `${document.getElementById('modalSlider').value}%`; }
        function setLevel(pct) { document.getElementById('modalSlider').value = pct; updateSliderValue(); }

        async function saveResourceLevel() {
            const pct = parseInt(document.getElementById('modalSlider').value);
            const config = RESOURCE_CONFIG[currentResourceType];
            const capacity = currentVehicle[toSnakeCase(config.capacityField)] || 100;
            const amount = (pct / 100) * capacity;
            
            // Bei Wasser: Abwasser-Korrelation pr√ºfen
            let greywaterUpdate = null;
            if (currentResourceType === 'water' && currentVehicle.greywater_linked_to_water) {
                const oldWaterLevel = currentLevels.water_level || 0;
                const waterUsed = oldWaterLevel - amount;
                if (waterUsed > 0) {
                    const factor = (currentVehicle.greywater_link_factor || 90) / 100;
                    const greywaterIncrease = waterUsed * factor;
                    const greywarerCap = currentVehicle.grey_water_capacity || 100;
                    const currentGreywater = currentLevels.greywater_level || 0;
                    greywaterUpdate = Math.min(currentGreywater + greywaterIncrease, greywarerCap);
                }
            }
            
            try {
                const data = await fetchAPI('/resources/log', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, resourceType: currentResourceType, action: 'set_level', amount })
                });
                currentLevels = data.levels;
                
                // Abwasser-Update wenn n√∂tig
                if (greywaterUpdate !== null) {
                    const greyData = await fetchAPI('/resources/log', {
                        method: 'POST',
                        body: JSON.stringify({ vehicleId: currentVehicle.id, resourceType: 'greywater', action: 'set_level', amount: greywaterUpdate })
                    });
                    currentLevels = greyData.levels;
                }
                
                updateUI();
                closeResourceModal();
            } catch (error) { console.error('Save error:', error); }
        }

        async function quickAction(type, action) {
            const scrollY = window.scrollY;
            try {
                const data = await fetchAPI('/resources/log', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, resourceType: type, action, amount: 0 })
                });
                currentLevels = data.levels;
                await updateUI();
                requestAnimationFrame(() => window.scrollTo(0, scrollY));
            } catch (error) { console.error('Quick action error:', error); }
        }
        
        async function quickToiletEmpty(tankType) {
            try {
                await fetchAPI('/resources/toilet-empty', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, tankType })
                });
                const data = await fetchAPI('/resources/current');
                if (data) {
                    currentLevels = data.levels;
                    updateToiletCardOnly();
                }
            } catch (error) { console.error('Toilet empty error:', error); }
        }

        async function saveVehicle(event) {
            event.preventDefault();
            const personCount = parseInt(document.getElementById('setupPersonCount').value) || 2;
            const vehicleData = { name: document.getElementById('setupName').value, enabledResources, isDefault: true, personCount };
            for (const key of enabledResources) {
                const config = RESOURCE_CONFIG[key];
                const capEl = document.getElementById(`setup_${config.capacityField}`);
                if (capEl && capEl.value) vehicleData[config.capacityField] = parseFloat(capEl.value);
                if (config.consumptionField) {
                    const conEl = document.getElementById(`setup_${config.consumptionField}`);
                    if (conEl && conEl.value) vehicleData[config.consumptionField] = parseFloat(conEl.value);
                }
            }
            // Solar-Leistung speichern
            const solarPowerEl = document.getElementById('setup_solarPower');
            if (solarPowerEl?.value) vehicleData.solarPower = parseInt(solarPowerEl.value);
            
            // Greywater-Link-Einstellungen
            const greywaterLinked = document.getElementById('setup_greywaterLinked');
            const greywaterFactor = document.getElementById('setup_greywaterFactor');
            if (greywaterLinked) vehicleData.greywaterLinkedToWater = greywaterLinked.checked;
            if (greywaterFactor) vehicleData.greywaterLinkFactor = parseInt(greywaterFactor.value);
            
            const toiletType = document.getElementById('setup_toiletType');
            if (toiletType) {
                vehicleData.toiletType = toiletType.value;
                if (toiletType.value === 'ttt') {
                    const solid = document.getElementById('setup_tttSolidCapacity');
                    const liquid = document.getElementById('setup_tttLiquidCapacity');
                    const solidIgnore = document.getElementById('setup_tttSolidIgnore');
                    const liquidIgnore = document.getElementById('setup_tttLiquidIgnore');
                    if (solid?.value) vehicleData.tttSolidCapacity = parseInt(solid.value);
                    if (liquid?.value) vehicleData.tttLiquidCapacity = parseInt(liquid.value);
                    vehicleData.tttSolidIgnoreAutarky = solidIgnore?.checked ?? false;
                    vehicleData.tttLiquidIgnoreAutarky = liquidIgnore?.checked ?? false;
                } else if (toiletType.value === 'clesana') {
                    const bags = document.getElementById('setup_clesanaBagsCapacity');
                    if (bags?.value) vehicleData.clesanaBagsCapacity = parseInt(bags.value);
                } else if (toiletType.value === 'chemical') {
                    const tank = document.getElementById('setup_chemicalTankCapacity');
                    if (tank?.value) vehicleData.chemicalTankCapacity = parseInt(tank.value);
                }
            }
            try {
                                let result;
                if (currentVehicle && currentVehicle.id) {
                    result = await fetchAPI(`/vehicles/${currentVehicle.id}`, { method: 'PUT', body: JSON.stringify(vehicleData) });
                } else {
                    result = await fetchAPI('/vehicles', { method: 'POST', body: JSON.stringify(vehicleData) });
                }
                                await init();
            } catch (error) { 
                            }
        }

        function logout() { localStorage.removeItem('token'); window.location.href = 'index.html'; }

        let consumers = [];

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            updateLangButtons();
            updatePremiumUI();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // ========== KARTEN FUNKTIONEN ==========
        let poiMap = null;
        let poiMarkers = [];
        let activePoiFilters = { water: true, fuel: true, power: true, shop: true, dump: true };
        let lastLoadedCenter = null;
        let mapMovedAfterLoad = false;

        function mapDebugLog(msg) {
            const dbg = document.getElementById('mapDebug');
            if (dbg) dbg.innerHTML += msg + '<br>';
        }

        function openMapModal() {
            document.getElementById('mapModal').classList.add('active');
            document.getElementById('mapDebug').innerHTML = '';
            mapDebugLog('Karte wird geladen...');
            
            setTimeout(() => {
                initPoiMap();
            }, 100);
        }

        function closeMapModal() {
            document.getElementById('mapModal').classList.remove('active');
            if (poiMap) {
                poiMap.remove();
                poiMap = null;
            }
        }

        function initPoiMap() {
            const container = document.getElementById('mapContainer');
            if (!container) {
                mapDebugLog('ERROR: mapContainer nicht gefunden');
                return;
            }

            if (poiMap) {
                poiMap.remove();
                poiMap = null;
            }

            // Standard-Position (Deutschland Mitte) falls kein GPS
            let lat = 51.1657;
            let lng = 10.4515;

            poiMap = L.map('mapContainer').setView([lat, lng], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(poiMap);

            // Event-Listener f√ºr Kartenbewegung
            poiMap.on('moveend', onMapMoved);
            poiMap.on('zoomend', onMapMoved);

            mapDebugLog('Karte initialisiert. Hole GPS-Position...');

            // GPS-Position holen
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        lat = pos.coords.latitude;
                        lng = pos.coords.longitude;
                        mapDebugLog(`GPS: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                        poiMap.setView([lat, lng], 13);
                        
                        // Eigene Position markieren
                        L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'my-location-marker',
                                html: '<div style="background:#4CAF50;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                                iconSize: [16, 16],
                                iconAnchor: [8, 8]
                            })
                        }).addTo(poiMap).bindPopup('üìç Dein Standort');

                        loadPOIs(lat, lng);
                    },
                    (err) => {
                        mapDebugLog('GPS Fehler: ' + err.message + ' - Lade POIs f√ºr Deutschland...');
                        loadPOIs(lat, lng);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                mapDebugLog('GPS nicht verf√ºgbar');
                loadPOIs(lat, lng);
            }
        }

        const poiColors = {
            water: '#3498db',
            fuel: '#e74c3c', 
            power: '#f39c12',
            shop: '#27ae60',
            dump: '#1abc9c'
        };

        let poiCounts = { water: 0, fuel: 0, power: 0, shop: 0, dump: 0 };

        function showMapLoading(show, text = 'Lade POIs...', progress = 0) {
            const el = document.getElementById('mapLoading');
            const textEl = document.getElementById('mapLoadingText');
            const barEl = document.getElementById('mapLoadingBar');
            if (el) el.style.display = show ? 'flex' : 'none';
            if (textEl) textEl.textContent = text;
            if (barEl) barEl.style.width = progress + '%';
        }

        async function loadPOIs(lat, lng) {
            showMapLoading(true, 'üìç Suche POIs in der N√§he...', 10);
            mapDebugLog(`Lade POIs f√ºr ${lat.toFixed(4)}, ${lng.toFixed(4)}...`);
            
            const radius = 5000; // 5km Radius
            
            // Nur Camper-relevante POIs
            const query = `[out:json][timeout:30];(node["amenity"="drinking_water"](around:${radius},${lat},${lng});node["amenity"="water_point"](around:${radius},${lat},${lng});node["amenity"="fuel"](around:${radius},${lat},${lng});node["tourism"="camp_site"](around:${radius},${lat},${lng});node["tourism"="caravan_site"](around:${radius},${lat},${lng});way["tourism"="camp_site"](around:${radius},${lat},${lng});way["tourism"="caravan_site"](around:${radius},${lat},${lng});node["shop"="supermarket"](around:${radius},${lat},${lng});node["shop"="convenience"](around:${radius},${lat},${lng});node["amenity"="sanitary_dump_station"](around:${radius},${lat},${lng}););out center;`;

            try {
                showMapLoading(true, 'üåê Verbinde mit OpenStreetMap...', 30);
                mapDebugLog('Sende Anfrage an Overpass API...');
                
                // Verwende GET mit URL-Parameter (zuverl√§ssiger)
                const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
                const response = await fetch(url);

                mapDebugLog(`Response Status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    mapDebugLog(`Error Body: ${errorText.substring(0, 100)}`);
                    throw new Error('API Fehler: ' + response.status);
                }

                showMapLoading(true, 'üì° Empfange Daten...', 60);
                const data = await response.json();
                mapDebugLog(`${data.elements.length} POIs geladen`);

                showMapLoading(true, `üìç ${data.elements.length} POIs gefunden...`, 80);
                
                // Marker l√∂schen & Z√§hler zur√ºcksetzen
                poiMarkers.forEach(m => poiMap.removeLayer(m));
                poiMarkers = [];
                poiCounts = { water: 0, fuel: 0, power: 0, shop: 0, dump: 0 };

                data.elements.forEach(el => {
                    const poiInfo = categorizePOI(el);
                    if (!poiInfo) return;

                    // Koordinaten: node hat lat/lon direkt, way hat center
                    const lat = el.lat || (el.center && el.center.lat);
                    const lon = el.lon || (el.center && el.center.lon);
                    if (!lat || !lon) return;

                    poiCounts[poiInfo.category]++;

                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'poi-marker-wrapper',
                            html: `<div class="poi-marker-icon" style="background:${poiColors[poiInfo.category]};">${poiInfo.icon}</div>`,
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        })
                    });

                    marker.poiCategory = poiInfo.category;
                    
                    const popupContent = `
                        <div style="font-size:13px;min-width:150px;">
                            <div style="font-weight:600;margin-bottom:4px;">${poiInfo.icon} ${el.tags.name || poiInfo.name}</div>
                            ${el.tags.opening_hours ? `<div style="font-size:11px;color:#666;">üïê ${el.tags.opening_hours}</div>` : ''}
                            ${el.tags.brand ? `<div style="font-size:11px;color:#666;">${el.tags.brand}</div>` : ''}
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    
                    if (activePoiFilters[poiInfo.category]) {
                        marker.addTo(poiMap);
                    }
                    poiMarkers.push(marker);
                });

                updatePoiCounts();
                updatePoiVisibility();
                
                showMapLoading(false);
                
                // Speichere aktuelle Position
                lastLoadedCenter = poiMap.getCenter();
                mapMovedAfterLoad = false;
                document.getElementById('mapReloadBtn').style.display = 'none';

            } catch (err) {
                mapDebugLog('ERROR: ' + err.message);
                showMapLoading(true, '‚ùå Fehler beim Laden', 0);
                setTimeout(() => showMapLoading(false), 2000);
            }
        }

        function onMapMoved() {
            if (!poiMap || !lastLoadedCenter) return;
            
            const center = poiMap.getCenter();
            const distance = lastLoadedCenter.distanceTo(center);
            
            // Zeige Button wenn mehr als 500m bewegt oder deutlich gezoomt
            if (distance > 500) {
                mapMovedAfterLoad = true;
                document.getElementById('mapReloadBtn').style.display = 'block';
            }
        }

        function reloadPOIsAtCenter() {
            if (!poiMap) return;
            const center = poiMap.getCenter();
            document.getElementById('mapReloadBtn').style.display = 'none';
            loadPOIs(center.lat, center.lng);
        }

        function updatePoiCounts() {
            Object.keys(poiCounts).forEach(cat => {
                const el = document.getElementById('count-' + cat);
                if (el) el.textContent = poiCounts[cat];
            });
        }

        function categorizePOI(el) {
            const tags = el.tags || {};
            
            if (tags.amenity === 'drinking_water' || tags.amenity === 'water_point') {
                return { category: 'water', icon: 'üíß', name: 'Wasser' };
            }
            if (tags.amenity === 'fuel') {
                return { category: 'fuel', icon: '‚õΩ', name: 'Tankstelle' };
            }
            if (tags.tourism === 'camp_site') {
                return { category: 'power', icon: '‚õ∫', name: 'Campingplatz' };
            }
            if (tags.tourism === 'caravan_site') {
                return { category: 'power', icon: 'üöê', name: 'Stellplatz' };
            }
            if (tags.shop === 'supermarket' || tags.shop === 'convenience') {
                return { category: 'shop', icon: 'üõí', name: 'Einkaufen' };
            }
            if (tags.amenity === 'sanitary_dump_station') {
                return { category: 'dump', icon: 'üöø', name: 'Entsorgung' };
            }
            if (tags.waterway === 'water_point') {
                return { category: 'water', icon: 'üíß', name: 'Wasserstelle' };
            }
            return null;
        }

        function togglePoiFilter(category) {
            activePoiFilters[category] = !activePoiFilters[category];
            
            const btn = document.querySelector(`.poi-pill[data-poi="${category}"]`);
            if (btn) {
                btn.classList.toggle('active', activePoiFilters[category]);
            }
            
            updatePoiVisibility();
        }

        function updatePoiVisibility() {
            poiMarkers.forEach(marker => {
                if (activePoiFilters[marker.poiCategory]) {
                    if (!poiMap.hasLayer(marker)) marker.addTo(poiMap);
                } else {
                    if (poiMap.hasLayer(marker)) poiMap.removeLayer(marker);
                }
            });
        }
        // ========== ENDE KARTEN FUNKTIONEN ==========

        function updateLangButtons() {
            const deBtn = document.getElementById('langDe');
            const enBtn = document.getElementById('langEn');
            if (deBtn) deBtn.className = currentLang === 'de' ? 'btn btn-primary' : 'btn btn-secondary';
            if (enBtn) enBtn.className = currentLang === 'en' ? 'btn btn-primary' : 'btn btn-secondary';
        }

        async function openConsumersModal() {
            document.getElementById('consumersModal').classList.add('active');
            await loadConsumers();
        }

        function closeConsumersModal() {
            document.getElementById('consumersModal').classList.remove('active');
        }

        async function loadConsumers() {
            if (!currentVehicle) return;
            try {
                const data = await fetchAPI(`/consumers/${currentVehicle.id}`);
                if (data) {
                    consumers = data.consumers || [];
                    renderConsumers();
                    updateConsumersSummary(data);
                }
            } catch (error) { console.error('Load consumers error:', error); }
        }

        function renderConsumers() {
            const list = document.getElementById('consumersList');
            if (consumers.length === 0) {
                list.innerHTML = '<p style="opacity: 0.7; text-align: center;">Noch keine Verbraucher angelegt</p>';
                return;
            }
            list.innerHTML = consumers.map(c => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px;">
                    <span style="font-size: 24px;">${c.icon || '‚ö°'}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${c.name}</div>
                        <div style="font-size: 12px; opacity: 0.7;">${c.consumption_ah} Ah/Tag</div>
                    </div>
                    <button class="icon-btn" onclick="toggleConsumer(${c.id})" style="opacity: ${c.is_active ? 1 : 0.4};">${c.is_active ? '‚úÖ' : '‚¨ú'}</button>
                    <button class="icon-btn" onclick="deleteConsumer(${c.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateConsumersSummary(data) {
            const summary = document.getElementById('consumersSummary');
            const batteryCapacity = currentVehicle.battery_capacity || 100;
            const daysRemaining = data.totalConsumption > 0 ? (batteryCapacity / data.totalConsumption).toFixed(1) : '‚àû';
            summary.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Aktive Verbraucher:</span>
                    <strong>${data.activeCount}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Gesamtverbrauch:</span>
                    <strong>${data.totalConsumption.toFixed(1)} Ah/Tag</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Reichweite bei 100%:</span>
                    <strong>${daysRemaining} Tage</strong>
                </div>
            `;
        }

        async function addConsumer() {
            const name = document.getElementById('newConsumerName').value.trim();
            const ah = parseFloat(document.getElementById('newConsumerAh').value);
            if (!name || !ah) { alert('Bitte Name und Verbrauch eingeben'); return; }
            try {
                await fetchAPI('/consumers', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, name, consumptionAh: ah })
                });
                document.getElementById('newConsumerName').value = '';
                document.getElementById('newConsumerAh').value = '';
                await loadConsumers();
            } catch (error) { console.error('Add consumer error:', error); }
        }

        async function toggleConsumer(id) {
            try {
                await fetchAPI(`/consumers/${id}/toggle`, { method: 'PATCH' });
                await loadConsumers();
            } catch (error) { console.error('Toggle consumer error:', error); }
        }

        async function deleteConsumer(id) {
            if (!confirm('Verbraucher wirklich l√∂schen?')) return;
            try {
                await fetchAPI(`/consumers/${id}`, { method: 'DELETE' });
                await loadConsumers();
            } catch (error) { console.error('Delete consumer error:', error); }
        }

        // ========== SOLAR & STANDORT FUNKTIONEN ==========
        let userLocation = JSON.parse(localStorage.getItem('userLocation') || 'null');
        let weatherData = null;

        function openLocationModal() {
            const modal = document.getElementById('locationModal');
            const statusEl = document.getElementById('locationModalStatus');
            if (modal) modal.classList.add('active');
            if (statusEl) statusEl.style.display = 'none';
        }

        function closeLocationModal() {
            const modal = document.getElementById('locationModal');
            if (modal) modal.classList.remove('active');
        }

        async function confirmLocationRequest() {
            const statusEl = document.getElementById('locationModalStatus');
            if (!navigator.geolocation) {
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.innerHTML = '‚ùå Geolocation wird nicht unterst√ºtzt';
                }
                return;
            }
            if (statusEl) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = '‚è≥ Standort wird ermittelt...';
            }
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    localStorage.setItem('userLocation', JSON.stringify(userLocation));
                    if (statusEl) {
                        statusEl.innerHTML = '‚úÖ Standort gespeichert! Lade Wetterdaten...';
                    }
                    updateLocationDisplay();
                    await fetchWeatherAndSolar();
                    closeLocationModal();
                },
                (err) => {
                    if (statusEl) {
                        statusEl.style.display = 'block';
                        statusEl.innerHTML = '‚ùå Standort-Zugriff verweigert. Bitte erlaube den Zugriff in deinen Ger√§teeinstellungen.';
                    }
                },
                { enableHighAccuracy: false, timeout: 15000 }
            );
        }

        function loadSolarData() {
            const solarInput = document.getElementById('setup_solarPower');
            if (solarInput && currentVehicle?.solar_power) {
                solarInput.value = currentVehicle.solar_power;
            }
            if (userLocation) {
                updateLocationDisplay();
                fetchWeatherAndSolar();
            }
        }

        async function requestLocation() {
            const btn = document.getElementById('locationBtn');
            const info = document.getElementById('locationInfo');
            if (!navigator.geolocation) {
                if (info) info.textContent = 'Geolocation nicht unterst√ºtzt';
                return;
            }
            if (btn) btn.textContent = '‚è≥ Suche...';
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    localStorage.setItem('userLocation', JSON.stringify(userLocation));
                    updateLocationDisplay();
                    await fetchWeatherAndSolar();
                },
                (err) => {
                    if (info) info.textContent = 'Standort-Zugriff verweigert';
                    if (btn) btn.textContent = 'üìç Standort';
                },
                { enableHighAccuracy: false, timeout: 10000 }
            );
        }
        
        // Automatische Standortabfrage im Hintergrund (f√ºr neue Accounts)
        function autoRequestLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    localStorage.setItem('userLocation', JSON.stringify(userLocation));
                    await fetchWeatherAndSolar();
                    updateUI(); // UI aktualisieren um Wetter anzuzeigen
                },
                () => { /* Still fehlschlagen */ },
                { enableHighAccuracy: false, timeout: 10000 }
            );
        }

        async function updateLocationDisplay() {
            const btn = document.getElementById('locationBtn');
            const nameEl = document.getElementById('locationName');
            const coordsEl = document.getElementById('locationCoords');
            
            if (btn) btn.textContent = '‚úÖ Aktiv';
            if (coordsEl && userLocation) {
                coordsEl.textContent = `${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
            }
            
            // Reverse Geocoding f√ºr Ortsnamen
            if (nameEl && userLocation) {
                nameEl.textContent = 'Lade Ort...';
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userLocation.lat}&lon=${userLocation.lon}&format=json&zoom=10`);
                    const data = await res.json();
                    const city = data.address?.city || data.address?.town || data.address?.village || data.address?.municipality || '';
                    const state = data.address?.state || '';
                    const country = data.address?.country || '';
                    nameEl.textContent = city ? `${city}, ${state || country}` : (state || country || 'Unbekannter Ort');
                } catch (e) {
                    nameEl.textContent = 'Standort geladen';
                }
            }
        }

        async function fetchWeatherAndSolar() {
            if (!userLocation) return;
            const forecastEl = document.getElementById('solarForecast');
            const yieldEl = document.getElementById('setup_solarYield');
            
            try {
                // Open-Meteo API f√ºr Wetter und Sonnenstrahlung (kostenlos, kein API-Key n√∂tig)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLocation.lat}&longitude=${userLocation.lon}&current=temperature_2m,weathercode&daily=sunshine_duration,shortwave_radiation_sum,weathercode&timezone=auto&forecast_days=3`;
                const res = await fetch(url);
                const data = await res.json();
                weatherData = data;
                
                // Aktuelles Wetter in Fahrzeug-Kachel anzeigen
                const weatherIcons = {
                    0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
                    45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                    51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è',
                    61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
                    71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
                    80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',
                    95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
                };
                if (data.current) {
                    const weatherEl = document.getElementById('vehicleWeather');
                    const iconEl = document.getElementById('vehicleWeatherIcon');
                    const tempEl = document.getElementById('vehicleWeatherTemp');
                    const currentIcon = weatherIcons[data.current.weathercode] || 'üå§Ô∏è';
                    const currentTemp = Math.round(data.current.temperature_2m);
                    if (weatherEl) weatherEl.style.display = 'flex';
                    if (iconEl) iconEl.textContent = currentIcon;
                    if (tempEl) tempEl.textContent = `${currentTemp}¬∞`;
                }
                
                // Solarertrag berechnen
                const solarWp = parseFloat(document.getElementById('setup_solarPower')?.value) || currentVehicle?.solar_power || 0;
                if (solarWp > 0 && data.daily) {
                    const today = data.daily;
                    const sunshineHours = (today.sunshine_duration?.[0] || 0) / 3600; // Sekunden -> Stunden
                    const radiation = today.shortwave_radiation_sum?.[0] || 0; // kWh/m¬≤
                    
                    // Einfache Sch√§tzung: Wp * Sonnenstunden * Effizienzfaktor (0.7) / 12V = Ah
                    // Alternativ: Basierend auf Strahlungssumme
                    const efficiency = 0.7; // Panel-Effizienz, Verluste
                    const voltage = 12; // Systemspannung
                    const estimatedAh = (solarWp * sunshineHours * efficiency * 0.15) / voltage;
                    
                    if (yieldEl) yieldEl.value = estimatedAh.toFixed(1);
                    
                    if (forecastEl) {
                        forecastEl.style.display = 'block';
                        forecastEl.innerHTML = `
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;">
                                <div style="font-weight:600;margin-bottom:8px;">‚òÄÔ∏è Solar-Prognose</div>
                                <div style="display:flex;gap:8px;">
                                    ${today.time.slice(0, 3).map((date, i) => {
                                        const code = today.weathercode?.[i] || 0;
                                        const icon = weatherIcons[code] || 'üå§Ô∏è';
                                        const sun = ((today.sunshine_duration?.[i] || 0) / 3600).toFixed(1);
                                        const dayAh = (solarWp * parseFloat(sun) * efficiency * 0.15) / voltage;
                                        return `
                                            <div style="flex:1;text-align:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px;">
                                                <div style="font-size:11px;opacity:0.7;">${new Date(date).toLocaleDateString('de', {weekday:'short'})}</div>
                                                <div style="font-size:24px;">${icon}</div>
                                                <div style="font-size:12px;">${sun}h ‚òÄÔ∏è</div>
                                                <div style="font-size:13px;font-weight:600;color:#f39c12;">~${dayAh.toFixed(0)} Ah</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div style="font-size:11px;opacity:0.6;margin-top:8px;text-align:center;">
                                    Basierend auf ${solarWp}Wp Solar-Anlage
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Weather fetch error:', e);
                if (forecastEl) forecastEl.innerHTML = '<div style="opacity:0.5;">Wetterdaten nicht verf√ºgbar</div>';
            }
        }

        // Solar-Input onChange -> Neu berechnen
        document.addEventListener('input', (e) => {
            if (e.target.id === 'setup_solarPower' && userLocation) {
                fetchWeatherAndSolar();
            }
        });

        let setupConsumers = [];

        async function loadSetupConsumers() {
            if (!currentVehicle) return;
            try {
                const data = await fetchAPI(`/consumers/${currentVehicle.id}`);
                if (data) {
                    setupConsumers = data.consumers || [];
                    renderSetupConsumers();
                }
            } catch (error) { console.error('Load setup consumers error:', error); }
        }

        function renderSetupConsumers() {
            const list = document.getElementById('setupConsumersList');
            const totalEl = document.getElementById('setupConsumersTotal');
            const consumptionInput = document.getElementById('setup_powerConsumptionPerDay');
            const summaryEl = document.getElementById('setupConsumersSummary');
            if (!list) return;
            if (!Array.isArray(setupConsumers)) setupConsumers = [];
            
            const activeCount = setupConsumers.filter(c => c.is_active).length;
            const total = setupConsumers.filter(c => c.is_active).reduce((sum, c) => sum + parseFloat(c.consumption_ah || 0), 0);
            const batteryCapacity = parseFloat(document.getElementById('setup_batteryCapacity')?.value) || (currentVehicle?.battery_capacity) || 100;
            const daysRemaining = total > 0 ? (batteryCapacity / total).toFixed(1) : '‚àû';
            
            if (totalEl) totalEl.textContent = `${total.toFixed(1)} Ah/Tag`;
            if (consumptionInput) consumptionInput.value = total.toFixed(2);
            
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span>Aktive Verbraucher:</span>
                        <strong>${activeCount}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span>Gesamtverbrauch:</span>
                        <strong>${total.toFixed(1)} Ah/Tag</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span>Reichweite bei 100%:</span>
                        <strong>${daysRemaining} Tage</strong>
                    </div>
                `;
            }
            
            if (setupConsumers.length === 0) {
                list.innerHTML = '<p style="opacity: 0.5; text-align: center; font-size: 12px; margin: 8px 0;">Keine Verbraucher</p>';
                return;
            }
            list.innerHTML = setupConsumers.map(c => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 4px; font-size: 13px;">
                    <button class="icon-btn" onclick="toggleSetupConsumer(${c.id})" style="font-size:12px;padding:2px;">${c.is_active ? '‚úÖ' : '‚¨ú'}</button>
                    <span style="flex: 1;">${c.name}</span>
                    <span style="opacity: 0.7;">${c.consumption_ah} Ah</span>
                    <button class="icon-btn" onclick="deleteSetupConsumer(${c.id})" style="font-size:12px;padding:2px;">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function addSetupConsumer() {
            const name = document.getElementById('setupNewConsumerName').value.trim();
            const ah = parseFloat(document.getElementById('setupNewConsumerAh').value);
            if (!name || !ah) { alert('Bitte Name und Verbrauch eingeben'); return; }
            try {
                await fetchAPI('/consumers', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, name, consumptionAh: ah })
                });
                document.getElementById('setupNewConsumerName').value = '';
                document.getElementById('setupNewConsumerAh').value = '';
                await loadSetupConsumers();
            } catch (error) { console.error('Add setup consumer error:', error); }
        }

        async function toggleSetupConsumer(id) {
            try {
                await fetchAPI(`/consumers/${id}/toggle`, { method: 'PATCH' });
                await loadSetupConsumers();
            } catch (error) { console.error('Toggle setup consumer error:', error); }
        }

        async function deleteSetupConsumer(id) {
            if (!confirm('Verbraucher l√∂schen?')) return;
            try {
                await fetchAPI(`/consumers/${id}`, { method: 'DELETE' });
                await loadSetupConsumers();
            } catch (error) { console.error('Delete setup consumer error:', error); }
        }

        let customResources = [];

        async function openCustomResourcesModal() {
            document.getElementById('customResourcesModal').classList.add('active');
            await loadCustomResources();
        }

        function closeCustomResourcesModal() {
            document.getElementById('customResourcesModal').classList.remove('active');
        }

        async function loadCustomResources() {
            if (!currentVehicle) return;
            try {
                customResources = await fetchAPI(`/custom-resources/${currentVehicle.id}`);
                renderCustomResources();
            } catch (error) { console.error('Load custom resources error:', error); }
        }

        function switchCustomResTab(tab) {
            const tabExisting = document.getElementById('tabExisting');
            const tabNew = document.getElementById('tabNew');
            const contentExisting = document.getElementById('customResTabExisting');
            const contentNew = document.getElementById('customResTabNew');
            
            if (tab === 'existing') {
                tabExisting.style.borderBottom = '2px solid #4CAF50';
                tabExisting.style.opacity = '1';
                tabNew.style.borderBottom = 'none';
                tabNew.style.opacity = '0.6';
                contentExisting.style.display = 'block';
                contentNew.style.display = 'none';
            } else {
                tabNew.style.borderBottom = '2px solid #4CAF50';
                tabNew.style.opacity = '1';
                tabExisting.style.borderBottom = 'none';
                tabExisting.style.opacity = '0.6';
                contentExisting.style.display = 'none';
                contentNew.style.display = 'block';
            }
        }

        function renderCustomResources() {
            const list = document.getElementById('customResourcesList');
            if (!customResources || customResources.length === 0) {
                list.innerHTML = '<p style="opacity: 0.7; text-align: center;">Noch keine eigenen Ressourcen angelegt</p>';
                return;
            }
            list.innerHTML = customResources.map(r => {
                const pct = r.current_percentage || 0;
                const color = r.is_inverted ? (pct > 75 ? '#ff7b7b' : pct > 50 ? '#f39c12' : '#27ae60') : (pct < 25 ? '#ff7b7b' : pct < 50 ? '#f39c12' : '#27ae60');
                const modalPersonCount = currentVehicle.person_count || 2;
                const modalTotalConsumption = r.consumption_per_day ? r.consumption_per_day * modalPersonCount : null;
                const daysRemaining = modalTotalConsumption ? (r.current_level / modalTotalConsumption).toFixed(1) : null;
                return `
                <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span style="font-size: 24px;">${r.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${r.name}</div>
                            <div style="font-size: 12px; opacity: 0.7;">${r.current_level || 0} / ${r.capacity} ${r.unit}${daysRemaining ? ` ‚Ä¢ ${daysRemaining} Tage` : ''}</div>
                        </div>
                        <button class="icon-btn" onclick="editCustomResource(${r.id})" style="font-size:16px;">‚úèÔ∏è</button>
                        <button class="icon-btn" onclick="deleteCustomResource(${r.id})">üóëÔ∏è</button>
                    </div>
                    <div class="custom-res-slider" style="position: relative; height: 24px;">
                        <div style="position: absolute; top: 8px; left: 0; right: 0; background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                            <div style="background: ${color}; height: 100%; width: ${pct}%; transition: width 0.3s;"></div>
                        </div>
                        <input type="range" min="0" max="${r.capacity}" step="0.1" value="${r.current_level || 0}" 
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 24px; -webkit-appearance: none; background: transparent; cursor: pointer;" 
                            oninput="this.parentElement.querySelector('div > div').style.width = (this.value / ${r.capacity} * 100) + '%'" 
                            onchange="updateCustomResourceLevel(${r.id}, this.value)">
                    </div>
                </div>
            `}).join('');
        }

        async function addCustomResource() {
            const icon = document.getElementById('newCustomIcon').value || 'üì¶';
            const name = document.getElementById('newCustomName').value.trim();
            const unit = document.getElementById('newCustomUnit').value || 'St√ºck';
            const capacity = parseFloat(document.getElementById('newCustomCapacity').value);
            const consumption = parseFloat(document.getElementById('newCustomConsumption').value) || null;
            const isInverted = document.getElementById('newCustomInverted').checked;
            
            if (!name || !capacity) { alert('Bitte Name und Kapazit√§t eingeben'); return; }
            
            try {
                await fetchAPI('/custom-resources', {
                    method: 'POST',
                    body: JSON.stringify({ vehicleId: currentVehicle.id, name, icon, unit, capacity, consumptionPerDay: consumption, isInverted })
                });
                document.getElementById('newCustomName').value = '';
                document.getElementById('newCustomCapacity').value = '';
                document.getElementById('newCustomConsumption').value = '';
                document.getElementById('newCustomInverted').checked = false;
                await loadCustomResources();
                await init();
            } catch (error) { console.error('Add custom resource error:', error); }
        }

        async function updateCustomResourceLevel(id, level) {
            try {
                await fetchAPI(`/custom-resources/${id}/level`, {
                    method: 'PUT',
                    body: JSON.stringify({ level: parseFloat(level) })
                });
                await loadCustomResources();
                await init();
            } catch (error) { console.error('Update custom resource level error:', error); }
        }

        function editCustomResource(id) {
            const resource = customResources.find(r => r.id === id);
            if (!resource) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'editCustomResourceModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <span class="modal-title">‚úèÔ∏è ${resource.name} bearbeiten</span>
                        <button class="modal-close" onclick="document.getElementById('editCustomResourceModal').remove()">‚úï</button>
                    </div>
                    <div class="input-row">
                        <div class="form-group" style="flex: 0.5;">
                            <label>Icon</label>
                            <select class="form-input" id="editCustomIcon" style="font-size:18px;">
                                <option value="üì¶" ${resource.icon === 'üì¶' ? 'selected' : ''}>üì¶</option>
                                <option value="üêï" ${resource.icon === 'üêï' ? 'selected' : ''}>üêï</option>
                                <option value="üêà" ${resource.icon === 'üêà' ? 'selected' : ''}>üêà</option>
                                <option value="üß¥" ${resource.icon === 'üß¥' ? 'selected' : ''}>üß¥</option>
                                <option value="üíä" ${resource.icon === 'üíä' ? 'selected' : ''}>üíä</option>
                                <option value="üßª" ${resource.icon === 'üßª' ? 'selected' : ''}>üßª</option>
                                <option value="üßπ" ${resource.icon === 'üßπ' ? 'selected' : ''}>üßπ</option>
                                <option value="üîã" ${resource.icon === 'üîã' ? 'selected' : ''}>üîã</option>
                                <option value="‚õΩ" ${resource.icon === '‚õΩ' ? 'selected' : ''}>‚õΩ</option>
                                <option value="ü™µ" ${resource.icon === 'ü™µ' ? 'selected' : ''}>ü™µ</option>
                                <option value="üßä" ${resource.icon === 'üßä' ? 'selected' : ''}>üßä</option>
                                <option value="‚òï" ${resource.icon === '‚òï' ? 'selected' : ''}>‚òï</option>
                                <option value="üç∫" ${resource.icon === 'üç∫' ? 'selected' : ''}>üç∫</option>
                                <option value="ü•õ" ${resource.icon === 'ü•õ' ? 'selected' : ''}>ü•õ</option>
                                <option value="ü•ö" ${resource.icon === 'ü•ö' ? 'selected' : ''}>ü•ö</option>
                                <option value="üçû" ${resource.icon === 'üçû' ? 'selected' : ''}>üçû</option>
                                <option value="ü•©" ${resource.icon === 'ü•©' ? 'selected' : ''}>ü•©</option>
                                <option value="üßÄ" ${resource.icon === 'üßÄ' ? 'selected' : ''}>üßÄ</option>
                                <option value="üóëÔ∏è" ${resource.icon === 'üóëÔ∏è' ? 'selected' : ''}>üóëÔ∏è</option>
                                <option value="üéí" ${resource.icon === 'üéí' ? 'selected' : ''}>üéí</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label>Name</label>
                            <input type="text" class="form-input" id="editCustomName" value="${resource.name}">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Einheit</label>
                            <input type="text" class="form-input" id="editCustomUnit" value="${resource.unit || 'St√ºck'}">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Kapazit√§t</label>
                            <input type="number" class="form-input" id="editCustomCapacity" value="${resource.capacity}" step="0.1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>pro Person/Tag</label>
                            <input type="number" class="form-input" id="editCustomConsumption" value="${resource.consumption_per_day || ''}" step="0.1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="editCustomInverted" ${resource.is_inverted ? 'checked' : ''}> Invertiert
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveCustomResource(${id})">Speichern</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveCustomResource(id) {
            const icon = document.getElementById('editCustomIcon').value;
            const name = document.getElementById('editCustomName').value.trim();
            const unit = document.getElementById('editCustomUnit').value;
            const capacity = parseFloat(document.getElementById('editCustomCapacity').value);
            const consumption = parseFloat(document.getElementById('editCustomConsumption').value) || null;
            const isInverted = document.getElementById('editCustomInverted').checked;
            
            const resource = customResources.find(r => r.id === id);
            const currentLevel = Math.min(resource.current_level || 0, capacity);
            
            if (!name || !capacity) { alert('Bitte Name und Kapazit√§t eingeben'); return; }
            
            try {
                await fetchAPI(`/custom-resources/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ name, icon, unit, capacity, consumptionPerDay: consumption, currentLevel, isInverted })
                });
                document.getElementById('editCustomResourceModal').remove();
                await loadCustomResources();
                await init();
            } catch (error) { console.error('Save custom resource error:', error); }
        }

        async function deleteCustomResource(id) {
            if (!confirm('Ressource wirklich l√∂schen?')) return;
            try {
                await fetchAPI(`/custom-resources/${id}`, { method: 'DELETE' });
                await loadCustomResources();
                await init();
            } catch (error) { console.error('Delete custom resource error:', error); }
        }

        init();
    </script>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="bottomNav">
        <button class="bottom-nav-item" onclick="openActivityLogModal()" title="Info">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></span>
            <span class="nav-label">Info</span>
        </button>
        <button class="bottom-nav-item" onclick="openMapModal()" title="Karte">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></span>
            <span class="nav-label">Karte</span>
        </button>
        <button class="bottom-nav-item nav-home" onclick="showDashboard()" title="Dashboard">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span>
            <span class="nav-label">Home</span>
        </button>
        <button class="bottom-nav-item" onclick="showSetup()" title="Setup">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></span>
            <span class="nav-label">Setup</span>
        </button>
        <button class="bottom-nav-item" onclick="openSettingsModal()" title="Mehr">
            <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></span>
            <span class="nav-label">Mehr</span>
        </button>
    </nav>
</body>
</html>
